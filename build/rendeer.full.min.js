/**
 * @fileoverview gl-matrix - High performance matrix and vector operations
 * @author Brandon Jones
 * @author Colin MacKenzie IV
 * @version 2.2.1
 */
/* Copyright (c) 2013, Brandon Jones, Colin MacKenzie IV. All rights reserved.

Redistribution and use in source and binary forms, with or without modification,
are permitted provided that the following conditions are met:

  * Redistributions of source code must retain the above copyright notice, this
    list of conditions and the following disclaimer.
  * Redistributions in binary form must reproduce the above copyright notice,
    this list of conditions and the following disclaimer in the documentation
    and/or other materials provided with the distribution.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR
ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
(INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE. */
(function(e){"use strict";var t={};typeof exports=="undefined"?typeof define=="function"&&typeof define.amd=="object"&&define.amd?(t.exports={},define(function(){return t.exports})):t.exports=typeof window!="undefined"?window:e:t.exports=exports,function(e){if(!t)var t=1e-6;if(!n)var n=typeof Float32Array!="undefined"?Float32Array:Array;if(!r)var r=Math.random;var i={};i.setMatrixArrayType=function(e){n=e},typeof e!="undefined"&&(e.glMatrix=i);var s=Math.PI/180;i.toRadian=function(e){return e*s};var o={};o.create=function(){var e=new n(2);return e[0]=0,e[1]=0,e},o.clone=function(e){var t=new n(2);return t[0]=e[0],t[1]=e[1],t},o.fromValues=function(e,t){var r=new n(2);return r[0]=e,r[1]=t,r},o.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e},o.set=function(e,t,n){return e[0]=t,e[1]=n,e},o.add=function(e,t,n){return e[0]=t[0]+n[0],e[1]=t[1]+n[1],e},o.subtract=function(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e},o.sub=o.subtract,o.multiply=function(e,t,n){return e[0]=t[0]*n[0],e[1]=t[1]*n[1],e},o.mul=o.multiply,o.divide=function(e,t,n){return e[0]=t[0]/n[0],e[1]=t[1]/n[1],e},o.div=o.divide,o.min=function(e,t,n){return e[0]=Math.min(t[0],n[0]),e[1]=Math.min(t[1],n[1]),e},o.max=function(e,t,n){return e[0]=Math.max(t[0],n[0]),e[1]=Math.max(t[1],n[1]),e},o.scale=function(e,t,n){return e[0]=t[0]*n,e[1]=t[1]*n,e},o.scaleAndAdd=function(e,t,n,r){return e[0]=t[0]+n[0]*r,e[1]=t[1]+n[1]*r,e},o.distance=function(e,t){var n=t[0]-e[0],r=t[1]-e[1];return Math.sqrt(n*n+r*r)},o.dist=o.distance,o.squaredDistance=function(e,t){var n=t[0]-e[0],r=t[1]-e[1];return n*n+r*r},o.sqrDist=o.squaredDistance,o.length=function(e){var t=e[0],n=e[1];return Math.sqrt(t*t+n*n)},o.len=o.length,o.squaredLength=function(e){var t=e[0],n=e[1];return t*t+n*n},o.sqrLen=o.squaredLength,o.negate=function(e,t){return e[0]=-t[0],e[1]=-t[1],e},o.normalize=function(e,t){var n=t[0],r=t[1],i=n*n+r*r;return i>0&&(i=1/Math.sqrt(i),e[0]=t[0]*i,e[1]=t[1]*i),e},o.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]},o.cross=function(e,t,n){var r=t[0]*n[1]-t[1]*n[0];return e[0]=e[1]=0,e[2]=r,e},o.lerp=function(e,t,n,r){var i=t[0],s=t[1];return e[0]=i+r*(n[0]-i),e[1]=s+r*(n[1]-s),e},o.random=function(e,t){t=t||1;var n=r()*2*Math.PI;return e[0]=Math.cos(n)*t,e[1]=Math.sin(n)*t,e},o.transformMat2=function(e,t,n){var r=t[0],i=t[1];return e[0]=n[0]*r+n[2]*i,e[1]=n[1]*r+n[3]*i,e},o.transformMat2d=function(e,t,n){var r=t[0],i=t[1];return e[0]=n[0]*r+n[2]*i+n[4],e[1]=n[1]*r+n[3]*i+n[5],e},o.transformMat3=function(e,t,n){var r=t[0],i=t[1];return e[0]=n[0]*r+n[3]*i+n[6],e[1]=n[1]*r+n[4]*i+n[7],e},o.transformMat4=function(e,t,n){var r=t[0],i=t[1];return e[0]=n[0]*r+n[4]*i+n[12],e[1]=n[1]*r+n[5]*i+n[13],e},o.forEach=function(){var e=o.create();return function(t,n,r,i,s,o){var u,a;n||(n=2),r||(r=0),i?a=Math.min(i*n+r,t.length):a=t.length;for(u=r;u<a;u+=n)e[0]=t[u],e[1]=t[u+1],s(e,e,o),t[u]=e[0],t[u+1]=e[1];return t}}(),o.str=function(e){return"vec2("+e[0]+", "+e[1]+")"},typeof e!="undefined"&&(e.vec2=o);var u={};u.create=function(){var e=new n(3);return e[0]=0,e[1]=0,e[2]=0,e},u.clone=function(e){var t=new n(3);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t},u.fromValues=function(e,t,r){var i=new n(3);return i[0]=e,i[1]=t,i[2]=r,i},u.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e},u.set=function(e,t,n,r){return e[0]=t,e[1]=n,e[2]=r,e},u.add=function(e,t,n){return e[0]=t[0]+n[0],e[1]=t[1]+n[1],e[2]=t[2]+n[2],e},u.subtract=function(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e[2]=t[2]-n[2],e},u.sub=u.subtract,u.multiply=function(e,t,n){return e[0]=t[0]*n[0],e[1]=t[1]*n[1],e[2]=t[2]*n[2],e},u.mul=u.multiply,u.divide=function(e,t,n){return e[0]=t[0]/n[0],e[1]=t[1]/n[1],e[2]=t[2]/n[2],e},u.div=u.divide,u.min=function(e,t,n){return e[0]=Math.min(t[0],n[0]),e[1]=Math.min(t[1],n[1]),e[2]=Math.min(t[2],n[2]),e},u.max=function(e,t,n){return e[0]=Math.max(t[0],n[0]),e[1]=Math.max(t[1],n[1]),e[2]=Math.max(t[2],n[2]),e},u.scale=function(e,t,n){return e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e},u.scaleAndAdd=function(e,t,n,r){return e[0]=t[0]+n[0]*r,e[1]=t[1]+n[1]*r,e[2]=t[2]+n[2]*r,e},u.distance=function(e,t){var n=t[0]-e[0],r=t[1]-e[1],i=t[2]-e[2];return Math.sqrt(n*n+r*r+i*i)},u.dist=u.distance,u.squaredDistance=function(e,t){var n=t[0]-e[0],r=t[1]-e[1],i=t[2]-e[2];return n*n+r*r+i*i},u.sqrDist=u.squaredDistance,u.length=function(e){var t=e[0],n=e[1],r=e[2];return Math.sqrt(t*t+n*n+r*r)},u.len=u.length,u.squaredLength=function(e){var t=e[0],n=e[1],r=e[2];return t*t+n*n+r*r},u.sqrLen=u.squaredLength,u.negate=function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e},u.normalize=function(e,t){var n=t[0],r=t[1],i=t[2],s=n*n+r*r+i*i;return s>0&&(s=1/Math.sqrt(s),e[0]=t[0]*s,e[1]=t[1]*s,e[2]=t[2]*s),e},u.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]},u.cross=function(e,t,n){var r=t[0],i=t[1],s=t[2],o=n[0],u=n[1],a=n[2];return e[0]=i*a-s*u,e[1]=s*o-r*a,e[2]=r*u-i*o,e},u.lerp=function(e,t,n,r){var i=t[0],s=t[1],o=t[2];return e[0]=i+r*(n[0]-i),e[1]=s+r*(n[1]-s),e[2]=o+r*(n[2]-o),e},u.random=function(e,t){t=t||1;var n=r()*2*Math.PI,i=r()*2-1,s=Math.sqrt(1-i*i)*t;return e[0]=Math.cos(n)*s,e[1]=Math.sin(n)*s,e[2]=i*t,e},u.transformMat4=function(e,t,n){var r=t[0],i=t[1],s=t[2];return e[0]=n[0]*r+n[4]*i+n[8]*s+n[12],e[1]=n[1]*r+n[5]*i+n[9]*s+n[13],e[2]=n[2]*r+n[6]*i+n[10]*s+n[14],e},u.transformMat3=function(e,t,n){var r=t[0],i=t[1],s=t[2];return e[0]=r*n[0]+i*n[3]+s*n[6],e[1]=r*n[1]+i*n[4]+s*n[7],e[2]=r*n[2]+i*n[5]+s*n[8],e},u.transformQuat=function(e,t,n){var r=t[0],i=t[1],s=t[2],o=n[0],u=n[1],a=n[2],f=n[3],l=f*r+u*s-a*i,c=f*i+a*r-o*s,h=f*s+o*i-u*r,p=-o*r-u*i-a*s;return e[0]=l*f+p*-o+c*-a-h*-u,e[1]=c*f+p*-u+h*-o-l*-a,e[2]=h*f+p*-a+l*-u-c*-o,e},u.rotateX=function(e,t,n,r){var i=[],s=[];return i[0]=t[0]-n[0],i[1]=t[1]-n[1],i[2]=t[2]-n[2],s[0]=i[0],s[1]=i[1]*Math.cos(r)-i[2]*Math.sin(r),s[2]=i[1]*Math.sin(r)+i[2]*Math.cos(r),e[0]=s[0]+n[0],e[1]=s[1]+n[1],e[2]=s[2]+n[2],e},u.rotateY=function(e,t,n,r){var i=[],s=[];return i[0]=t[0]-n[0],i[1]=t[1]-n[1],i[2]=t[2]-n[2],s[0]=i[2]*Math.sin(r)+i[0]*Math.cos(r),s[1]=i[1],s[2]=i[2]*Math.cos(r)-i[0]*Math.sin(r),e[0]=s[0]+n[0],e[1]=s[1]+n[1],e[2]=s[2]+n[2],e},u.rotateZ=function(e,t,n,r){var i=[],s=[];return i[0]=t[0]-n[0],i[1]=t[1]-n[1],i[2]=t[2]-n[2],s[0]=i[0]*Math.cos(r)-i[1]*Math.sin(r),s[1]=i[0]*Math.sin(r)+i[1]*Math.cos(r),s[2]=i[2],e[0]=s[0]+n[0],e[1]=s[1]+n[1],e[2]=s[2]+n[2],e},u.forEach=function(){var e=u.create();return function(t,n,r,i,s,o){var u,a;n||(n=3),r||(r=0),i?a=Math.min(i*n+r,t.length):a=t.length;for(u=r;u<a;u+=n)e[0]=t[u],e[1]=t[u+1],e[2]=t[u+2],s(e,e,o),t[u]=e[0],t[u+1]=e[1],t[u+2]=e[2];return t}}(),u.str=function(e){return"vec3("+e[0]+", "+e[1]+", "+e[2]+")"},typeof e!="undefined"&&(e.vec3=u);var a={};a.create=function(){var e=new n(4);return e[0]=0,e[1]=0,e[2]=0,e[3]=0,e},a.clone=function(e){var t=new n(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},a.fromValues=function(e,t,r,i){var s=new n(4);return s[0]=e,s[1]=t,s[2]=r,s[3]=i,s},a.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},a.set=function(e,t,n,r,i){return e[0]=t,e[1]=n,e[2]=r,e[3]=i,e},a.add=function(e,t,n){return e[0]=t[0]+n[0],e[1]=t[1]+n[1],e[2]=t[2]+n[2],e[3]=t[3]+n[3],e},a.subtract=function(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e[2]=t[2]-n[2],e[3]=t[3]-n[3],e},a.sub=a.subtract,a.multiply=function(e,t,n){return e[0]=t[0]*n[0],e[1]=t[1]*n[1],e[2]=t[2]*n[2],e[3]=t[3]*n[3],e},a.mul=a.multiply,a.divide=function(e,t,n){return e[0]=t[0]/n[0],e[1]=t[1]/n[1],e[2]=t[2]/n[2],e[3]=t[3]/n[3],e},a.div=a.divide,a.min=function(e,t,n){return e[0]=Math.min(t[0],n[0]),e[1]=Math.min(t[1],n[1]),e[2]=Math.min(t[2],n[2]),e[3]=Math.min(t[3],n[3]),e},a.max=function(e,t,n){return e[0]=Math.max(t[0],n[0]),e[1]=Math.max(t[1],n[1]),e[2]=Math.max(t[2],n[2]),e[3]=Math.max(t[3],n[3]),e},a.scale=function(e,t,n){return e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e[3]=t[3]*n,e},a.scaleAndAdd=function(e,t,n,r){return e[0]=t[0]+n[0]*r,e[1]=t[1]+n[1]*r,e[2]=t[2]+n[2]*r,e[3]=t[3]+n[3]*r,e},a.distance=function(e,t){var n=t[0]-e[0],r=t[1]-e[1],i=t[2]-e[2],s=t[3]-e[3];return Math.sqrt(n*n+r*r+i*i+s*s)},a.dist=a.distance,a.squaredDistance=function(e,t){var n=t[0]-e[0],r=t[1]-e[1],i=t[2]-e[2],s=t[3]-e[3];return n*n+r*r+i*i+s*s},a.sqrDist=a.squaredDistance,a.length=function(e){var t=e[0],n=e[1],r=e[2],i=e[3];return Math.sqrt(t*t+n*n+r*r+i*i)},a.len=a.length,a.squaredLength=function(e){var t=e[0],n=e[1],r=e[2],i=e[3];return t*t+n*n+r*r+i*i},a.sqrLen=a.squaredLength,a.negate=function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=-t[3],e},a.normalize=function(e,t){var n=t[0],r=t[1],i=t[2],s=t[3],o=n*n+r*r+i*i+s*s;return o>0&&(o=1/Math.sqrt(o),e[0]=t[0]*o,e[1]=t[1]*o,e[2]=t[2]*o,e[3]=t[3]*o),e},a.dot=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]},a.lerp=function(e,t,n,r){var i=t[0],s=t[1],o=t[2],u=t[3];return e[0]=i+r*(n[0]-i),e[1]=s+r*(n[1]-s),e[2]=o+r*(n[2]-o),e[3]=u+r*(n[3]-u),e},a.random=function(e,t){return t=t||1,e[0]=r(),e[1]=r(),e[2]=r(),e[3]=r(),a.normalize(e,e),a.scale(e,e,t),e},a.transformMat4=function(e,t,n){var r=t[0],i=t[1],s=t[2],o=t[3];return e[0]=n[0]*r+n[4]*i+n[8]*s+n[12]*o,e[1]=n[1]*r+n[5]*i+n[9]*s+n[13]*o,e[2]=n[2]*r+n[6]*i+n[10]*s+n[14]*o,e[3]=n[3]*r+n[7]*i+n[11]*s+n[15]*o,e},a.transformQuat=function(e,t,n){var r=t[0],i=t[1],s=t[2],o=n[0],u=n[1],a=n[2],f=n[3],l=f*r+u*s-a*i,c=f*i+a*r-o*s,h=f*s+o*i-u*r,p=-o*r-u*i-a*s;return e[0]=l*f+p*-o+c*-a-h*-u,e[1]=c*f+p*-u+h*-o-l*-a,e[2]=h*f+p*-a+l*-u-c*-o,e},a.forEach=function(){var e=a.create();return function(t,n,r,i,s,o){var u,a;n||(n=4),r||(r=0),i?a=Math.min(i*n+r,t.length):a=t.length;for(u=r;u<a;u+=n)e[0]=t[u],e[1]=t[u+1],e[2]=t[u+2],e[3]=t[u+3],s(e,e,o),t[u]=e[0],t[u+1]=e[1],t[u+2]=e[2],t[u+3]=e[3];return t}}(),a.str=function(e){return"vec4("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"},typeof e!="undefined"&&(e.vec4=a);var f={};f.create=function(){var e=new n(4);return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e},f.clone=function(e){var t=new n(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},f.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},f.identity=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e},f.transpose=function(e,t){if(e===t){var n=t[1];e[1]=t[2],e[2]=n}else e[0]=t[0],e[1]=t[2],e[2]=t[1],e[3]=t[3];return e},f.invert=function(e,t){var n=t[0],r=t[1],i=t[2],s=t[3],o=n*s-i*r;return o?(o=1/o,e[0]=s*o,e[1]=-r*o,e[2]=-i*o,e[3]=n*o,e):null},f.adjoint=function(e,t){var n=t[0];return e[0]=t[3],e[1]=-t[1],e[2]=-t[2],e[3]=n,e},f.determinant=function(e){return e[0]*e[3]-e[2]*e[1]},f.multiply=function(e,t,n){var r=t[0],i=t[1],s=t[2],o=t[3],u=n[0],a=n[1],f=n[2],l=n[3];return e[0]=r*u+s*a,e[1]=i*u+o*a,e[2]=r*f+s*l,e[3]=i*f+o*l,e},f.mul=f.multiply,f.rotate=function(e,t,n){var r=t[0],i=t[1],s=t[2],o=t[3],u=Math.sin(n),a=Math.cos(n);return e[0]=r*a+s*u,e[1]=i*a+o*u,e[2]=r*-u+s*a,e[3]=i*-u+o*a,e},f.scale=function(e,t,n){var r=t[0],i=t[1],s=t[2],o=t[3],u=n[0],a=n[1];return e[0]=r*u,e[1]=i*u,e[2]=s*a,e[3]=o*a,e},f.str=function(e){return"mat2("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"},f.frob=function(e){return Math.sqrt(Math.pow(e[0],2)+Math.pow(e[1],2)+Math.pow(e[2],2)+Math.pow(e[3],2))},f.LDU=function(e,t,n,r){return e[2]=r[2]/r[0],n[0]=r[0],n[1]=r[1],n[3]=r[3]-e[2]*n[1],[e,t,n]},typeof e!="undefined"&&(e.mat2=f);var l={};l.create=function(){var e=new n(6);return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e[4]=0,e[5]=0,e},l.clone=function(e){var t=new n(6);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t},l.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e},l.identity=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e[4]=0,e[5]=0,e},l.invert=function(e,t){var n=t[0],r=t[1],i=t[2],s=t[3],o=t[4],u=t[5],a=n*s-r*i;return a?(a=1/a,e[0]=s*a,e[1]=-r*a,e[2]=-i*a,e[3]=n*a,e[4]=(i*u-s*o)*a,e[5]=(r*o-n*u)*a,e):null},l.determinant=function(e){return e[0]*e[3]-e[1]*e[2]},l.multiply=function(e,t,n){var r=t[0],i=t[1],s=t[2],o=t[3],u=t[4],a=t[5],f=n[0],l=n[1],c=n[2],h=n[3],p=n[4],d=n[5];return e[0]=r*f+s*l,e[1]=i*f+o*l,e[2]=r*c+s*h,e[3]=i*c+o*h,e[4]=r*p+s*d+u,e[5]=i*p+o*d+a,e},l.mul=l.multiply,l.rotate=function(e,t,n){var r=t[0],i=t[1],s=t[2],o=t[3],u=t[4],a=t[5],f=Math.sin(n),l=Math.cos(n);return e[0]=r*l+s*f,e[1]=i*l+o*f,e[2]=r*-f+s*l,e[3]=i*-f+o*l,e[4]=u,e[5]=a,e},l.scale=function(e,t,n){var r=t[0],i=t[1],s=t[2],o=t[3],u=t[4],a=t[5],f=n[0],l=n[1];return e[0]=r*f,e[1]=i*f,e[2]=s*l,e[3]=o*l,e[4]=u,e[5]=a,e},l.translate=function(e,t,n){var r=t[0],i=t[1],s=t[2],o=t[3],u=t[4],a=t[5],f=n[0],l=n[1];return e[0]=r,e[1]=i,e[2]=s,e[3]=o,e[4]=r*f+s*l+u,e[5]=i*f+o*l+a,e},l.str=function(e){return"mat2d("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+")"},l.frob=function(e){return Math.sqrt(Math.pow(e[0],2)+Math.pow(e[1],2)+Math.pow(e[2],2)+Math.pow(e[3],2)+Math.pow(e[4],2)+Math.pow(e[5],2)+1)},typeof e!="undefined"&&(e.mat2d=l);var c={};c.create=function(){var e=new n(9);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},c.fromMat4=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[4],e[4]=t[5],e[5]=t[6],e[6]=t[8],e[7]=t[9],e[8]=t[10],e},c.clone=function(e){var t=new n(9);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t},c.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e},c.identity=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},c.transpose=function(e,t){if(e===t){var n=t[1],r=t[2],i=t[5];e[1]=t[3],e[2]=t[6],e[3]=n,e[5]=t[7],e[6]=r,e[7]=i}else e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8];return e},c.invert=function(e,t){var n=t[0],r=t[1],i=t[2],s=t[3],o=t[4],u=t[5],a=t[6],f=t[7],l=t[8],c=l*o-u*f,h=-l*s+u*a,p=f*s-o*a,d=n*c+r*h+i*p;return d?(d=1/d,e[0]=c*d,e[1]=(-l*r+i*f)*d,e[2]=(u*r-i*o)*d,e[3]=h*d,e[4]=(l*n-i*a)*d,e[5]=(-u*n+i*s)*d,e[6]=p*d,e[7]=(-f*n+r*a)*d,e[8]=(o*n-r*s)*d,e):null},c.adjoint=function(e,t){var n=t[0],r=t[1],i=t[2],s=t[3],o=t[4],u=t[5],a=t[6],f=t[7],l=t[8];return e[0]=o*l-u*f,e[1]=i*f-r*l,e[2]=r*u-i*o,e[3]=u*a-s*l,e[4]=n*l-i*a,e[5]=i*s-n*u,e[6]=s*f-o*a,e[7]=r*a-n*f,e[8]=n*o-r*s,e},c.determinant=function(e){var t=e[0],n=e[1],r=e[2],i=e[3],s=e[4],o=e[5],u=e[6],a=e[7],f=e[8];return t*(f*s-o*a)+n*(-f*i+o*u)+r*(a*i-s*u)},c.multiply=function(e,t,n){var r=t[0],i=t[1],s=t[2],o=t[3],u=t[4],a=t[5],f=t[6],l=t[7],c=t[8],h=n[0],p=n[1],d=n[2],v=n[3],m=n[4],g=n[5],y=n[6],b=n[7],w=n[8];return e[0]=h*r+p*o+d*f,e[1]=h*i+p*u+d*l,e[2]=h*s+p*a+d*c,e[3]=v*r+m*o+g*f,e[4]=v*i+m*u+g*l,e[5]=v*s+m*a+g*c,e[6]=y*r+b*o+w*f,e[7]=y*i+b*u+w*l,e[8]=y*s+b*a+w*c,e},c.mul=c.multiply,c.translate=function(e,t,n){var r=t[0],i=t[1],s=t[2],o=t[3],u=t[4],a=t[5],f=t[6],l=t[7],c=t[8],h=n[0],p=n[1];return e[0]=r,e[1]=i,e[2]=s,e[3]=o,e[4]=u,e[5]=a,e[6]=h*r+p*o+f,e[7]=h*i+p*u+l,e[8]=h*s+p*a+c,e},c.rotate=function(e,t,n){var r=t[0],i=t[1],s=t[2],o=t[3],u=t[4],a=t[5],f=t[6],l=t[7],c=t[8],h=Math.sin(n),p=Math.cos(n);return e[0]=p*r+h*o,e[1]=p*i+h*u,e[2]=p*s+h*a,e[3]=p*o-h*r,e[4]=p*u-h*i,e[5]=p*a-h*s,e[6]=f,e[7]=l,e[8]=c,e},c.scale=function(e,t,n){var r=n[0],i=n[1];return e[0]=r*t[0],e[1]=r*t[1],e[2]=r*t[2],e[3]=i*t[3],e[4]=i*t[4],e[5]=i*t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e},c.fromMat2d=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=0,e[3]=t[2],e[4]=t[3],e[5]=0,e[6]=t[4],e[7]=t[5],e[8]=1,e},c.fromQuat=function(e,t){var n=t[0],r=t[1],i=t[2],s=t[3],o=n+n,u=r+r,a=i+i,f=n*o,l=r*o,c=r*u,h=i*o,p=i*u,d=i*a,v=s*o,m=s*u,g=s*a;return e[0]=1-c-d,e[3]=l-g,e[6]=h+m,e[1]=l+g,e[4]=1-f-d,e[7]=p-v,e[2]=h-m,e[5]=p+v,e[8]=1-f-c,e},c.normalFromMat4=function(e,t){var n=t[0],r=t[1],i=t[2],s=t[3],o=t[4],u=t[5],a=t[6],f=t[7],l=t[8],c=t[9],h=t[10],p=t[11],d=t[12],v=t[13],m=t[14],g=t[15],y=n*u-r*o,b=n*a-i*o,w=n*f-s*o,E=r*a-i*u,S=r*f-s*u,x=i*f-s*a,T=l*v-c*d,N=l*m-h*d,C=l*g-p*d,k=c*m-h*v,L=c*g-p*v,A=h*g-p*m,O=y*A-b*L+w*k+E*C-S*N+x*T;return O?(O=1/O,e[0]=(u*A-a*L+f*k)*O,e[1]=(a*C-o*A-f*N)*O,e[2]=(o*L-u*C+f*T)*O,e[3]=(i*L-r*A-s*k)*O,e[4]=(n*A-i*C+s*N)*O,e[5]=(r*C-n*L-s*T)*O,e[6]=(v*x-m*S+g*E)*O,e[7]=(m*w-d*x-g*b)*O,e[8]=(d*S-v*w+g*y)*O,e):null},c.str=function(e){return"mat3("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+")"},c.frob=function(e){return Math.sqrt(Math.pow(e[0],2)+Math.pow(e[1],2)+Math.pow(e[2],2)+Math.pow(e[3],2)+Math.pow(e[4],2)+Math.pow(e[5],2)+Math.pow(e[6],2)+Math.pow(e[7],2)+Math.pow(e[8],2))},typeof e!="undefined"&&(e.mat3=c);var h={};h.create=function(){var e=new n(16);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},h.clone=function(e){var t=new n(16);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},h.copy=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},h.identity=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},h.transpose=function(e,t){if(e===t){var n=t[1],r=t[2],i=t[3],s=t[6],o=t[7],u=t[11];e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=n,e[6]=t[9],e[7]=t[13],e[8]=r,e[9]=s,e[11]=t[14],e[12]=i,e[13]=o,e[14]=u}else e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15];return e},h.invert=function(e,t){var n=t[0],r=t[1],i=t[2],s=t[3],o=t[4],u=t[5],a=t[6],f=t[7],l=t[8],c=t[9],h=t[10],p=t[11],d=t[12],v=t[13],m=t[14],g=t[15],y=n*u-r*o,b=n*a-i*o,w=n*f-s*o,E=r*a-i*u,S=r*f-s*u,x=i*f-s*a,T=l*v-c*d,N=l*m-h*d,C=l*g-p*d,k=c*m-h*v,L=c*g-p*v,A=h*g-p*m,O=y*A-b*L+w*k+E*C-S*N+x*T;return O?(O=1/O,e[0]=(u*A-a*L+f*k)*O,e[1]=(i*L-r*A-s*k)*O,e[2]=(v*x-m*S+g*E)*O,e[3]=(h*S-c*x-p*E)*O,e[4]=(a*C-o*A-f*N)*O,e[5]=(n*A-i*C+s*N)*O,e[6]=(m*w-d*x-g*b)*O,e[7]=(l*x-h*w+p*b)*O,e[8]=(o*L-u*C+f*T)*O,e[9]=(r*C-n*L-s*T)*O,e[10]=(d*S-v*w+g*y)*O,e[11]=(c*w-l*S-p*y)*O,e[12]=(u*N-o*k-a*T)*O,e[13]=(n*k-r*N+i*T)*O,e[14]=(v*b-d*E-m*y)*O,e[15]=(l*E-c*b+h*y)*O,e):null},h.adjoint=function(e,t){var n=t[0],r=t[1],i=t[2],s=t[3],o=t[4],u=t[5],a=t[6],f=t[7],l=t[8],c=t[9],h=t[10],p=t[11],d=t[12],v=t[13],m=t[14],g=t[15];return e[0]=u*(h*g-p*m)-c*(a*g-f*m)+v*(a*p-f*h),e[1]=-(r*(h*g-p*m)-c*(i*g-s*m)+v*(i*p-s*h)),e[2]=r*(a*g-f*m)-u*(i*g-s*m)+v*(i*f-s*a),e[3]=-(r*(a*p-f*h)-u*(i*p-s*h)+c*(i*f-s*a)),e[4]=-(o*(h*g-p*m)-l*(a*g-f*m)+d*(a*p-f*h)),e[5]=n*(h*g-p*m)-l*(i*g-s*m)+d*(i*p-s*h),e[6]=-(n*(a*g-f*m)-o*(i*g-s*m)+d*(i*f-s*a)),e[7]=n*(a*p-f*h)-o*(i*p-s*h)+l*(i*f-s*a),e[8]=o*(c*g-p*v)-l*(u*g-f*v)+d*(u*p-f*c),e[9]=-(n*(c*g-p*v)-l*(r*g-s*v)+d*(r*p-s*c)),e[10]=n*(u*g-f*v)-o*(r*g-s*v)+d*(r*f-s*u),e[11]=-(n*(u*p-f*c)-o*(r*p-s*c)+l*(r*f-s*u)),e[12]=-(o*(c*m-h*v)-l*(u*m-a*v)+d*(u*h-a*c)),e[13]=n*(c*m-h*v)-l*(r*m-i*v)+d*(r*h-i*c),e[14]=-(n*(u*m-a*v)-o*(r*m-i*v)+d*(r*a-i*u)),e[15]=n*(u*h-a*c)-o*(r*h-i*c)+l*(r*a-i*u),e},h.determinant=function(e){var t=e[0],n=e[1],r=e[2],i=e[3],s=e[4],o=e[5],u=e[6],a=e[7],f=e[8],l=e[9],c=e[10],h=e[11],p=e[12],d=e[13],v=e[14],m=e[15],g=t*o-n*s,y=t*u-r*s,b=t*a-i*s,w=n*u-r*o,E=n*a-i*o,S=r*a-i*u,x=f*d-l*p,T=f*v-c*p,N=f*m-h*p,C=l*v-c*d,k=l*m-h*d,L=c*m-h*v;return g*L-y*k+b*C+w*N-E*T+S*x},h.multiply=function(e,t,n){var r=t[0],i=t[1],s=t[2],o=t[3],u=t[4],a=t[5],f=t[6],l=t[7],c=t[8],h=t[9],p=t[10],d=t[11],v=t[12],m=t[13],g=t[14],y=t[15],b=n[0],w=n[1],E=n[2],S=n[3];return e[0]=b*r+w*u+E*c+S*v,e[1]=b*i+w*a+E*h+S*m,e[2]=b*s+w*f+E*p+S*g,e[3]=b*o+w*l+E*d+S*y,b=n[4],w=n[5],E=n[6],S=n[7],e[4]=b*r+w*u+E*c+S*v,e[5]=b*i+w*a+E*h+S*m,e[6]=b*s+w*f+E*p+S*g,e[7]=b*o+w*l+E*d+S*y,b=n[8],w=n[9],E=n[10],S=n[11],e[8]=b*r+w*u+E*c+S*v,e[9]=b*i+w*a+E*h+S*m,e[10]=b*s+w*f+E*p+S*g,e[11]=b*o+w*l+E*d+S*y,b=n[12],w=n[13],E=n[14],S=n[15],e[12]=b*r+w*u+E*c+S*v,e[13]=b*i+w*a+E*h+S*m,e[14]=b*s+w*f+E*p+S*g,e[15]=b*o+w*l+E*d+S*y,e},h.mul=h.multiply,h.translate=function(e,t,n){var r=n[0],i=n[1],s=n[2],o,u,a,f,l,c,h,p,d,v,m,g;return t===e?(e[12]=t[0]*r+t[4]*i+t[8]*s+t[12],e[13]=t[1]*r+t[5]*i+t[9]*s+t[13],e[14]=t[2]*r+t[6]*i+t[10]*s+t[14],e[15]=t[3]*r+t[7]*i+t[11]*s+t[15]):(o=t[0],u=t[1],a=t[2],f=t[3],l=t[4],c=t[5],h=t[6],p=t[7],d=t[8],v=t[9],m=t[10],g=t[11],e[0]=o,e[1]=u,e[2]=a,e[3]=f,e[4]=l,e[5]=c,e[6]=h,e[7]=p,e[8]=d,e[9]=v,e[10]=m,e[11]=g,e[12]=o*r+l*i+d*s+t[12],e[13]=u*r+c*i+v*s+t[13],e[14]=a*r+h*i+m*s+t[14],e[15]=f*r+p*i+g*s+t[15]),e},h.scale=function(e,t,n){var r=n[0],i=n[1],s=n[2];return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e[4]=t[4]*i,e[5]=t[5]*i,e[6]=t[6]*i,e[7]=t[7]*i,e[8]=t[8]*s,e[9]=t[9]*s,e[10]=t[10]*s,e[11]=t[11]*s,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},h.rotate=function(e,n,r,i){var s=i[0],o=i[1],u=i[2],a=Math.sqrt(s*s+o*o+u*u),f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M,_;return Math.abs(a)<t?null:(a=1/a,s*=a,o*=a,u*=a,f=Math.sin(r),l=Math.cos(r),c=1-l,h=n[0],p=n[1],d=n[2],v=n[3],m=n[4],g=n[5],y=n[6],b=n[7],w=n[8],E=n[9],S=n[10],x=n[11],T=s*s*c+l,N=o*s*c+u*f,C=u*s*c-o*f,k=s*o*c-u*f,L=o*o*c+l,A=u*o*c+s*f,O=s*u*c+o*f,M=o*u*c-s*f,_=u*u*c+l,e[0]=h*T+m*N+w*C,e[1]=p*T+g*N+E*C,e[2]=d*T+y*N+S*C,e[3]=v*T+b*N+x*C,e[4]=h*k+m*L+w*A,e[5]=p*k+g*L+E*A,e[6]=d*k+y*L+S*A,e[7]=v*k+b*L+x*A,e[8]=h*O+m*M+w*_,e[9]=p*O+g*M+E*_,e[10]=d*O+y*M+S*_,e[11]=v*O+b*M+x*_,n!==e&&(e[12]=n[12],e[13]=n[13],e[14]=n[14],e[15]=n[15]),e)},h.rotateX=function(e,t,n){var r=Math.sin(n),i=Math.cos(n),s=t[4],o=t[5],u=t[6],a=t[7],f=t[8],l=t[9],c=t[10],h=t[11];return t!==e&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[4]=s*i+f*r,e[5]=o*i+l*r,e[6]=u*i+c*r,e[7]=a*i+h*r,e[8]=f*i-s*r,e[9]=l*i-o*r,e[10]=c*i-u*r,e[11]=h*i-a*r,e},h.rotateY=function(e,t,n){var r=Math.sin(n),i=Math.cos(n),s=t[0],o=t[1],u=t[2],a=t[3],f=t[8],l=t[9],c=t[10],h=t[11];return t!==e&&(e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=s*i-f*r,e[1]=o*i-l*r,e[2]=u*i-c*r,e[3]=a*i-h*r,e[8]=s*r+f*i,e[9]=o*r+l*i,e[10]=u*r+c*i,e[11]=a*r+h*i,e},h.rotateZ=function(e,t,n){var r=Math.sin(n),i=Math.cos(n),s=t[0],o=t[1],u=t[2],a=t[3],f=t[4],l=t[5],c=t[6],h=t[7];return t!==e&&(e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=s*i+f*r,e[1]=o*i+l*r,e[2]=u*i+c*r,e[3]=a*i+h*r,e[4]=f*i-s*r,e[5]=l*i-o*r,e[6]=c*i-u*r,e[7]=h*i-a*r,e},h.fromRotationTranslation=function(e,t,n){var r=t[0],i=t[1],s=t[2],o=t[3],u=r+r,a=i+i,f=s+s,l=r*u,c=r*a,h=r*f,p=i*a,d=i*f,v=s*f,m=o*u,g=o*a,y=o*f;return e[0]=1-(p+v),e[1]=c+y,e[2]=h-g,e[3]=0,e[4]=c-y,e[5]=1-(l+v),e[6]=d+m,e[7]=0,e[8]=h+g,e[9]=d-m,e[10]=1-(l+p),e[11]=0,e[12]=n[0],e[13]=n[1],e[14]=n[2],e[15]=1,e},h.fromQuat=function(e,t){var n=t[0],r=t[1],i=t[2],s=t[3],o=n+n,u=r+r,a=i+i,f=n*o,l=r*o,c=r*u,h=i*o,p=i*u,d=i*a,v=s*o,m=s*u,g=s*a;return e[0]=1-c-d,e[1]=l+g,e[2]=h-m,e[3]=0,e[4]=l-g,e[5]=1-f-d,e[6]=p+v,e[7]=0,e[8]=h+m,e[9]=p-v,e[10]=1-f-c,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},h.frustum=function(e,t,n,r,i,s,o){var u=1/(n-t),a=1/(i-r),f=1/(s-o);return e[0]=s*2*u,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=s*2*a,e[6]=0,e[7]=0,e[8]=(n+t)*u,e[9]=(i+r)*a,e[10]=(o+s)*f,e[11]=-1,e[12]=0,e[13]=0,e[14]=o*s*2*f,e[15]=0,e},h.perspective=function(e,t,n,r,i){var s=1/Math.tan(t/2),o=1/(r-i);return e[0]=s/n,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=s,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=(i+r)*o,e[11]=-1,e[12]=0,e[13]=0,e[14]=2*i*r*o,e[15]=0,e},h.ortho=function(e,t,n,r,i,s,o){var u=1/(t-n),a=1/(r-i),f=1/(s-o);return e[0]=-2*u,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*a,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=2*f,e[11]=0,e[12]=(t+n)*u,e[13]=(i+r)*a,e[14]=(o+s)*f,e[15]=1,e},h.lookAt=function(e,n,r,i){var s,o,u,a,f,l,c,p,d,v,m=n[0],g=n[1],y=n[2],b=i[0],w=i[1],E=i[2],S=r[0],x=r[1],T=r[2];return Math.abs(m-S)<t&&Math.abs(g-x)<t&&Math.abs(y-T)<t?h.identity(e):(c=m-S,p=g-x,d=y-T,v=1/Math.sqrt(c*c+p*p+d*d),c*=v,p*=v,d*=v,s=w*d-E*p,o=E*c-b*d,u=b*p-w*c,v=Math.sqrt(s*s+o*o+u*u),v?(v=1/v,s*=v,o*=v,u*=v):(s=0,o=0,u=0),a=p*u-d*o,f=d*s-c*u,l=c*o-p*s,v=Math.sqrt(a*a+f*f+l*l),v?(v=1/v,a*=v,f*=v,l*=v):(a=0,f=0,l=0),e[0]=s,e[1]=a,e[2]=c,e[3]=0,e[4]=o,e[5]=f,e[6]=p,e[7]=0,e[8]=u,e[9]=l,e[10]=d,e[11]=0,e[12]=-(s*m+o*g+u*y),e[13]=-(a*m+f*g+l*y),e[14]=-(c*m+p*g+d*y),e[15]=1,e)},h.str=function(e){return"mat4("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+", "+e[9]+", "+e[10]+", "+e[11]+", "+e[12]+", "+e[13]+", "+e[14]+", "+e[15]+")"},h.frob=function(e){return Math.sqrt(Math.pow(e[0],2)+Math.pow(e[1],2)+Math.pow(e[2],2)+Math.pow(e[3],2)+Math.pow(e[4],2)+Math.pow(e[5],2)+Math.pow(e[6],2)+Math.pow(e[6],2)+Math.pow(e[7],2)+Math.pow(e[8],2)+Math.pow(e[9],2)+Math.pow(e[10],2)+Math.pow(e[11],2)+Math.pow(e[12],2)+Math.pow(e[13],2)+Math.pow(e[14],2)+Math.pow(e[15],2))},typeof e!="undefined"&&(e.mat4=h);var p={};p.create=function(){var e=new n(4);return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e},p.rotationTo=function(){var e=u.create(),t=u.fromValues(1,0,0),n=u.fromValues(0,1,0);return function(r,i,s){var o=u.dot(i,s);return o<-0.999999?(u.cross(e,t,i),u.length(e)<1e-6&&u.cross(e,n,i),u.normalize(e,e),p.setAxisAngle(r,e,Math.PI),r):o>.999999?(r[0]=0,r[1]=0,r[2]=0,r[3]=1,r):(u.cross(e,i,s),r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=1+o,p.normalize(r,r))}}(),p.setAxes=function(){var e=c.create();return function(t,n,r,i){return e[0]=r[0],e[3]=r[1],e[6]=r[2],e[1]=i[0],e[4]=i[1],e[7]=i[2],e[2]=-n[0],e[5]=-n[1],e[8]=-n[2],p.normalize(t,p.fromMat3(t,e))}}(),p.clone=a.clone,p.fromValues=a.fromValues,p.copy=a.copy,p.set=a.set,p.identity=function(e){return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e},p.setAxisAngle=function(e,t,n){n*=.5;var r=Math.sin(n);return e[0]=r*t[0],e[1]=r*t[1],e[2]=r*t[2],e[3]=Math.cos(n),e},p.add=a.add,p.multiply=function(e,t,n){var r=t[0],i=t[1],s=t[2],o=t[3],u=n[0],a=n[1],f=n[2],l=n[3];return e[0]=r*l+o*u+i*f-s*a,e[1]=i*l+o*a+s*u-r*f,e[2]=s*l+o*f+r*a-i*u,e[3]=o*l-r*u-i*a-s*f,e},p.mul=p.multiply,p.scale=a.scale,p.rotateX=function(e,t,n){n*=.5;var r=t[0],i=t[1],s=t[2],o=t[3],u=Math.sin(n),a=Math.cos(n);return e[0]=r*a+o*u,e[1]=i*a+s*u,e[2]=s*a-i*u,e[3]=o*a-r*u,e},p.rotateY=function(e,t,n){n*=.5;var r=t[0],i=t[1],s=t[2],o=t[3],u=Math.sin(n),a=Math.cos(n);return e[0]=r*a-s*u,e[1]=i*a+o*u,e[2]=s*a+r*u,e[3]=o*a-i*u,e},p.rotateZ=function(e,t,n){n*=.5;var r=t[0],i=t[1],s=t[2],o=t[3],u=Math.sin(n),a=Math.cos(n);return e[0]=r*a+i*u,e[1]=i*a-r*u,e[2]=s*a+o*u,e[3]=o*a-s*u,e},p.calculateW=function(e,t){var n=t[0],r=t[1],i=t[2];return e[0]=n,e[1]=r,e[2]=i,e[3]=-Math.sqrt(Math.abs(1-n*n-r*r-i*i)),e},p.dot=a.dot,p.lerp=a.lerp,p.slerp=function(e,t,n,r){var i=t[0],s=t[1],o=t[2],u=t[3],a=n[0],f=n[1],l=n[2],c=n[3],h,p,d,v,m;return p=i*a+s*f+o*l+u*c,p<0&&(p=-p,a=-a,f=-f,l=-l,c=-c),1-p>1e-6?(h=Math.acos(p),d=Math.sin(h),v=Math.sin((1-r)*h)/d,m=Math.sin(r*h)/d):(v=1-r,m=r),e[0]=v*i+m*a,e[1]=v*s+m*f,e[2]=v*o+m*l,e[3]=v*u+m*c,e},p.invert=function(e,t){var n=t[0],r=t[1],i=t[2],s=t[3],o=n*n+r*r+i*i+s*s,u=o?1/o:0;return e[0]=-n*u,e[1]=-r*u,e[2]=-i*u,e[3]=s*u,e},p.conjugate=function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=t[3],e},p.length=a.length,p.len=p.length,p.squaredLength=a.squaredLength,p.sqrLen=p.squaredLength,p.normalize=a.normalize,p.fromMat3=function(e,t){var n=t[0]+t[4]+t[8],r;if(n>0)r=Math.sqrt(n+1),e[3]=.5*r,r=.5/r,e[0]=(t[7]-t[5])*r,e[1]=(t[2]-t[6])*r,e[2]=(t[3]-t[1])*r;else{var i=0;t[4]>t[0]&&(i=1),t[8]>t[i*3+i]&&(i=2);var s=(i+1)%3,o=(i+2)%3;r=Math.sqrt(t[i*3+i]-t[s*3+s]-t[o*3+o]+1),e[i]=.5*r,r=.5/r,e[3]=(t[o*3+s]-t[s*3+o])*r,e[s]=(t[s*3+i]+t[i*3+s])*r,e[o]=(t[o*3+i]+t[i*3+o])*r}return e},p.str=function(e){return"quat("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"},typeof e!="undefined"&&(e.quat=p)}(t.exports)})(this);
'use strict';(function(r){function O(f,e,a){this.gl=a=a||r.gl;this._context_id=a.context_id;this.handler=null;this.height=this.width=-1;this.color_textures=[];this.depth_texture=null;(f&&f.length||e)&&this.setTextures(f,e);this._old_fbo=null;this._old_viewport=new Float32Array(4)}var p=r.GL={};r.requestAnimationFrame=r.requestAnimationFrame||r.mozRequestAnimationFrame||r.webkitRequestAnimationFrame||function(f){setTimeout(f,1E3/60)};p.blockable_keys={Up:!0,Down:!0,Left:!0,Right:!0};p.LEFT_MOUSE_BUTTON=
1;p.RIGHT_MOUSE_BUTTON=3;p.MIDDLE_MOUSE_BUTTON=2;p.last_context_id=0;p.BYTE=5120;p.UNSIGNED_BYTE=5121;p.SHORT=5122;p.UNSIGNED_SHORT=5123;p.INT=5124;p.UNSIGNED_INT=5125;p.FLOAT=5126;p.ZERO=0;p.ONE=1;p.SRC_COLOR=768;p.ONE_MINUS_SRC_COLOR=769;p.SRC_ALPHA=770;p.ONE_MINUS_SRC_ALPHA=771;p.DST_ALPHA=772;p.ONE_MINUS_DST_ALPHA=773;p.DST_COLOR=774;p.ONE_MINUS_DST_COLOR=775;p.SRC_ALPHA_SATURATE=776;p.CONSTANT_COLOR=32769;p.ONE_MINUS_CONSTANT_COLOR=32770;p.CONSTANT_ALPHA=32771;p.ONE_MINUS_CONSTANT_ALPHA=32772;
p.temp_vec3=vec3.create();p.temp2_vec3=vec3.create();p.temp_vec4=vec4.create();p.temp_mat4=mat4.create();r.DEG2RAD=0.0174532925;r.RAD2DEG=57.295779578552306;r.EPSILON=1E-6;r.isPowerOfTwo=p.isPowerOfTwo=function(f){return 0==Math.log(f)/Math.log(2)%1};r.getTime="undefined"!=typeof performance?performance.now.bind(performance):Date.now.bind(Date);p.getTime=r.getTime;r.isFunction=function(f){return!!(f&&f.constructor&&f.call&&f.apply)};r.isArray=function(f){return f&&f.constructor===Array};r.isNumber=
function(f){return null!=f&&f.constructor===Number};r.cloneObject=p.cloneObject=function(f,e){if(f.constructor!==Object)throw"cloneObject only can clone pure javascript objects, not classes";e=e||{};for(var a in f){var b=f[a];if(null===b)e[a]=null;else switch(b.constructor){case Int8Array:case Uint8Array:case Int16Array:case Uint16Array:case Int32Array:case Uint32Array:case Float32Array:case Float64Array:e[a]=new b.constructor(b);break;case Boolean:case Number:case String:e[a]=b;break;case Array:e[a]=
b.concat();break;case Object:e[a]=p.cloneObject(b)}}return e};r.regexMap=function(f,e,a){for(var b;null!=(b=f.exec(e));)a(b)};r.createCanvas=p.createCanvas=function(f,e){var a=document.createElement("canvas");a.width=f;a.height=e;return a};r.cloneCanvas=p.cloneCanvas=function(f){var e=document.createElement("canvas");e.width=f.width;e.height=f.height;e.getContext("2d").drawImage(f,0,0);return e};"undefined"!=typeof Image&&(Image.prototype.getPixels=function(){var f=document.createElement("canvas");
f.width=this.width;f.height=this.height;f=f.getContext("2d");f.drawImage(this,0,0);return f.getImageData(0,0,this.width,this.height).data});String.prototype.hasOwnProperty("replaceAll")||Object.defineProperty(String.prototype,"replaceAll",{value:function(f){var e=this,a;for(a in f)e=e.split(a).join(f[a]);return e},enumerable:!1});String.prototype.hasOwnProperty("hashCode")||Object.defineProperty(String.prototype,"hashCode",{value:function(){var f=0,e,a,b;if(0==this.length)return f;e=0;for(b=this.length;e<
b;++e)a=this.charCodeAt(e),f=(f<<5)-f+a,f|=0;return f},enumerable:!1});Array.prototype.hasOwnProperty("subarray")||Object.defineProperty(Array.prototype,"subarray",{value:Array.prototype.slice,enumerable:!1});r.wipeObject=function(f){for(var e in f)f.hasOwnProperty(e)&&delete f[e]};r.extendClass=p.extendClass=function(f,e){for(var a in e)f.hasOwnProperty(a)||(f[a]=e[a]);if(e.prototype)for(a in e.prototype)e.prototype.hasOwnProperty(a)&&!f.prototype.hasOwnProperty(a)&&(e.prototype.__lookupGetter__(a)?
f.prototype.__defineGetter__(a,e.prototype.__lookupGetter__(a)):f.prototype[a]=e.prototype[a],e.prototype.__lookupSetter__(a)&&f.prototype.__defineSetter__(a,e.prototype.__lookupSetter__(a)));f.hasOwnProperty("superclass")||Object.defineProperty(f,"superclass",{get:function(){return e},enumerable:!1})};r.HttpRequest=p.request=function(f,e,a,b,c){var d=!0;c&&void 0!==c.async&&(d=c.async);if(e){var g=null,g=[],h;for(h in e)g.push(h+"="+e[h]);g=g.join("&");f=f+"?"+g}var k=new XMLHttpRequest;k.open("GET",
f,d);k.onload=function(c){this.getResponseHeader("Content-Type");200!=this.status?(x.trigger(k,"fail",this.status),b&&b(this.status)):(x.trigger(k,"done",this.response),a&&a(this.response))};k.onerror=function(a){x.trigger(k,"fail",a)};if(c){for(h in c)k[h]=c[h];c.binary&&(k.responseType="arraybuffer")}k.send();return k};XMLHttpRequest.prototype.hasOwnProperty("done")||Object.defineProperty(XMLHttpRequest.prototype,"done",{enumerable:!1,value:function(f){x.bind(this,"done",function(e,a){f(a)});return this}});
XMLHttpRequest.prototype.hasOwnProperty("fail")||Object.defineProperty(XMLHttpRequest.prototype,"fail",{enumerable:!1,value:function(f){x.bind(this,"fail",function(e,a){f(a)});return this}});r.getFileExtension=function(f){var e=f.indexOf("?");-1!=e&&(f=f.substr(0,e));e=f.lastIndexOf(".");return-1==e?"":f.substr(e+1).toLowerCase()};r.loadFileAtlas=p.loadFileAtlas=function(f,e,a){var b=null;HttpRequest(f,null,function(a){a=p.processFileAtlas(a);e&&e(a);b&&b(a)},alert,a);return{done:function(a){b=a}}};
r.processFileAtlas=p.processFileAtlas=function(f){function e(){var d=b.join("\n");a[c]=d;b.length=0;c=h.substr(1)}f=f.split("\n");for(var a={},b=[],c="",d=0,g=f.length;d<g;d++){var h=f[d].trim();h.length&&("\\"==h[0]?c?e():c=h.substr(1):b.push(h))}c&&e();return a};r.hexColorToRGBA=function(){var f={white:[1,1,1],black:[0,0,0],gray:[0.501960813999176,0.501960813999176,0.501960813999176],red:[1,0,0],orange:[1,0.6470588445663452,0],pink:[1,0.7529411911964417,0.7960784435272217],green:[0,0.501960813999176,
0],lime:[0,1,0],blue:[0,0,1],violet:[0.9333333373069763,0.5098039507865906,0.9333333373069763],magenta:[1,0,1],cyan:[0,1,1],yellow:[1,1,0],brown:[0.6470588445663452,0.16470588743686676,0.16470588743686676],silver:[0.7529411911964417,0.7529411911964417,0.7529411911964417],gold:[1,0.843137264251709,0],transparent:[0,0,0,0]};return function(e,a,b){b=void 0===b?1:b;a=a||new Float32Array(4);a[3]=b;if("string"!=typeof e)return a;var c=f[e];if(void 0!==c)a.set(c),a[3]=3==a.length?b:a[3]*b;else{c=e.indexOf("rgba(");
if(-1!=c)return e=e.substr(5),e=e.split(","),a[0]=parseInt(e[0])/255,a[1]=parseInt(e[1])/255,a[2]=parseInt(e[2])/255,a[3]=parseFloat(e[3])*b,a;a[3]=b;c=e.indexOf("rgb(");if(-1!=c)return e=e.substr(3),e=e.split(","),a[0]=parseInt(e[0])/255,a[1]=parseInt(e[1])/255,a[2]=parseInt(e[2])/255,a;e=e.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,function(a,b,c,e){return b+b+c+c+e+e});b=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);if(!b)return a;a[0]=parseInt(b[1],16)/255;a[1]=parseInt(b[2],16)/255;a[2]=
parseInt(b[3],16)/255;return a}}}();var P=function(){function f(a){return a.charCodeAt(0)+(a.charCodeAt(1)<<8)+(a.charCodeAt(2)<<16)+(a.charCodeAt(3)<<24)}function e(a,b,c,d){var e=new Uint16Array(4),g=new Uint16Array(c*d),f=0,h=0,k=0,l=h=f=0,m=0,n=0,q=0,t=c/4;d/=4;for(var p=0;p<d;p++)for(var u=0;u<t;u++)k=b+4*(p*t+u),e[0]=a[k],e[1]=a[k+1],f=e[0]&31,h=e[0]&2016,l=e[0]&63488,m=e[1]&31,n=e[1]&2016,q=e[1]&63488,e[2]=5*f+3*m>>3|5*h+3*n>>3&2016|5*l+3*q>>3&63488,e[3]=5*m+3*f>>3|5*n+3*h>>3&2016|5*q+3*l>>
3&63488,f=a[k+2],h=4*p*c+4*u,g[h]=e[f&3],g[h+1]=e[f>>2&3],g[h+2]=e[f>>4&3],g[h+3]=e[f>>6&3],h+=c,g[h]=e[f>>8&3],g[h+1]=e[f>>10&3],g[h+2]=e[f>>12&3],g[h+3]=e[f>>14],f=a[k+3],h+=c,g[h]=e[f&3],g[h+1]=e[f>>2&3],g[h+2]=e[f>>4&3],g[h+3]=e[f>>6&3],h+=c,g[h]=e[f>>8&3],g[h+1]=e[f>>10&3],g[h+2]=e[f>>12&3],g[h+3]=e[f>>14];return g}function a(a){for(var b=0,c=a.length,d=0;b<c;b+=4)d=a[b],a[b]=a[b+2],a[b+2]=d}function b(b,c,d,f){var G=new Int32Array(d,0,q),H,z,B,C,D,J,L,I,x;if(G[A]!=g)return console.error("Invalid magic number in DDS header"),
0;if(!G[v]&n)return console.error("Unsupported format, must contain a FourCC code"),0;H=G[r];switch(H){case l:z=8;B=c?c.COMPRESSED_RGB_S3TC_DXT1_EXT:null;break;case m:z=16;B=c?c.COMPRESSED_RGBA_S3TC_DXT3_EXT:null;break;case p:z=16;B=c?c.COMPRESSED_RGBA_S3TC_DXT5_EXT:null;break;default:z=4,H=null,B=b.RGBA}L=1;G[t]&h&&!1!==f&&(L=Math.max(1,G[F]));C=G[y];D=G[u];J=G[s]+4;if(G[M+1]&k)for(x=0;6>x;++x)for(C=G[y],D=G[u],I=0;I<L;++I)H?(f=Math.max(4,C)/4*Math.max(4,D)/4*z,c=new Uint8Array(d,J,f),b.compressedTexImage2D(b.TEXTURE_CUBE_MAP_POSITIVE_X+
x,I,B,C,D,0,c)):(b.pixelStorei(b.UNPACK_FLIP_Y_WEBGL,!1),f=C*D*z,c=new Uint8Array(d,J,f),a(c),b.texImage2D(b.TEXTURE_CUBE_MAP_POSITIVE_X+x,I,B,C,D,0,b.RGBA,b.UNSIGNED_BYTE,c)),J+=f,C*=0.5,D*=0.5;else if(c)for(b.pixelStorei(b.UNPACK_FLIP_Y_WEBGL,!0),I=0;I<L;++I)H?(f=Math.max(4,C)/4*Math.max(4,D)/4*z,c=new Uint8Array(d,J,f),b.compressedTexImage2D(b.TEXTURE_2D,I,B,C,D,0,c)):(f=C*D*z,c=new Uint8Array(d,J,f),a(c),b.texImage2D(b.TEXTURE_2D,I,B,C,D,0,B,b.UNSIGNED_BYTE,c)),J+=f,C*=0.5,D*=0.5;else if(H==l)Math.max(4,
C),Math.max(4,D),c=new Uint16Array(d),d=e(c,J/2,C,D),b.texImage2D(b.TEXTURE_2D,0,b.RGB,C,D,0,b.RGB,b.UNSIGNED_SHORT_5_6_5,d),f&&b.generateMipmap(b.TEXTURE_2D);else return console.error("No manual decoder for",String.fromCharCode(H&255,H>>8&255,H>>16&255,H>>24&255),"and no native support"),0;return L}function c(b,c){var d=new Int32Array(b,0,q),f,G,H,z,B,C,D,J,x,I,E;if(d[A]!=g)return console.error("Invalid magic number in DDS header"),0;if(!d[v]&n)return console.error("Unsupported format, must contain a FourCC code"),
0;f=d[r];switch(f){case l:G=8;H="COMPRESSED_RGB_S3TC_DXT1_EXT";break;case m:G=16;H="COMPRESSED_RGBA_S3TC_DXT3_EXT";break;case p:G=16;H="COMPRESSED_RGBA_S3TC_DXT5_EXT";break;default:G=4,H="RGBA"}x=1;d[t]&h&&!1!==loadMipmaps&&(x=Math.max(1,d[F]));z=d[y];B=d[u];D=d[s]+4;var Q=[];if(d[M+1]&k)for(E=0;6>E;++E)for(z=d[y],B=d[u],I=0;I<x;++I)f?(C=Math.max(4,z)/4*Math.max(4,B)/4*G,new Uint8Array(b,D,C),Q.push({tex:"TEXTURE_CUBE_MAP",face:E,mipmap:I,internalFormat:H,width:z,height:B,offset:0,dataOffset:D,dataLength:C})):
(C=z*B*G,J=new Uint8Array(b,D,C),a(J),Q.push({tex:"TEXTURE_CUBE_MAP",face:E,mipmap:I,internalFormat:H,width:z,height:B,offset:0,type:"UNSIGNED_BYTE",dataOffset:D,dataLength:C})),D+=C,z*=0.5,B*=0.5;else if(c)if(f==l)Math.max(4,z),Math.max(4,B),J=new Uint16Array(b),d=e(J,D/2,z,B),Q.push({tex:"TEXTURE_2D",mipmap:0,internalFormat:"RGB",width:z,height:B,offset:0,format:"RGB",type:"UNSIGNED_SHORT_5_6_5",data:d});else return console.error("No manual decoder for",String.fromCharCode(f&255,f>>8&255,f>>16&
255,f>>24&255),"and no native support"),0;else for(I=0;I<x;++I)C=Math.max(4,z)/4*Math.max(4,B)/4*G,new Uint8Array(b,D,C),Q.push({tex:"TEXTURE_2D",mipmap:I,internalFormat:H,width:z,height:B,offset:0,type:"UNSIGNED_BYTE",dataOffset:D,dataLength:C}),D+=C,z*=0.5,B*=0.5;return Q}function d(a,c,d,e,f,g){var h=new XMLHttpRequest;h.open("GET",d,!0);h.responseType="arraybuffer";h.onload=function(){if(200==this.status){var d=new Int32Array(this.response,0,q),h=d[M+1]&k?a.TEXTURE_CUBE_MAP:a.TEXTURE_2D;a.bindTexture(h,
e);var l=b(a,c,this.response,f);a.texParameteri(h,a.TEXTURE_MAG_FILTER,a.LINEAR);a.texParameteri(h,a.TEXTURE_MIN_FILTER,1<l?a.LINEAR_MIPMAP_LINEAR:a.LINEAR);a.bindTexture(h,null);e.texture_type=h;e.width=d[y];e.height=d[u]}g&&g(e)};h.send(null);return e}var g=542327876,h=131072,k=512,n=4,l=f("DXT1"),m=f("DXT3"),p=f("DXT5"),q=31,A=0,s=1,t=2,u=3,y=4,F=7,v=20,r=21,M=27;return{dxtToRgb565:e,uploadDDSLevels:b,loadDDSTextureEx:d,loadDDSTexture:function(a,b,c,e){var f=a.createTexture();b=a.getExtension("WEBGL_compressed_texture_s3tc");
d(a,b,c,f,!0,e);return f},loadDDSTextureFromMemoryEx:function(a,c,d,e,f){var g=new Int32Array(d,0,q),h=!!(g[M+1]&k),l=h?a.TEXTURE_CUBE_MAP:a.TEXTURE_2D;a.bindTexture(l,e.handler);c=b(a,c,d,f);a.texParameteri(l,a.TEXTURE_MAG_FILTER,a.LINEAR);a.texParameteri(l,a.TEXTURE_MIN_FILTER,1<c?a.LINEAR_MIPMAP_LINEAR:a.LINEAR);h&&(a.texParameteri(l,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(l,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE));a.bindTexture(l,null);e.handler&&(e.texture_type=l,e.width=g[y],e.height=g[u]);
return e},getDDSTextureFromMemoryEx:function(a){var b=new Int32Array(a,0,q),d=b[M+1]&k?"TEXTURE_CUBE_MAP":"TEXTURE_2D",e=c(a);return{type:d,buffers:e,data:a,width:b[y],height:b[u]}}}}();"undefined"!=typeof r&&(r.DDS=P);if("undefined"==typeof glMatrix)throw"You must include glMatrix on your project";Math.clamp=function(f,e,a){return e>f?e:a<f?a:f};vec3.ZERO=vec3.fromValues(0,0,0);vec3.FRONT=vec3.fromValues(0,0,-1);vec3.UP=vec3.fromValues(0,1,0);vec3.RIGHT=vec3.fromValues(1,0,0);vec2.rotate=function(f,
e,a){var b=e[0];e=e[1];var c=Math.cos(a);a=Math.sin(a);f[0]=b*c-e*a;f[1]=b*a+e*c;return f};vec3.zero=function(f){f[0]=f[1]=f[2]=0;return f};vec3.minValue=function(f){return f[0]<f[1]&&f[0]<f[2]?f[0]:f[1]<f[2]?f[1]:f[2]};vec3.maxValue=function(f){return f[0]>f[1]&&f[0]>f[2]?f[0]:f[1]>f[2]?f[1]:f[2]};vec3.minValue=function(f){return f[0]<f[1]&&f[0]<f[2]?f[0]:f[1]<f[2]?f[1]:f[2]};vec3.addValue=function(f,e,a){f[0]=e[0]+a;f[1]=e[1]+a;f[2]=e[2]+a};vec3.subValue=function(f,e,a){f[0]=e[0]-a;f[1]=e[1]-a;
f[2]=e[2]-a};vec3.toArray=function(f){return[f[0],f[1],f[2]]};vec3.rotateX=function(f,e,a){var b=e[1],c=e[2],d=Math.cos(a);a=Math.sin(a);f[0]=e[0];f[1]=b*d-c*a;f[2]=b*a+c*d;return f};vec3.rotateY=function(f,e,a){var b=e[0],c=e[2],d=Math.cos(a);a=Math.sin(a);f[0]=b*d-c*a;f[1]=e[1];f[2]=b*a+c*d;return f};vec3.rotateZ=function(f,e,a){var b=e[0],c=e[1],d=Math.cos(a);a=Math.sin(a);f[0]=b*d-c*a;f[1]=b*a+c*d;f[2]=e[2];return f};vec2.perpdot=function(f,e){return f[1]*e[0]+-f[0]*e[1]};vec2.computeSignedAngle=
function(f,e){return Math.atan2(vec2.perpdot(f,e),vec2.dot(f,e))};vec2.random=function(f){f[0]=Math.random();f[1]=Math.random();return f};vec3.angle=function(f,e){return Math.acos(vec3.dot(f,e))};vec3.random=function(f){f[0]=Math.random();f[1]=Math.random();f[2]=Math.random();return f};vec4.random=function(f){f[0]=Math.random();f[1]=Math.random();f[2]=Math.random();f[3]=Math.random();return f};vec3.polarToCartesian=function(f,e){var a=e[0],b=e[1],c=e[2];f[0]=a*Math.cos(b)*Math.sin(c);f[1]=a*Math.sin(b);
f[2]=a*Math.cos(b)*Math.cos(c);return f};mat3.IDENTITY=mat3.create();mat4.IDENTITY=mat4.create();mat4.toArray=function(f){return[f[0],f[1],f[2],f[3],f[4],f[5],f[6],f[7],f[8],f[9],f[10],f[11],f[12],f[13],f[14],f[15]]};mat4.setUpAndOrthonormalize=function(f,e,a){e!=f&&mat4.copy(f,e);e=f.subarray(0,3);vec3.normalize(f.subarray(4,7),a);f=f.subarray(8,11);vec3.cross(e,a,f);vec3.normalize(e,e);vec3.cross(f,e,a);vec3.normalize(f,f)};mat4.multiplyVec3=function(f,e,a){var b=a[0],c=a[1];a=a[2];f[0]=e[0]*b+
e[4]*c+e[8]*a+e[12];f[1]=e[1]*b+e[5]*c+e[9]*a+e[13];f[2]=e[2]*b+e[6]*c+e[10]*a+e[14];return f};mat4.projectVec3=function(f,e,a){var b=a[0],c=a[1];a=a[2];var d=e[1]*b+e[5]*c+e[9]*a+e[13],g=e[2]*b+e[6]*c+e[10]*a+e[14],h=e[3]*b+e[7]*c+e[11]*a+e[15];f[0]=((e[0]*b+e[4]*c+e[8]*a+e[12])/h+1)/2;f[1]=(d/h+1)/2;f[2]=(g/h+1)/2;return f};vec3.project=function(f,e,a,b){b=b||gl.viewport_data;var c=e[0],d=e[1];e=e[2];var g=a[3]*c+a[7]*d+a[11]*e+a[15],h=1-((a[1]*c+a[5]*d+a[9]*e+a[13])/g+1)/2;f[0]=((a[0]*c+a[4]*d+
a[8]*e+a[12])/g+1)/2*b[2]+b[0];f[1]=h*b[3]+b[1];f[2]=g;return f};var S=mat4.create(),E=vec4.create();vec3.unproject=function(f,e,a,b){E[0]=2*(e[0]-b[0])/b[2]-1;E[1]=2*(e[1]-b[1])/b[3]-1;E[2]=2*e[2]-1;E[3]=1;if(!mat4.invert(S,a))return null;vec4.transformMat4(E,E,S);if(0===E[3])return null;f[0]=E[0]/E[3];f[1]=E[1]/E[3];f[2]=E[2]/E[3];return f};mat4.rotateVec3=function(f,e,a){var b=a[0],c=a[1];a=a[2];f[0]=e[0]*b+e[4]*c+e[8]*a;f[1]=e[1]*b+e[5]*c+e[9]*a;f[2]=e[2]*b+e[6]*c+e[10]*a;return f};mat4.fromTranslationFrontTop=
function(f,e,a,b){vec3.cross(f.subarray(0,3),a,b);f.set(b,4);f.set(a,8);f.set(e,12);return f};mat4.translationMatrix=function(f){var e=mat4.create();e[12]=f[0];e[13]=f[1];e[14]=f[2];return e};mat4.setTranslation=function(f,e){f[12]=e[0];f[13]=e[1];f[14]=e[2];return f};mat4.getTranslation=function(f,e){f[0]=e[12];f[1]=e[13];f[2]=e[14];return f};mat4.toRotationMat4=function(f,e){mat4.copy(f,e);f[12]=f[13]=f[14]=0;return f};mat4.swapRows=function(f,e,a,b){if(f!=e)return mat4.copy(f,e),f[4*a]=e[4*b],
f[4*a+1]=e[4*b+1],f[4*a+2]=e[4*b+2],f[4*a+3]=e[4*b+3],f[4*b]=e[4*a],f[4*b+1]=e[4*a+1],f[4*b+2]=e[4*a+2],f[4*b+3]=e[4*a+3],f;e=new Float32Array(matrix.subarray(4*a,5*a));matrix.set(matrix.subarray(4*b,5*b),4*a);matrix.set(e,4*b);return f};mat4.scaleAndAdd=function(f,e,a,b){f[0]=e[0]+a[0]*b;f[1]=e[1]+a[1]*b;f[2]=e[2]+a[2]*b;f[3]=e[3]+a[3]*b;f[4]=e[4]+a[4]*b;f[5]=e[5]+a[5]*b;f[6]=e[6]+a[6]*b;f[7]=e[7]+a[7]*b;f[8]=e[8]+a[8]*b;f[9]=e[9]+a[9]*b;f[10]=e[10]+a[10]*b;f[11]=e[11]+a[11]*b;f[12]=e[12]+a[12]*
b;f[13]=e[13]+a[13]*b;f[14]=e[14]+a[14]*b;f[15]=e[15]+a[15]*b;return f};quat.toEuler=function(f,e){var a=Math.atan2(2*e[1]*e[3]-2*e[0]*e[2],1-2*e[1]*e[1]-2*e[2]*e[2]),b=Math.asin(2*e[0]*e[1]+2*e[2]*e[3]),c=Math.atan2(2*e[0]*e[3]-2*e[1]*e[2],1-2*e[0]*e[0]-2*e[2]*e[2]);f||(f=vec3.create());vec3.set(f,a,b,c);return f};quat.fromEuler=function(f,e){var a=e[0],b=e[1],c=e[2],d=Math.cos(a),g=Math.cos(b),h=Math.cos(c),a=Math.sin(a),b=Math.sin(b),c=Math.sin(c),k=0.5*Math.sqrt(1+d*g+d*h-a*b*c+g*h);quat.set(f,
(g*c+d*c+a*b*h)/(4*k),(a*g+a*h+d*b*c)/(4*k),(-a*c+d*b*h+b)/(4*k),k);return f};quat.fromMat4=function(f,e){var a=e[0]+e[5]+e[10];if(0<a){var b=Math.sqrt(a+1);f[3]=0.5*b;b=0.5/b;f[0]=(e[9]-e[6])*b;f[1]=(e[2]-e[8])*b;f[2]=(e[4]-e[1])*b}else{a=0;e[5]>e[0]&&(a=1);e[10]>e[4*a+a]&&(a=2);var c=(a+1)%3,d=(c+1)%3,b=Math.sqrt(e[4*a+a]-e[4*c+c]-e[4*d+d]+1);f[a]=0.5*b;b=0.5/b;f[3]=(e[4*d+c]-e[4*c+d])*b;f[c]=(e[4*c+a]+e[4*a+c])*b;f[d]=(e[4*d+a]+e[4*a+d])*b}quat.normalize(f,f)};quat.fromMat4.lookAt=function(){var f=
vec3.create();return function(e,a,b){b=vec3.dot(vec3.FRONT,a);if(1E-6>Math.abs(b- -1))return e.set(vec3.UP),e[3]=Math.PI,e;if(1E-6>Math.abs(b-1))return quat.identity(e);b=Math.acos(b);vec3.cross(f,vec3.FRONT,a);vec3.normalize(f,f);quat.setAxisAngle(e,f,b);return e}}();p.Indexer=function(){this.unique=[];this.indices=[];this.map={}};p.Indexer.prototype={add:function(f){var e=JSON.stringify(f);e in this.map||(this.map[e]=this.unique.length,this.unique.push(f));return this.map[e]}};r.Buffer=p.Buffer=
function(f,e,a,b,c){null!==c&&(c=c||r.gl);this.buffer=null;this.target=f;this.gl=c;this.data=e;this.spacing=a||3;this.data&&this.gl&&this.upload(b)};p.Buffer.prototype.forEach=function(f){for(var e=this.data,a=0,b=this.spacing,c=e.length;a<c;a+=b)f(e.subarray(a,a+b),a);return this};p.Buffer.prototype.applyTransform=function(f){for(var e=this.data,a=0,b=this.spacing,c=e.length;a<c;a+=b)b=e.subarray(a,a+b),vec3.transformMat4(b,b,f);return this};p.Buffer.prototype.upload=function(f){var e=this.spacing||
3,a=this.gl;if(a){if(!this.data)throw"No data supplied";var b=this.data;if(!b.buffer)throw"Buffers must be typed arrays";if(this.buffer=this.buffer||a.createBuffer()){this.buffer.length=b.length;this.buffer.spacing=e;switch(b.constructor){case Int8Array:this.buffer.gl_type=a.BYTE;break;case Uint8ClampedArray:case Uint8Array:this.buffer.gl_type=a.UNSIGNED_BYTE;break;case Int16Array:this.buffer.gl_type=a.SHORT;break;case Uint16Array:this.buffer.gl_type=a.UNSIGNED_SHORT;break;case Int32Array:this.buffer.gl_type=
a.INT;break;case Uint32Array:this.buffer.gl_type=a.UNSIGNED_INT;break;case Float32Array:this.buffer.gl_type=a.FLOAT;break;default:throw"unsupported buffer type";}a.bindBuffer(this.target,this.buffer);a.bufferData(this.target,b,f||this.stream_type||a.STATIC_DRAW)}}};p.Buffer.prototype.compile=p.Buffer.prototype.upload;p.Buffer.prototype.setData=function(f,e){if(!f.buffer)throw"Data must be typed array";e=e||0;if(this.data){if(this.data.length<f.length)throw"buffer is not big enough, you cannot set data to a smaller buffer";
if(this.data!=f)if(this.data.length==f.length)this.data.set(f),this.upload();else{var a=new Uint8Array(f.buffer,f.buffer.byteOffset,f.buffer.byteLength);(new Uint8Array(this.data.buffer)).set(a,e);this.uploadRange(e,a.length)}}else this.data=f,this.upload()};p.Buffer.prototype.uploadRange=function(f,e){if(!this.data)throw"No data stored in this buffer";if(!this.data.buffer)throw"Buffers must be typed arrays";var a=new Uint8Array(this.data.buffer,f,e),b=this.gl;b.bindBuffer(this.target,this.buffer);
b.bufferSubData(this.target,f,a)};p.Buffer.prototype.clone=function(f){var e=new p.Buffer;if(f)for(var a in this)e[a]=this[a];else this.target&&(e.target=this.target),this.gl&&(e.gl=this.gl),this.spacing&&(e.spacing=this.spacing),this.data&&(e.data=new r[this.data.constructor](this.data),e.upload());return e};r.Mesh=p.Mesh=function(f,e,a,b){null!==b&&(this.gl=b=b||r.gl);this._context_id=b.context_id;this.vertexBuffers={};this.indexBuffers={};(f||e)&&this.addBuffers(f,e,a?a.stream_type:null);if(a)for(var c in a)this[c]=
a[c]};Mesh.common_buffers={vertices:{spacing:3,attribute:"a_vertex"},vertices2D:{spacing:2,attribute:"a_vertex2D"},normals:{spacing:3,attribute:"a_normal"},coords:{spacing:2,attribute:"a_coord"},coords1:{spacing:2,attribute:"a_coord1"},coords2:{spacing:2,attribute:"a_coord2"},colors:{spacing:4,attribute:"a_color"},tangents:{spacing:3,attribute:"a_tangent"},bone_indices:{spacing:4,attribute:"a_bone_indices",type:Uint8Array},weights:{spacing:4,attribute:"a_weights"},extra:{spacing:1,attribute:"a_extra"},
extra2:{spacing:2,attribute:"a_extra2"},extra3:{spacing:3,attribute:"a_extra3"},extra4:{spacing:4,attribute:"a_extra4"}};Mesh.default_datatype=Float32Array;Mesh.prototype.addBuffer=function(f,e){e.target==gl.ARRAY_BUFFER?this.vertexBuffers[f]=e:this.indexBuffers[f]=e;e.attribute||(e.attribute=p.Mesh.common_buffers[f].attribute)};Mesh.prototype.addBuffers=function(f,e,a){var b=0;this.vertexBuffers.vertices&&(b=this.vertexBuffers.vertices.data.length/3);for(var c in f){var d=f[c];if(d){if(d.constructor==
p.Buffer)d=d.data;else if("number"!=typeof d[0]){for(var g=[],h=0,k=1E4;h<d.length;h+=k)g=Array.prototype.concat.apply(g,d.slice(h,h+k));d=g}g=p.Mesh.common_buffers[c];d.constructor===Array&&(h=p.Mesh.default_datatype,g&&g.type&&(h=g.type),d=new h(d));"vertices"==c&&(b=d.length/3);h=d.length/b;g&&g.spacing&&(h=g.spacing);k="a_"+c;g&&g.attribute&&(k=g.attribute);this.createVertexBuffer(c,k,h,d,a)}}if(e)for(c in e)if(d=e[c]){d.constructor==p.Buffer&&(d=d.data);if("number"!=typeof d[0]){g=[];c=0;for(k=
1E4;c<d.length;c+=k)g=Array.prototype.concat.apply(g,d.slice(c,c+k));d=g}d.constructor===Array&&(h=Uint16Array,65536<b&&(h=Uint32Array),d=new h(d));this.createIndexBuffer(c,d)}};Mesh.prototype.createVertexBuffer=function(f,e,a,b,c){var d=p.Mesh.common_buffers[f];!e&&d&&(e=d.attribute);if(!e)throw"Buffer added to mesh without attribute name";!a&&d&&(a=d&&d.spacing?d.spacing:3);if(!b){b=this.getNumVertices();if(!b)throw"Cannot create an empty buffer in a mesh without vertices (vertices are needed to know the size)";
b=new p.Mesh.default_datatype(b*a)}if(!b.buffer)throw"Buffer data MUST be typed array";a=this.vertexBuffers[f]=new p.Buffer(gl.ARRAY_BUFFER,b,a,c,this.gl);a.name=f;a.attribute=e;return a};Mesh.prototype.removeVertexBuffer=function(f){this.vertexBuffers[f]&&delete this.vertexBuffers[f]};Mesh.prototype.getVertexBuffer=function(f){return this.vertexBuffers[f]};Mesh.prototype.createIndexBuffer=function(f,e,a){return this.indexBuffers[f]=new p.Buffer(gl.ELEMENT_ARRAY_BUFFER,e,0,a,this.gl)};Mesh.prototype.getBuffer=
function(f){return this.vertexBuffers[f]};Mesh.prototype.getIndexBuffer=function(f){return this.indexBuffers[f]};Mesh.prototype.upload=function(f){for(var e in this.vertexBuffers){var a=this.vertexBuffers[e];a.upload(f)}for(var b in this.indexBuffers)a=this.indexBuffers[b],a.upload()};Mesh.prototype.compile=Mesh.prototype.upload;Mesh.prototype.deleteBuffers=function(){for(var f in this.vertexBuffers){var e=this.vertexBuffers[f];this.gl.deleteBuffer(e.buffer)}this.vertexBuffers={};for(f in this.indexBuffers)e=
this.indexBuffers[f],this.gl.deleteBuffer(e.buffer);this.indexBuffers[f]={}};Mesh.prototype.bindBuffers=function(f){for(var e in this.vertexBuffers){var a=this.vertexBuffers[e],b=f.attributes[a.attribute||e];null!=b&&a.buffer&&(gl.bindBuffer(gl.ARRAY_BUFFER,a.buffer),gl.enableVertexAttribArray(b),gl.vertexAttribPointer(b,a.buffer.spacing,a.buffer.gl_type,!1,0,0))}};Mesh.prototype.unbindBuffers=function(f){for(var e in this.vertexBuffers){var a=this.vertexBuffers[e],b=a.attribute||e;null!=f.attributes[b]&&
a.buffer&&gl.disableVertexAttribArray(f.attributes[b])}};Mesh.prototype.clone=function(f){f=f||r.gl;var e={},a={},b;for(b in this.vertexBuffers){var c=this.vertexBuffers[b];e[b]=new c.data.constructor(c.data)}for(b in this.indexBuffers)c=this.indexBuffers[b],a[b]=new c.data.constructor(c.data);return new p.Mesh(e,a,void 0,f)};Mesh.prototype.cloneShared=function(f){f=f||r.gl;return new p.Mesh(this.vertexBuffers,this.indexBuffers,void 0,f)};Mesh.prototype.toObject=function(){var f={},e={},a;for(a in this.vertexBuffers){var b=
this.vertexBuffers[a];f[a]={spacing:b.spacing,data:new b.data.constructor(b.data)}}for(a in this.indexBuffers)b=this.indexBuffers[a],e[a]={data:new b.data.constructor(b.data)};return{vertexBuffers:f,indexBuffers:e}};Mesh.prototype.generateMetadata=function(){var f={},e=this.vertexBuffers.vertices.data,a=this.indexBuffers.triangles.data;f.vertices=e.length/3;f.faces=a?a.length/3:e.length/9;f.indexed=!!this.metadata.faces;this.metadata=f};Mesh.prototype.toJSON=function(){return""};Mesh.prototype.computeWireframe=
function(){var f=this.indexBuffers.triangles,e=this.vertexBuffers.vertices.data.length/3;if(f){for(var a=f.data,b=new p.Indexer,f=0;f<a.length;f+=3)for(var c=a.subarray(f,f+3),d=0;d<c.length;d++){var g=c[d],h=c[(d+1)%c.length];b.add([Math.min(g,h),Math.max(g,h)])}a=b.unique;b=65536<e?new Uint32Array(2*a.length):new Uint16Array(2*a.length);f=0;for(e=a.length;f<e;++f)b.set(a[f],2*f)}else for(f=e/3,b=65536<e?new Uint32Array(6*f):new Uint16Array(6*f),f=0;f<e;f+=3)b[2*f]=f,b[2*f+1]=f+1,b[2*f+2]=f+1,b[2*
f+3]=f+2,b[2*f+4]=f+2,b[2*f+5]=f;this.createIndexBuffer("wireframe",b);return this};Mesh.prototype.flipNormals=function(f){var e=this.vertexBuffers.normals;if(e){for(var a=e.data,b=a.length,c=0;c<b;++c)a[c]*=-1;e.upload(f);this.indexBuffers.triangles||this.computeIndices();e=this.indexBuffers.triangles;a=e.data;b=a.length;for(c=0;c<b;c+=3){var d=a[c];a[c]=a[c+1];a[c+1]=d}e.upload(f)}};Mesh.prototype.computeIndices=function(){var f=[],e=[],a=[],b=[],c=this.vertexBuffers.normals,d=this.vertexBuffers.coords,
g=this.vertexBuffers.vertices.data,h=null;c&&(h=c.data);c=null;d&&(c=d.data);for(var d={},k=g.length/3,n=0;n<k;++n){var l=g.subarray(3*n,3*(n+1)),m=1E3*l[0]|0,w=0,q=d[m];if(q)for(var A=q.length;w<A;w++)if(0.01>vec3.sqrDist(l,f[q[w]])){b.push(w);break}q&&w!=A||(f.push(l),d[m]?d[m].push(w):d[m]=[w],h&&e.push(h.subarray(3*n,3*(n+1))),c&&a.push(c.subarray(2*n,2*(n+1))),b.push(w))}this.vertexBuffers={};this.createVertexBuffer("vertices",p.Mesh.common_buffers.vertices.attribute,3,linearizeArray(f));h&&
this.createVertexBuffer("normals",p.Mesh.common_buffers.normals.attribute,3,linearizeArray(e));c&&this.createVertexBuffer("coords",p.Mesh.common_buffers.coords.attribute,2,linearizeArray(a));this.createIndexBuffer("triangles",b)};Mesh.prototype.computeNormals=function(f){var e=this.vertexBuffers.vertices.data,a=new Float32Array(e.length),b=null;this.indexBuffers.triangles&&(b=this.indexBuffers.triangles.data);for(var c=p.temp_vec3,d=p.temp2_vec3,g,h,k,n,l,m,w=b?b.length:e.length,q=0;q<w;q+=3)b?(g=
b[q],h=b[q+1],k=b[q+2],n=e.subarray(3*g,3*g+3),l=e.subarray(3*h,3*h+3),m=e.subarray(3*k,3*k+3),g=a.subarray(3*g,3*g+3),h=a.subarray(3*h,3*h+3),k=a.subarray(3*k,3*k+3)):(n=e.subarray(3*q,3*q+3),l=e.subarray(3*q+3,3*q+6),m=e.subarray(3*q+6,3*q+9),g=a.subarray(3*q,3*q+3),h=a.subarray(3*q+3,3*q+6),k=a.subarray(3*q+6,3*q+9)),vec3.sub(c,l,n),vec3.sub(d,m,n),vec3.cross(c,c,d),vec3.normalize(c,c),vec3.add(g,g,c),vec3.add(h,h,c),vec3.add(k,k,c);if(b)for(q=0,w=a.length;q<w;q+=3)e=a.subarray(q,q+3),vec3.normalize(e,
e);if(w=this.vertexBuffers.normals)w.data=a,w.upload(f);else return this.createVertexBuffer("normals",p.Mesh.common_buffers.normals.attribute,3,a);return w};Mesh.prototype.computeTangents=function(){var f=this.vertexBuffers.vertices.data,e=this.vertexBuffers.normals.data,a=this.vertexBuffers.coords.data,b=this.indexBuffers.triangles.data;if(f&&e&&a){var c=f.length/3,d=new Float32Array(4*c),g=new Float32Array(6*c),c=g.subarray(3*c),h,k,n=vec3.create(),l=vec3.create(),m=vec3.create(),p=vec3.create();
h=0;for(k=b.length;h<k;h+=3){var q=b[h],A=b[h+1],s=b[h+2],t=f.subarray(3*q,3*q+3),u=f.subarray(3*A,3*A+3),y=f.subarray(3*s,3*s+3),F=a.subarray(2*q,2*q+2),v=a.subarray(2*A,2*A+2),r=a.subarray(2*s,2*s+2),M=u[0]-t[0],N=y[0]-t[0],x=u[1]-t[1],E=y[1]-t[1],u=u[2]-t[2],t=y[2]-t[2],y=v[0]-F[0],K=r[0]-F[0],v=v[1]-F[1],F=r[1]-F[1],r=y*F-K*v,r=1E-9>Math.abs(r)?0:1/r;vec3.copy(n,[(F*M-v*N)*r,(F*x-v*E)*r,(F*u-v*t)*r]);vec3.copy(l,[(y*N-K*M)*r,(y*E-K*x)*r,(y*t-K*u)*r]);vec3.add(g.subarray(3*q,3*q+3),g.subarray(3*
q,3*q+3),n);vec3.add(g.subarray(3*A,3*A+3),g.subarray(3*A,3*A+3),n);vec3.add(g.subarray(3*s,3*s+3),g.subarray(3*s,3*s+3),n);vec3.add(c.subarray(3*q,3*q+3),c.subarray(3*q,3*q+3),l);vec3.add(c.subarray(3*A,3*A+3),c.subarray(3*A,3*A+3),l);vec3.add(c.subarray(3*s,3*s+3),c.subarray(3*s,3*s+3),l)}h=0;for(k=f.length;h<k;h+=3)f=e.subarray(h,h+3),a=g.subarray(h,h+3),vec3.subtract(m,a,vec3.scale(m,f,vec3.dot(f,a))),vec3.normalize(m,m),f=0>vec3.dot(vec3.cross(p,f,a),c.subarray(h,h+3))?-1:1,d.set([m[0],m[1],
m[2],f],h/3*4);this.createVertexBuffer("tangents",Mesh.common_buffers.tangents.attribute,4,d)}};Mesh.prototype.getNumVertices=function(){var f=this.vertexBuffers.vertices;return f?f.data.length/f.spacing:0};Mesh.computeBounding=function(f,e){if(f){for(var a=vec3.clone(f.subarray(0,3)),b=vec3.clone(f.subarray(0,3)),c,d=3;d<f.length;d+=3)c=f.subarray(d,d+3),vec3.min(a,c,a),vec3.max(b,c,b);a=vec3.add(vec3.create(),a,b);vec3.scale(a,a,0.5);b=vec3.subtract(vec3.create(),b,a);return BBox.setCenterHalfsize(e||
BBox.create(),a,b)}};Mesh.prototype.getBoundingBox=function(){this.bounding||this.updateBounding();return this.bounding};Mesh.prototype.updateBounding=function(){var f=this.vertexBuffers.vertices.data;f&&(this.bounding=p.Mesh.computeBounding(f,this.bounding))};Mesh.prototype.setBounding=function(f,e){this.bounding=BBox.setCenterHalfsize(this.bounding||BBox.create(),f,e)};Mesh.prototype.freeData=function(){for(var f in this.vertexBuffers)this.vertexBuffers[f].data=null,delete this[this.vertexBuffers[f].name];
for(var e in this.indexBuffers)this.indexBuffers[e].data=null,delete this[this.indexBuffers[e].name]};Mesh.prototype.configure=function(f,e){var a={},b={};e=e||{};for(var c in f)f[c]&&("indices"==c||"lines"==c||"wireframe"==c||"triangles"==c?b[c]=f[c]:p.Mesh.common_buffers[c]?a[c]=f[c]:e[c]=f[c]);this.addBuffers(a,b,e.stream_type);for(b in e)this[b]=e[b]};Mesh.prototype.totalMemory=function(){var f=0,e;for(e in this.vertexBuffers)f+=this.vertexBuffers[e].data.buffer.byteLength;for(e in this.indexBuffers)f+=
this.indexBuffers[e].data.buffer.byteLength;return f};Mesh.prototype.simplify=function(){var f=this.getBoundingBox(),e=BBox.getMin(f),f=BBox.getHalfsize(f),f=vec3.scale(vec3.create(),f,2),a=new p.Mesh,b=vec3.create(),c;for(c in this.vertexBuffers){var d=this.vertexBuffers[c].data,g=new Float32Array(d.length);if("vertices"==c)for(var h=0,k=d.length;h<k;h+=3){var n=d.subarray(h,h+3);vec3.sub(b,n,e);vec3.div(b,b,f);b[0]=Math.round(256*b[0])/256;b[1]=Math.round(256*b[1])/256;b[2]=Math.round(256*b[2])/
256;vec3.mul(b,b,f);vec3.add(b,b,e);g.set(b,h)}a.addBuffer()}};Mesh.load=function(f,e,a,b){e=e||{};e.no_gl&&(b=null);a=a||new p.Mesh(null,null,null,b);a.configure(f,e);return a};Mesh.mergeMeshes=function(f,e){function a(a,b,c,d){for(c=b+c;b<c;b+=3){var e=a.subarray(b,b+3);vec3.transformMat4(e,e,d)}}function b(a,b,c,d){for(c=b+c;b<c;b+=2){var e=a.subarray(b,b+2);vec2.transformMat3(e,e,d)}}function c(a,b,c,d){for(c=b+c;b<c;++b)a[b]+=d}e=e||{};for(var d={},g={},h={},k=[],n=0,l=0;l<f.length;++l){var m=
f[l],w=m.mesh;k.push(n);var n=n+w.vertexBuffers.vertices.data.length/3,q;for(q in w.vertexBuffers)d[q]=d[q]?d[q]+w.vertexBuffers[q].data.length:w.vertexBuffers[q].data.length;for(q in w.indexBuffers)g[q]=g[q]?g[q]+w.indexBuffers[q].data.length:w.indexBuffers[q].data.length}for(q in d)l=e[q],null===l?delete d[q]:(l||(l=Float32Array),d[q]=new l(d[q]),h[q]=0);for(q in g)g[q]=new Uint32Array(g[q]),h[q]=0;for(l=0;l<f.length;++l){m=f[l];w=m.mesh;for(q in w.vertexBuffers)d[q]&&(d[q].set(w.vertexBuffers[q].data,
h[q]),m[q+"_matrix"]&&(n=m[q+"_matrix"],16==n.length?a(d[q],h[q],w.vertexBuffers[q].data.length,n):9==n.length&&b(d[q],h[q],w.vertexBuffers[q].data.length,n)),h[q]+=w.vertexBuffers[q].data.length);for(q in w.indexBuffers)g[q].set(w.indexBuffers[q].data,h[q]),c(g[q],h[q],w.indexBuffers[q].data.length,k[l]),h[q]+=w.indexBuffers[q].data.length}return"undefined"!=typeof gl?new p.Mesh(d,g):{vertexBuffers:d,indexBuffers:g}};Mesh.parsers={};Mesh.encoders={};Mesh.fromURL=function(f,e,a,b){b=b||{};a=a||r.gl;
var c=new p.Mesh(void 0,void 0,void 0,a);c.ready=!1;HttpRequest(f,null,function(a){var b=f.lastIndexOf("."),b=f.substr(b+1);c.parse(a,b);delete c.ready;e&&e.call(c,c,f)},function(a){e&&e(null)},b);return c};Mesh.prototype.parse=function(f,e){e=e.toLowerCase();var a=p.Mesh.parsers[e];if(a)return a.call(null,f,{mesh:this});throw"GL.Mesh.parse: no parser found for format "+e;};Mesh.prototype.encode=function(f,e){f=f.toLowerCase();var a=p.Mesh.encoders[f];if(a)return a.call(null,this,e);throw"GL.Mesh.encode: no encoder found for format "+
f;};Mesh.getScreenQuad=function(f){f=f||r.gl;var e=f.meshes[":screen_quad"];if(e)return e;var e=new Float32Array([0,0,0,1,1,0,0,1,0,0,0,0,1,0,0,1,1,0]),a=new Float32Array([0,0,1,1,0,1,0,0,1,0,1,1]),e=new p.Mesh({vertices:e,coords:a},void 0,void 0,f);return f.meshes[":screen_quad"]=e};Mesh.plane=function(f,e){f=f||{};f.triangles=[];var a=f.detailX||f.detail||1,b=f.detailY||f.detail||1,c=f.width||f.size||1,d=f.height||f.size||1,g=f.xz,c=0.5*c,d=0.5*d,h=[],k=[],n=[],l=[],m=vec3.fromValues(0,0,1);g&&
m.set([0,1,0]);for(var w=0;w<=b;w++)for(var q=w/b,r=0;r<=a;r++){var s=r/a;g?k.push((2*s-1)*c,0,-(2*q-1)*d):k.push((2*s-1)*c,(2*q-1)*d,0);n&&n.push(s,q);l&&l.push(m[0],m[1],m[2]);r<a&&w<b&&(s=r+w*(a+1),g?(h.push(s+1,s+a+1,s),h.push(s+1,s+a+2,s+a+1)):(h.push(s,s+1,s+a+1),h.push(s+a+1,s+1,s+a+2)))}a=BBox.fromCenterHalfsize([0,0,0],g?[c,0,d]:[c,d,0]);return p.Mesh.load({vertices:k,normals:l,coords:n,triangles:h},{bounding:a},e)};Mesh.plane2D=function(f,e){var a=new Float32Array([-1,1,1,-1,1,1,-1,1,-1,
-1,1,-1]),b=new Float32Array([0,1,1,0,1,1,0,1,0,0,1,0]);if(f&&f.size)for(var c=0.5*f.size,d=0;d<a.length;++d)a[d]*=c;return new p.Mesh({vertices2D:a,coords:b},null,e)};Mesh.point=function(f){return new p.Mesh({vertices:[0,0,0]})};Mesh.cube=function(f,e){f=f||{};var a=0.5*(f.size||1),b={};b.vertices=new Float32Array([-1,1,-1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,1,1,-1,1,1,1,1,-1,1,1,1,-1,1,-1,1,1,-1,-1,-1,1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,1,-1,-1,-1,-1,-1,-1,
1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,1,1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,-1,1,-1,1,-1,-1,1]);for(var c=0,d=b.vertices.length;c<d;++c)b.vertices[c]*=a;b.normals=new Float32Array([-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0]);b.coords=new Float32Array([0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,0,1,1,0,1,1,0,1,
0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0]);f.wireframe&&(b.wireframe=new Uint16Array([0,2,2,5,5,4,4,0,6,7,7,10,10,11,11,6,0,6,2,7,5,10,4,11]));f.bounding=BBox.fromCenterHalfsize([0,0,0],[a,a,a]);return p.Mesh.load(b,f,e)};Mesh.box=function(f,e){f=f||{};var a=f.sizex||1,b=f.sizey||1,c=f.sizez||1,a=0.5*a,b=0.5*b,c=0.5*c,d={};d.vertices=new Float32Array([-1,1,-1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,1,1,-1,1,1,1,1,-1,1,1,1,-1,1,-1,1,1,-1,-1,-1,1,1,1,-1,1,1,1,
1,-1,1,1,-1,-1,1,1,-1,1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,1,1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,-1,1,-1,1,-1,-1,1]);for(var g=0,h=d.vertices.length;g<h;g+=3)d.vertices[g]*=a,d.vertices[g+1]*=b,d.vertices[g+2]*=c;d.normals=new Float32Array([-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,
0,-1,0,0,-1,0,0,-1,0]);d.coords=new Float32Array([0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0]);f.wireframe&&(d.wireframe=new Uint16Array([0,2,2,5,5,4,4,0,6,7,7,10,10,11,11,6,0,6,2,7,5,10,4,11]));f.bounding=BBox.fromCenterHalfsize([0,0,0],[a,b,c]);return p.Mesh.load(d,f,e)};Mesh.circle=function(f,e){f=f||{};var a=f.size||f.radius||1,b=Math.ceil(f.slices||24),c=f.xz||!1,d=f.empty||!1;3>b&&(b=3);var g=
2*Math.PI/b,h=vec3.create(),k=vec3.create(),n=vec3.fromValues(0,0,1),l=vec2.fromValues(0.5,0.5),m=vec2.create();c&&n.set([0,1,0]);var w=c?2:1,q=new Float32Array(3*(b+1)),r=new Float32Array(3*(b+1)),s=new Float32Array(2*(b+1)),t=null;q.set(h,0);r.set(n,0);s.set(l,0);for(h=l=t=0;h<b;++h)t=Math.sin(g*h),l=Math.cos(g*h),k[0]=t*a,k[w]=l*a,m[0]=0.5*t+0.5,m[1]=0.5*l+0.5,q.set(k,3*h+3),r.set(n,3*h+3),s.set(m,2*h+2);if(d)q=q.subarray(3),r=q.subarray(3),s=q.subarray(2),t=null;else{t=new Uint16Array(3*b);d=
2;g=1;c&&(d=1,g=2);for(h=0;h<b-1;++h)t[3*h]=0,t[3*h+1]=h+d,t[3*h+2]=h+g;t[3*h]=0;c?(t[3*h+1]=h+1,t[3*h+2]=1):(t[3*h+1]=1,t[3*h+2]=h+1)}f.bounding=BBox.fromCenterHalfsize([0,0,0],c?[a,0,a]:[a,a,0]);a={vertices:q,normals:r,coords:s,triangles:t};if(f.wireframe){c=new Uint16Array(2*b);for(h=0;h<b;h++)c[2*h]=h,c[2*h+1]=h+1;c[0]=b;a.wireframe=c}return p.Mesh.load(a,f,e)};Mesh.cylinder=function(f,e){f=f||{};for(var a=f.radius||f.size||1,b=f.height||f.size||2,c=f.subdivisions||64,d=new Float32Array(36*c),
g=new Float32Array(36*c),h=new Float32Array(24*c),k=2*Math.PI/c,n=null,l=0;l<c;++l){var m=l*k,n=[Math.sin(m),0,Math.cos(m)];d.set([n[0]*a,0.5*b,n[2]*a],18*l);g.set(n,18*l);h.set([l/c,1],12*l);n=[Math.sin(m),0,Math.cos(m)];d.set([n[0]*a,-0.5*b,n[2]*a],18*l+3);g.set(n,18*l+3);h.set([l/c,0],12*l+2);n=[Math.sin(m+k),0,Math.cos(m+k)];d.set([n[0]*a,-0.5*b,n[2]*a],18*l+6);g.set(n,18*l+6);h.set([(l+1)/c,0],12*l+4);n=[Math.sin(m+k),0,Math.cos(m+k)];d.set([n[0]*a,0.5*b,n[2]*a],18*l+9);g.set(n,18*l+9);h.set([(l+
1)/c,1],12*l+6);n=[Math.sin(m),0,Math.cos(m)];d.set([n[0]*a,0.5*b,n[2]*a],18*l+12);g.set(n,18*l+12);h.set([l/c,1],12*l+8);n=[Math.sin(m+k),0,Math.cos(m+k)];d.set([n[0]*a,-0.5*b,n[2]*a],18*l+15);g.set(n,18*l+15);h.set([(l+1)/c,0],12*l+10)}var n=18*l,p=12*l;if(!1===f.caps)d=d.subarray(0,n),g=g.subarray(0,n),h=h.subarray(0,p);else for(var q=vec3.fromValues(0,0.5*b,0),r=vec3.fromValues(0,-0.5*b,0),s=vec3.fromValues(0,1,0),t=vec3.fromValues(0,-1,0),l=0;l<c;++l){var m=l*k,u=vec3.fromValues(Math.sin(m),
0,Math.cos(m)),m=vec3.fromValues(Math.sin(m+k),0,Math.cos(m+k));d.set([u[0]*a,0.5*b,u[2]*a],n+18*l);g.set(s,n+18*l);h.set([0.5*-u[0]+0.5,0.5*u[2]+0.5],p+12*l);d.set([m[0]*a,0.5*b,m[2]*a],n+18*l+3);g.set(s,n+18*l+3);h.set([0.5*-m[0]+0.5,0.5*m[2]+0.5],p+12*l+2);d.set(q,n+18*l+6);g.set(s,n+18*l+6);h.set([0.5,0.5],p+12*l+4);d.set([m[0]*a,-0.5*b,m[2]*a],n+18*l+9);g.set(t,n+18*l+9);h.set([0.5*m[0]+0.5,0.5*m[2]+0.5],p+12*l+6);d.set([u[0]*a,-0.5*b,u[2]*a],n+18*l+12);g.set(t,n+18*l+12);h.set([0.5*u[0]+0.5,
0.5*u[2]+0.5],p+12*l+8);d.set(r,n+18*l+15);g.set(t,n+18*l+15);h.set([0.5,0.5],p+12*l+10)}c={vertices:d,normals:g,coords:h};f.bounding=BBox.fromCenterHalfsize([0,0,0],[a,0.5*b,a]);return Mesh.load(c,f,e)};Mesh.sphere=function(f,e){f=f||{};for(var a=f.radius||f.size||1,b=f.lat||f.subdivisions||16,c=f["long"]||f.subdivisions||16,d=new Float32Array((b+1)*(c+1)*3),g=new Float32Array((b+1)*(c+1)*3),h=new Float32Array((b+1)*(c+1)*2),k=new Uint16Array(b*c*6),n=f.hemi?0.5*Math.PI:Math.PI,l=0,m=0,r=0;r<=b;r++)for(var q=
r*n/b,A=Math.sin(q),s=Math.cos(q),q=0;q<=c;q++){var t=2*q*Math.PI/c,u=Math.sin(t),t=Math.cos(t)*A,y=s,u=u*A,F=1-q/c,v=1-r/b;d.set([a*t,a*y,a*u],l);g.set([t,y,u],l);h.set([F,v],m);l+=3;m+=2}for(r=l=0;r<b;r++)for(q=0;q<c;q++)n=r*(c+1)+q,m=n+c+1,k.set([m,n,n+1],l),k.set([m+1,m,n+1],l+3),l+=6;d={vertices:d,normals:g,coords:h,triangles:k};if(f.wireframe){g=new Uint16Array(c*b*4);for(l=h=0;l<b;l++){for(k=0;k<c;k++)g[h]=l*(c+1)+k,g[h+1]=l*(c+1)+k+1,h+=2;g[h-2*c]=l*(c+1)+k}for(l=0;l<c;l++)for(k=0;k<b;k++)g[h]=
k*(c+1)+l,g[h+1]=(k+1)*(c+1)+l,h+=2;d.wireframe=g}f.bounding=f.hemi?BBox.fromCenterHalfsize([0,0.5*a,0],[a,0.5*a,a],a):BBox.fromCenterHalfsize([0,0,0],[a,a,a],a);return p.Mesh.load(d,f,e)};Mesh.grid=function(f,e){f=f||{};var a=f.lines||11;0>a&&(a=1);for(var b=f.size||10,c=new Float32Array(12*a),d=0.5*b,g=0,h=-d,b=b/(a-1),k=0;k<a;k++)c[g]=h,c[g+2]=-d,c[g+3]=h,c[g+5]=d,c[g+6]=d,c[g+8]=h,c[g+9]=-d,c[g+11]=h,h+=b,g+=12;return new p.Mesh({vertices:c},f,e)};Mesh.icosahedron=function(f,e){function a(a,c){var d=
n[a]<n[c]?n[a]+":"+n[c]:n[c]+":"+n[a],e=s[d];if(e)return e;e=g.length/3;g.push(0.5*(g[3*n[a]]+g[3*n[c]]),0.5*(g[3*n[a]+1]+g[3*n[c]+1]),0.5*(g[3*n[a]+2]+g[3*n[c]+2]));var f=Math.sqrt(g[3*e]*g[3*e]+g[3*e+1]*g[3*e+1]+g[3*e+2]*g[3*e+2]),l=g[3*e]/f,m=g[3*e+1]/f,q=g[3*e+2]/f;h.push(l,m,q);k.push(Math.atan2(l,q)/Math.PI*0.5,Math.acos(m)/Math.PI);g[3*e]*=b/f;g[3*e+1]*=b/f;g[3*e+2]*=b/f;return s[d]=e}f=f||{};var b=f.radius||f.size||1,c=void 0===f.subdivisions?0:f.subdivisions;6<c&&(c=6);for(var d=(1+Math.sqrt(5))/
2,g=[-1,d,0,1,d,0,-1,-d,0,1,-d,0,0,-1,d,0,1,d,0,-1,-d,0,1,-d,d,0,-1,d,0,1,-d,0,-1,-d,0,1],h=[],k=[],n=[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1],d=g.length,l=0;l<d;l+=3){var m=Math.sqrt(g[l]*g[l]+g[l+1]*g[l+1]+g[l+2]*g[l+2]),r=g[l]/m,q=g[l+1]/m,A=g[l+2]/m;h.push(r,q,A);k.push(Math.atan2(r,A),Math.acos(q));g[l]*=b/m;g[l+1]*=b/m;g[l+2]*=b/m}for(var s={},m=0;m<c;++m){r=[];d=n.length;for(l=0;l<d;l+=3){var q=a(l,l+
1),A=a(l+1,l+2),t=a(l+2,l);r.push(n[l],q,t);r.push(n[l+1],A,q);r.push(n[l+2],t,A);r.push(q,A,t)}n=r}f.bounding=BBox.fromCenterHalfsize([0,0,0],[b,b,b],b);return new p.Mesh.load({vertices:g,coords:k,normals:h,triangles:n},f,e)};r.Texture=p.Texture=function e(a,b,c,d){c=c||{};this.gl=d=d||r.gl;this._context_id=d.context_id;a=parseInt(a);b=parseInt(b);this.handler=d.createTexture();this.width=a;this.height=b;this.format=c.format||d.RGBA;this.type=c.type||d.UNSIGNED_BYTE;this.texture_type=c.texture_type||
d.TEXTURE_2D;this.magFilter=c.magFilter||c.filter||d.LINEAR;this.minFilter=c.minFilter||c.filter||d.LINEAR;this.wrapS=c.wrap||c.wrapS||d.CLAMP_TO_EDGE;this.wrapT=c.wrap||c.wrapT||d.CLAMP_TO_EDGE;e.MAX_TEXTURE_IMAGE_UNITS||(e.MAX_TEXTURE_IMAGE_UNITS=d.getParameter(d.MAX_TEXTURE_IMAGE_UNITS));this.has_mipmaps=!1;if(this.format==d.DEPTH_COMPONENT&&!d.extensions.WEBGL_depth_texture)throw"Depth Texture not supported";if(this.type==d.FLOAT&&!d.extensions.OES_texture_float)throw"Float Texture not supported";
if(this.type==d.HALF_FLOAT_OES&&!d.extensions.OES_texture_half_float)throw"Half Float Texture not supported";if(!((this.minFilter==d.NEAREST||this.minFilter==d.LINEAR)&&this.wrapS==d.CLAMP_TO_EDGE&&this.wrapT==d.CLAMP_TO_EDGE||isPowerOfTwo(this.width)&&isPowerOfTwo(this.height)))if(c.ignore_pot)this.minFilter=this.magFilter=d.LINEAR,this.wrapS=this.wrapT=d.CLAMP_TO_EDGE;else throw"Cannot use texture-wrap or mipmaps in Non-Power-of-Two textures";if(a&&b){d.activeTexture(d.TEXTURE0+e.MAX_TEXTURE_IMAGE_UNITS-
1);d.bindTexture(this.texture_type,this.handler);d.texParameteri(this.texture_type,d.TEXTURE_MAG_FILTER,this.magFilter);d.texParameteri(this.texture_type,d.TEXTURE_MIN_FILTER,this.minFilter);d.texParameteri(this.texture_type,d.TEXTURE_WRAP_S,this.wrapS);d.texParameteri(this.texture_type,d.TEXTURE_WRAP_T,this.wrapT);c.anisotropic&&d.extensions.EXT_texture_filter_anisotropic&&d.texParameterf(d.TEXTURE_2D,d.extensions.EXT_texture_filter_anisotropic.TEXTURE_MAX_ANISOTROPY_EXT,c.anisotropic);var g=c.pixel_data;
g&&!g.buffer&&(g=new (this.type==d.FLOAT?Float32Array:Uint8Array)(g));this.texture_type==d.TEXTURE_2D?(d.texImage2D(d.TEXTURE_2D,0,this.format,a,b,0,this.format,this.type,g||null),p.isPowerOfTwo(a)&&p.isPowerOfTwo(b)&&c.minFilter&&c.minFilter!=d.NEAREST&&c.minFilter!=d.LINEAR&&(d.generateMipmap(this.texture_type),this.has_mipmaps=!0)):this.texture_type==d.TEXTURE_CUBE_MAP&&(d.texImage2D(d.TEXTURE_CUBE_MAP_POSITIVE_X,0,this.format,this.width,this.height,0,this.format,this.type,g||null),d.texImage2D(d.TEXTURE_CUBE_MAP_POSITIVE_Y,
0,this.format,this.width,this.height,0,this.format,this.type,g||null),d.texImage2D(d.TEXTURE_CUBE_MAP_POSITIVE_Z,0,this.format,this.width,this.height,0,this.format,this.type,g||null),d.texImage2D(d.TEXTURE_CUBE_MAP_NEGATIVE_X,0,this.format,this.width,this.height,0,this.format,this.type,g||null),d.texImage2D(d.TEXTURE_CUBE_MAP_NEGATIVE_Y,0,this.format,this.width,this.height,0,this.format,this.type,g||null),d.texImage2D(d.TEXTURE_CUBE_MAP_NEGATIVE_Z,0,this.format,this.width,this.height,0,this.format,
this.type,g||null));d.bindTexture(this.texture_type,null);d.activeTexture(d.TEXTURE0)}};Texture.framebuffer=null;Texture.renderbuffer=null;Texture.loading_color=new Uint8Array([0,0,0,0]);Texture.use_renderbuffer_pool=!0;Texture.prototype.delete=function(){gl.deleteBuffer(this.handler);this.handler=null};Texture.prototype.getProperties=function(){return{width:this.width,height:this.height,type:this.type,format:this.format,texture_type:this.texture_type,magFilter:this.magFilter,minFilter:this.minFilter,
wrapS:this.wrapS,wrapT:this.wrapT}};Texture.prototype.toJSON=function(){return""};Texture.isDepthSupported=function(){return null!=gl.extensions.WEBGL_depth_texture};Texture.prototype.bind=function(e){void 0==e&&(e=0);var a=this.gl;a.activeTexture(a.TEXTURE0+e);a.bindTexture(this.texture_type,this.handler);return e};Texture.prototype.unbind=function(e){void 0===e&&(e=0);var a=this.gl;a.activeTexture(a.TEXTURE0+e);a.bindTexture(this.texture_type,null)};Texture.prototype.setParameter=function(e,a){this.bind(0);
this.gl.texParameteri(this.texture_type,e,a);switch(e){case this.gl.TEXTURE_MAG_FILTER:this.magFilter=a;break;case this.gl.TEXTURE_MIN_FILTER:this.minFilter=a;break;case this.gl.TEXTURE_WRAP_S:this.wrapS=a;break;case this.gl.TEXTURE_WRAP_T:this.wrapT=a}};Texture.setUploadOptions=function(e,a){a=a||r.gl;e?(a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!!e.premultiply_alpha),a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!e.no_flip)):(a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,
!0));a.pixelStorei(a.UNPACK_ALIGNMENT,1)};Texture.prototype.uploadImage=function(e,a){this.bind();var b=this.gl;Texture.setUploadOptions(a,b);try{b.texImage2D(b.TEXTURE_2D,0,this.format,this.format,this.type,e),this.width=e.videoWidth||e.width,this.height=e.videoHeight||e.height}catch(c){if("file:"==location.protocol)throw'image not loaded for security reasons (serve this page over "http://" instead)';throw"image not loaded for security reasons (image must originate from the same domain as this page or use Cross-Origin Resource Sharing)";
}this.minFilter&&this.minFilter!=b.NEAREST&&this.minFilter!=b.LINEAR&&(b.generateMipmap(this.texture_type),this.has_mipmaps=!0);b.bindTexture(this.texture_type,null)};Texture.prototype.uploadData=function(e,a){var b=this.gl;this.bind();Texture.setUploadOptions(a,b);b.texImage2D(this.texture_type,0,this.format,this.width,this.height,0,this.format,this.type,e);this.minFilter&&this.minFilter!=b.NEAREST&&this.minFilter!=b.LINEAR&&(b.generateMipmap(texture.texture_type),this.has_mipmaps=!0);b.bindTexture(this.texture_type,
null)};Texture.cubemap_camera_parameters=[{type:"posX",dir:vec3.fromValues(1,0,0),up:vec3.fromValues(0,-1,0)},{type:"negX",dir:vec3.fromValues(-1,0,0),up:vec3.fromValues(0,-1,0)},{type:"posY",dir:vec3.fromValues(0,1,0),up:vec3.fromValues(0,0,1)},{type:"negY",dir:vec3.fromValues(0,-1,0),up:vec3.fromValues(0,0,-1)},{type:"posZ",dir:vec3.fromValues(0,0,1),up:vec3.fromValues(0,-1,0)},{type:"negZ",dir:vec3.fromValues(0,0,-1),up:vec3.fromValues(0,-1,0)}];Texture.prototype.drawTo=function(e,a){function b(){6E4<=
p.getTime()-this.time?(console.log("Buffer cleared"),c.deleteRenderbuffer(c._renderbuffers_pool[l]),delete c._renderbuffers_pool[l]):setTimeout(b.bind(this),6E4)}var c=this.gl;if(this.format==c.DEPTH_COMPONENT)throw"cannot use drawTo in depth textures, use Texture.drawToColorAndDepth";var d=c.getViewport(),g=p.getTime(),h=c.getParameter(c.FRAMEBUFFER_BINDING),k=c._framebuffer=c._framebuffer||c.createFramebuffer();c.bindFramebuffer(c.FRAMEBUFFER,k);var n=null;if(Texture.use_renderbuffer_pool){c._renderbuffers_pool||
(c._renderbuffers_pool={});var l=this.width+":"+this.height;c._renderbuffers_pool[l]?(n=c._renderbuffers_pool[l],n.time=g,c.bindRenderbuffer(c.RENDERBUFFER,n)):(c._renderbuffers_pool[l]=n=c.createRenderbuffer(),n.time=g,n.width=this.width,n.height=this.height,c.bindRenderbuffer(c.RENDERBUFFER,n),setTimeout(b.bind(n),6E4))}else n=c._renderbuffer=c._renderbuffer||c.createRenderbuffer(),n.width=this.width,n.height=this.height,c.bindRenderbuffer(c.RENDERBUFFER,n);c.renderbufferStorage(c.RENDERBUFFER,
c.DEPTH_COMPONENT16,this.width,this.height);c.viewport(0,0,this.width,this.height);c._current_texture_drawto=this;c._current_fbo_color=k;c._current_fbo_depth=n;if(this.texture_type==c.TEXTURE_2D)c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_2D,this.handler,0),c.framebufferRenderbuffer(c.FRAMEBUFFER,c.DEPTH_ATTACHMENT,c.RENDERBUFFER,n),e(this,a);else if(this.texture_type==c.TEXTURE_CUBE_MAP)for(g=0;6>g;g++)c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_CUBE_MAP_POSITIVE_X+
g,this.handler,0),c.framebufferRenderbuffer(c.FRAMEBUFFER,c.DEPTH_ATTACHMENT,c.RENDERBUFFER,n),e(this,g,a);c._current_texture_drawto=null;c._current_fbo_color=null;c._current_fbo_depth=null;c.bindFramebuffer(c.FRAMEBUFFER,h);c.bindRenderbuffer(c.RENDERBUFFER,null);c.viewport(d[0],d[1],d[2],d[3]);return this};Texture.drawTo=function(e,a,b){for(var c=-1,d=-1,g=null,h=0;h<e.length;h++){var k=e[h];if(-1==c)c=k.width;else if(c!=k.width)throw"Cannot use Texture.drawTo if textures have different dimensions";
if(-1==d)d=k.height;else if(d!=k.height)throw"Cannot use Texture.drawTo if textures have different dimensions";if(null==g)g=k.type;else if(g!=k.type)throw"Cannot use Texture.drawTo if textures have different data type, all must have the same type";}g=gl.getViewport();gl._framebuffer=gl._framebuffer||gl.createFramebuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,gl._framebuffer);gl.viewport(0,0,c,d);var n=gl.extensions.WEBGL_draw_buffers;if(!n&&1<e.length)throw"Rendering to several textures not supported";
h=null;b||(h=gl._renderbuffer=gl._renderbuffer||gl.createRenderbuffer(),h.width=c,h.height=d,gl.bindRenderbuffer(gl.RENDERBUFFER,h));b?gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.TEXTURE_2D,b.handler,0):(gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,c,d),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,h));b=[];for(h=0;h<e.length;h++)k=e[h],gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0+h,gl.TEXTURE_2D,k.handler,0),b.push(gl.COLOR_ATTACHMENT0+
h);1<e.length&&n.drawBuffersWEBGL(b);e=gl.checkFramebufferStatus(gl.FRAMEBUFFER);if(e!==gl.FRAMEBUFFER_COMPLETE)throw"FBO not complete: "+e;a();gl.bindFramebuffer(gl.FRAMEBUFFER,null);gl.viewport(g[0],g[1],g[2],g[3])};Texture.drawToColorAndDepth=function(e,a,b){var c=e.gl;if(a.width!=e.width||a.height!=e.height)throw"Different size between color texture and depth texture";var d=c.getViewport();c._framebuffer=c._framebuffer||c.createFramebuffer();c.bindFramebuffer(c.FRAMEBUFFER,c._framebuffer);c.viewport(0,
0,e.width,e.height);c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_2D,e.handler,0);c.framebufferTexture2D(c.FRAMEBUFFER,c.DEPTH_ATTACHMENT,c.TEXTURE_2D,a.handler,0);b();c.bindFramebuffer(c.FRAMEBUFFER,null);c.viewport(d[0],d[1],d[2],d[3])};Texture.prototype.copyTo=function(e,a,b){var c=this.gl,d=c.getParameter(c.FRAMEBUFFER_BINDING),g=c.getViewport(),h=c.__copy_fbo=c.__copy_fbo||c.createFramebuffer();c.bindFramebuffer(c.FRAMEBUFFER,h);c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,
c.TEXTURE_2D,e.handler,0);c.viewport(0,0,e.width,e.height);c.disable(c.BLEND);c.disable(c.DEPTH_TEST);a&&b&&a.uniforms(b);this.toViewport(a);c.setViewport(g);c.bindFramebuffer(c.FRAMEBUFFER,d);e.minFilter&&e.minFilter!=c.NEAREST&&e.minFilter!=c.LINEAR&&(e.bind(),c.generateMipmap(e.texture_type),e.has_mipmaps=!0);c.bindTexture(e.texture_type,null);return this};Texture.prototype.toViewport=function(e,a){e=e||Shader.getScreenShader();var b=Mesh.getScreenQuad();this.bind(0);a&&e.uniforms(a);e.draw(b,
gl.TRIANGLES)};Texture.prototype.fill=function(e){var a=gl.getParameter(gl.COLOR_CLEAR_VALUE);gl.clearColor(e[0],e[1],e[2],e[3]);this.drawTo(function(){gl.clear(gl.COLOR_BUFFER_BIT)});gl.clearColor(a[0],a[1],a[2],a[3])};Texture.prototype.renderQuad=function(){var e=mat3.create(),a=vec2.create(),b=vec2.create(),c=vec4.fromValues(1,1,1,1);return function(d,g,h,k,n,l){a[0]=d;a[1]=g;b[0]=h;b[1]=k;n=n||Shader.getQuadShader(this.gl);d=Mesh.getScreenQuad(this.gl);this.bind(0);n.uniforms({u_texture:0,u_position:a,
u_color:c,u_size:b,u_viewport:gl.viewport_data.subarray(2,4),u_transform:e});l&&n.uniforms(l);n.draw(d,gl.TRIANGLES)}}();Texture.prototype.applyBlur=function(e,a,b,c,d){var g=this,h=this.gl,k=p.Shader.getBlurShader();c||(c=new p.Texture(this.width,this.height,this.getProperties()));e/=this.width;a/=this.height;h.disable(h.DEPTH_TEST);h.disable(h.BLEND);c.drawTo(function(){g.toViewport(k,{u_texture:0,u_intensity:b,u_offset:[0,a]})});(d||this).drawTo(function(){c.toViewport(k,{u_intensity:b,u_offset:[e,
0]})});return c};Texture.fromURL=function(e,a,b,c){c=c||r.gl;a=a||{};var d=a.texture||new p.Texture(1,1,a,c);64>e.length&&(d.url=e);d.bind();Texture.setUploadOptions(a);var g=a.temp_color||Texture.loading_color,g=a.type==c.FLOAT?new Float32Array(g):new Uint8Array(g);c.texImage2D(c.TEXTURE_2D,0,d.format,d.width,d.height,0,d.format,d.type,g);c.bindTexture(d.texture_type,null);d.ready=!1;if(-1!=e.toLowerCase().indexOf(".dds")){var g=c.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc")||c.getExtension("WEBGL_compressed_texture_s3tc"),
h=new p.Texture(0,0,a,c);P.loadDDSTextureEx(c,g,e,h.handler,!0,function(a){d.texture_type=a.texture_type;d.handler=a;delete d.ready;b&&b(d,e)})}else c=new Image,c.src=e,c.onload=function(){a.texture=d;p.Texture.fromImage(this,a);delete d.ready;b&&b(d,e)},c.onerror=function(){b&&b(null)};return d};Texture.fromImage=function(e,a){a=a||{};var b=a.texture||new p.Texture(e.width,e.height,a);b.bind();b.uploadImage(e,a);p.isPowerOfTwo(b.width)&&p.isPowerOfTwo(b.height)&&a.minFilter&&a.minFilter!=gl.NEAREST&&
a.minFilter!=gl.LINEAR&&(b.bind(),gl.generateMipmap(b.texture_type),b.has_mipmaps=!0);gl.bindTexture(b.texture_type,null);a.keep_image&&(b.img=e);return b};Texture.fromVideo=function(e,a){a=a||{};var b=a.texture||new p.Texture(e.videoWidth,e.videoHeight,a);b.bind();b.uploadImage(e,a);a.minFilter&&a.minFilter!=gl.NEAREST&&a.minFilter!=gl.LINEAR&&(b.bind(),gl.generateMipmap(b.texture_type),b.has_mipmaps=!0);gl.bindTexture(b.texture_type,null);return b};Texture.fromTexture=function(e,a){a=a||{};var b=
new p.Texture(e.width,e.height,a);e.copyTo(b);return b};Texture.fromMemory=function(e,a,b,c){c=c||{};var d=c.texture||new p.Texture(e,a,c);Texture.setUploadOptions(c);d.bind();try{gl.texImage2D(gl.TEXTURE_2D,0,d.format,e,a,0,d.format,d.type,b)}catch(g){if("file:"==location.protocol)throw'image not loaded for security reasons (serve this page over "http://" instead)';throw"image not loaded for security reasons (image must originate from the same domain as this page or use Cross-Origin Resource Sharing)";
}c.minFilter&&c.minFilter!=gl.NEAREST&&c.minFilter!=gl.LINEAR&&(gl.generateMipmap(gl.TEXTURE_2D),d.has_mipmaps=!0);gl.bindTexture(d.texture_type,null);return d};Texture.fromDDSInMemory=function(e,a){a=a||{};var b=a.texture||new p.Texture(0,0,a);p.Texture.setUploadOptions(a);b.bind();var c=gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc")||gl.getExtension("WEBGL_compressed_texture_s3tc");P.loadDDSTextureFromMemoryEx(gl,c,e,b,!0);gl.bindTexture(b.texture_type,null);return b};Texture.fromShader=
function(e,a,b,c){c=c||{};e=new p.Texture(e,a,c);e.drawTo(function(){gl.disable(gl.BLEND);gl.disable(gl.DEPTH_TEST);gl.disable(gl.CULL_FACE);var a=Mesh.getScreenQuad();b.draw(a)});return e};Texture.cubemapFromImages=function(e,a){a=a||{};if(6!=e.length)throw"missing images to create cubemap";var b=e[0].width,c=e[0].height;a.texture_type=gl.TEXTURE_CUBE_MAP;b=a.texture||new Texture(b,c,a);Texture.setUploadOptions(a);b.bind();try{for(c=0;6>c;c++)gl.texImage2D(gl.TEXTURE_CUBE_MAP_POSITIVE_X+c,0,b.format,
b.format,b.type,e[c])}catch(d){if("file:"==location.protocol)throw'image not loaded for security reasons (serve this page over "http://" instead)';throw"image not loaded for security reasons (image must originate from the same domain as this page or use Cross-Origin Resource Sharing)";}a.minFilter&&a.minFilter!=gl.NEAREST&&a.minFilter!=gl.LINEAR&&(gl.generateMipmap(gl.TEXTURE_CUBE_MAP),b.has_mipmaps=!0);b.unbind();return b};Texture.cubemapFromImage=function(e,a){a=a||{};if(e.width!=e.height/6&&0!=
e.height%6&&!a.faces)return console.error("Cubemap image not valid, only 1x6 (vertical) or 6x3 (cross) formats. Check size:",e.width,e.height),null;var b=e.width,c=e.height;void 0!==a.is_cross?(a.faces=Texture.generateCubemapCrossFacesInfo(e.width,a.is_cross),b=c=e.width/4):a.faces?(b=a.width||a.faces[0].width,c=a.height||a.faces[0].height):c/=6;if(b!=c)return console.log("Texture not valid, width and height for every face must be square"),null;var d=b;a.no_flip=!0;for(var g=[],h=0;6>h;h++){var k=
createCanvas(d,d),n=k.getContext("2d");a.faces?n.drawImage(e,a.faces[h].x,a.faces[h].y,a.faces[h].width||d,a.faces[h].height||d,0,0,d,d):n.drawImage(e,0,c*h,b,c,0,0,d,d);g.push(k)}b=Texture.cubemapFromImages(g,a);a.keep_image&&(b.img=e);return b};Texture.generateCubemapCrossFacesInfo=function(e,a){void 0===a&&(a=1);var b=e/4;return[{x:2*b,y:b,width:b,height:b},{x:0,y:b,width:b,height:b},{x:a*b,y:0,width:b,height:b},{x:a*b,y:2*b,width:b,height:b},{x:b,y:b,width:b,height:b},{x:3*b,y:b,width:b,height:b}]};
Texture.cubemapFromURL=function(e,a,b){a=a||{};a.texture_type=gl.TEXTURE_CUBE_MAP;var c=a.texture||new p.Texture(1,1,a);c.bind();Texture.setUploadOptions(a);for(var d=a.temp_color||[0,0,0,255],d=a.type==gl.FLOAT?new Float32Array(d):new Uint8Array(d),g=0;6>g;g++)gl.texImage2D(gl.TEXTURE_CUBE_MAP_POSITIVE_X+g,0,c.format,1,1,0,c.format,c.type,d);gl.bindTexture(c.texture_type,null);c.ready=!1;d=new Image;d.src=e;d.onload=function(){a.texture=c;(c=p.Texture.cubemapFromImage(this,a))&&delete c.ready;b&&
b(c)};return c};Texture.prototype.getPixels=function(e,a){var b=this.gl,c=b.getViewport(),d=b.getParameter(b.FRAMEBUFFER_BINDING);e=e||this.type;var g=b.createFramebuffer(),h=b.createRenderbuffer();if(this.format==b.DEPTH_COMPONENT)throw"cannot use getPixels in depth textures";b.bindFramebuffer(b.FRAMEBUFFER,g);b.bindRenderbuffer(b.RENDERBUFFER,h);h.width=this.width;h.height=this.height;b.renderbufferStorage(b.RENDERBUFFER,b.DEPTH_COMPONENT16,this.width,this.height);b.viewport(0,0,this.width,this.height);
if(this.texture_type!=b.TEXTURE_2D)throw"getPixels only work with texture2D";b.framebufferTexture2D(b.FRAMEBUFFER,b.COLOR_ATTACHMENT0,b.TEXTURE_2D,this.handler,0);b.framebufferRenderbuffer(b.FRAMEBUFFER,b.DEPTH_ATTACHMENT,b.RENDERBUFFER,h);g=this.format==b.RGB?3:4;g=4;h=null;h=e==b.UNSIGNED_BYTE?new Uint8Array(this.width*this.height*g):new Float32Array(this.width*this.height*g);b.readPixels(0,0,this.width,this.height,3==g?b.RGB:b.RGBA,e,h);b.bindRenderbuffer(b.RENDERBUFFER,null);b.bindFramebuffer(b.FRAMEBUFFER,
d);b.viewport(c[0],c[1],c[2],c[3]);return h};Texture.prototype.toCanvas=function(e,a,b){b=b||8192;var c=this.gl;if(this.texture_type!=c.TEXTURE_2D)return null;var d=Math.min(this.width,b);b=Math.min(this.height,b);e=e||createCanvas(d,b);e.width!=d&&(e.width=d);e.height!=b&&(e.height=b);var g=null;this.width!=d||this.height!=b?(g=new p.Texture(d,b,{format:c.RGBA,filter:c.NEAREST}),this.copyTo(g),g=g.getPixels(c.UNSIGNED_BYTE,!0)):g=this.getPixels(c.UNSIGNED_BYTE,!0);var c=e.getContext("2d"),h=c.getImageData(0,
0,d,b);h.data.set(g);c.putImageData(h,0,0);a&&(g=createCanvas(d,b),a=g.getContext("2d"),a.translate(0,g.height),a.scale(1,-1),a.drawImage(e,0,0,g.width,g.height),c.drawImage(g,0,0));return e};Texture.prototype.toBlob=function(){var e=this.width,a=this.height;if(this.texture_type==gl.TEXTURE_CUBE_MAP){if(this.image)return e=createCanvas(this.image.width,this.image.height),a=e.getContext("2d"),a.drawImage(this.image,0,0),e.toBlob();console.warning("Litegl: cannot call toBlob of a cubemap GL.Texture");
return null}var b=this.getPixels(),c=createCanvas(e,a);if(!c.toBlob)throw"toBlob not supported on Canvas element";var d=c.getContext("2d"),g=d.getImageData(0,0,e,a);g.data.set(b);d.putImageData(g,0,0);e=createCanvas(e,a);a=e.getContext("2d");a.translate(0,e.height);a.scale(1,-1);a.drawImage(c,0,0);return e.toBlob()};Texture.prototype.toBase64=function(e){var a=this.width,b=this.height,c=this.getPixels(),d=createCanvas(a,b),g=d.getContext("2d"),h=g.getImageData(0,0,a,b);h.data.set(c);g.putImageData(h,
0,0);e&&(e=createCanvas(a,b),a=e.getContext("2d"),a.translate(0,b),a.scale(1,-1),a.drawImage(d,0,0),d=e);return d.toDataURL("image/png")};Texture.prototype.generateMetadata=function(){var e={};e.width=this.width;e.height=this.height;this.metadata=e};Texture.compareFormats=function(e,a){return e&&a?e==a?!0:e.width!=a.width||e.height!=a.height||e.type!=a.type||e.texture_type!=a.texture_type?!1:!0:!1};Texture.getWhiteTexture=function(){var e=this.gl,a=e.textures[":white"];if(a)return a;a=new Uint8Array([255,
255,255,255]);return e.textures[":white"]=new p.Texture(1,1,{pixel_data:a})};Texture.getBlackTexture=function(){var e=this.gl,a=e.textures[":black"];if(a)return a;a=new Uint8Array([0,0,0,255]);return e.textures[":black"]=new p.Texture(1,1,{pixel_data:a})};p.FBO=O;O.prototype.setTextures=function(e,a,b){var c=this.depth_texture==a;if(c&&e)if(e.length==this.color_textures.length)for(var d=0;d<e.length;++d){if(e[d]!=this.color_textures[d]){c=!1;break}}else c=!1;if(!c){this._old_fbo=gl.getParameter(gl.FRAMEBUFFER_BINDING);
this.handler||(this.handler=gl.createFramebuffer());var g=c=-1,h=null,k=0;this.color_textures&&(k=this.color_textures.length);this.color_textures=e||[];this.depth_texture=a;if(e)for(d=0;d<e.length;d++){var n=e[d];if(-1==c)c=n.width;else if(c!=n.width)throw"Cannot use Texture.drawTo if textures have different dimensions";if(-1==g)g=n.height;else if(g!=n.height)throw"Cannot use Texture.drawTo if textures have different dimensions";if(null==h)h=n.type;else if(h!=n.type)throw"Cannot use Texture.drawTo if textures have different data type, all must have the same type";
}else c=a.width,g=a.height;this.width=c;this.height=g;gl.bindFramebuffer(gl.FRAMEBUFFER,this.handler);if(a&&!gl.extensions.WEBGL_depth_texture)throw"Rendering to depth texture not supported by your browser";h=gl.extensions.WEBGL_draw_buffers;if(!h&&e&&1<e.length)throw"Rendering to several textures not supported by your browser";a?gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.TEXTURE_2D,a.handler,0):(a=this._renderbuffer=this._renderbuffer||gl.createRenderbuffer(),a.width=c,a.height=
g,gl.bindRenderbuffer(gl.RENDERBUFFER,a),gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,c,g),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,a));if(e){this.order=[];for(d=0;d<e.length;d++)n=e[d],gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0+d,gl.TEXTURE_2D,n.handler,0),this.order.push(gl.COLOR_ATTACHMENT0+d);for(d=e.length;d<k;++d)gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0+d,gl.TEXTURE_2D,null,0)}else a=this._renderbuffer=this._renderbuffer||
gl.createRenderbuffer(),a.width=c,a.height=g,gl.bindRenderbuffer(gl.RENDERBUFFER,a),gl.renderbufferStorage(gl.RENDERBUFFER,gl.RGBA4,c,g),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.RENDERBUFFER,a);e&&1<e.length&&h.drawBuffersWEBGL(this.order);e=gl.checkFramebufferStatus(gl.FRAMEBUFFER);if(e!==gl.FRAMEBUFFER_COMPLETE)throw"FBO not complete: "+e;gl.bindTexture(gl.TEXTURE_2D,null);gl.bindRenderbuffer(gl.RENDERBUFFER,null);b||gl.bindFramebuffer(gl.FRAMEBUFFER,this._old_fbo)}};O.prototype.bind=
function(e){if(!this.color_textures.length&&!this.depth_texture)throw"FBO: no textures attached to FBO";this._old_viewport.set(gl.viewport_data);this._old_fbo=e?gl.getParameter(gl.FRAMEBUFFER_BINDING):null;this._old_fbo!=this.handler&&gl.bindFramebuffer(gl.FRAMEBUFFER,this.handler);gl.viewport(0,0,this.width,this.height)};O.prototype.unbind=function(){gl.bindFramebuffer(gl.FRAMEBUFFER,this._old_fbo);this._old_fbo=null;gl.setViewport(this._old_viewport)};r.Shader=p.Shader=function a(b,c,d){this._context_id=
r.gl.context_id;var g=this.gl=r.gl;d=a.expandMacros(d);this.program=g.createProgram();b=b.constructor===String?p.Shader.compileSource(g.VERTEX_SHADER,d+b):b;c=c.constructor===String?p.Shader.compileSource(g.FRAGMENT_SHADER,d+c):c;g.attachShader(this.program,b,g);g.attachShader(this.program,c,g);g.linkProgram(this.program);if(!g.getProgramParameter(this.program,g.LINK_STATUS))throw"link error: "+g.getProgramInfoLog(this.program);this.attributes={};this.uniformInfo={};this.samplers={};this.extractShaderInfo()};
Shader.expandMacros=function(a){var b="";if(a)for(var c in a)b+="#define "+c+" "+(a[c]?a[c]:"")+"\n";return b};Shader.compileSource=function(a,b,c){c=c||r.gl;var d=c.createShader(a);c.shaderSource(d,b);c.compileShader(d);if(!c.getShaderParameter(d,c.COMPILE_STATUS))throw(a==c.VERTEX_SHADER?"Vertex":"Fragment")+" shader compile error: "+c.getShaderInfoLog(d);return d};Shader.prototype.extractShaderInfo=function(){for(var a=this.gl,b=a.getProgramParameter(this.program,a.ACTIVE_UNIFORMS),c=0;c<b;++c){var d=
a.getActiveUniform(this.program,c);if(!d)break;var g=d.name,h=g.indexOf("[");-1!=h&&-1==g.indexOf("].")&&(g=g.substr(0,h));if(d.type==a.SAMPLER_2D||d.type==a.SAMPLER_CUBE)this.samplers[g]=d.type;var h=Shader.getUniformFunc(d),k=!1;if(d.type==a.FLOAT_MAT2||d.type==a.FLOAT_MAT3||d.type==a.FLOAT_MAT4)k=!0;this.uniformInfo[g]={type:d.type,func:h,size:d.size,is_matrix:k,loc:a.getUniformLocation(this.program,g)}}c=0;for(b=a.getProgramParameter(this.program,a.ACTIVE_ATTRIBUTES);c<b;++c){d=a.getActiveAttrib(this.program,
c);if(!d)break;h=Shader.getUniformFunc(d);this.uniformInfo[d.name]={type:d.type,func:h,size:d.size,loc:null};this.attributes[d.name]=a.getAttribLocation(this.program,d.name)}};Shader.prototype.hasUniform=function(a){return this.uniformInfo[a]};Shader.prototype.hasAttribute=function(a){return this.attributes[a]};Shader.getUniformFunc=function(a){var b=null;switch(a.type){case gl.FLOAT:b=1==a.size?gl.uniform1f:gl.uniform1fv;break;case gl.FLOAT_MAT2:b=gl.uniformMatrix2fv;break;case gl.FLOAT_MAT3:b=gl.uniformMatrix3fv;
break;case gl.FLOAT_MAT4:b=gl.uniformMatrix4fv;break;case gl.FLOAT_VEC2:b=gl.uniform2fv;break;case gl.FLOAT_VEC3:b=gl.uniform3fv;break;case gl.FLOAT_VEC4:b=gl.uniform4fv;break;case gl.UNSIGNED_INT:case gl.INT:b=1==a.size?gl.uniform1i:gl.uniform1iv;break;case gl.INT_VEC2:b=gl.uniform2iv;break;case gl.INT_VEC3:b=gl.uniform3iv;break;case gl.INT_VEC4:b=gl.uniform4iv;break;case gl.SAMPLER_2D:case gl.SAMPLER_CUBE:b=gl.uniform1i;break;default:b=gl.uniform1f}return b};Shader.fromURL=function(a,b,c){function d(){var a=
new p.Shader(h,k),b;for(b in a)g[b]=a[b];g.ready=!0}var g=new p.Shader("\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute mat4 u_mvp;\n\t\t\tvoid main() { \n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0); \n\t\t\t}\n\t\t","\n\t\t\tprecision highp float;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);\n\t\t\t}\n\t\t\t");g.ready=!1;var h=null,k=null;HttpRequest(a,null,function(a){h=a;k&&d()});HttpRequest(b,null,function(a){k=a;h&&d()});return g};
Shader.prototype.bind=function(){var a=this.gl;a.useProgram(this.program);a._current_shader=this};Shader.prototype.getLocation=function(a){return this.uniformInfo[a]?this.uniformInfo[a].loc:null};Shader._temp_uniform=new Float32Array(16);Shader.prototype.uniforms=function(a){var b=this.gl;b.useProgram(this.program);b._current_shader=this;for(var c in a)this.setUniform(c,a[c]);return this};Shader.prototype.uniformsArray=function(a){var b=this.gl;b.useProgram(this.program);b._current_shader=this;for(var b=
0,c=a.length;b<c;++b){var d=a[b],g;for(g in d)this._setUniform(g,d[g])}return this};Shader.prototype.setUniform=function(a,b){this.gl._current_shader!=this&&this.bind();var c=this.uniformInfo[a];c&&null!==c.loc&&null!=b&&(b.constructor===Array&&(b=new Float32Array(b)),c.is_matrix?c.func.call(this.gl,c.loc,!1,b):c.func.call(this.gl,c.loc,b))};Shader.prototype._setUniform=function(a,b){var c=this.uniformInfo[a];c&&null!==c.loc&&null!=b&&(b.constructor===Array&&(b=new Float32Array(b)),c.is_matrix?c.func.call(this.gl,
c.loc,!1,b):c.func.call(this.gl,c.loc,b))};Shader.prototype.draw=function(a,b,c){c=void 0===c?b==gl.LINES?"lines":"triangles":c;this.drawBuffers(a.vertexBuffers,c?a.indexBuffers[c]:null,2>arguments.length?gl.TRIANGLES:b)};Shader.prototype.drawRange=function(a,b,c,d,g){g=void 0===g?b==gl.LINES?"lines":"triangles":g;this.drawBuffers(a.vertexBuffers,g?a.indexBuffers[g]:null,b,c,d)};var R=new Uint8Array(16),T=new Uint8Array(16);Shader.prototype.drawBuffers=function(a,b,c,d,g){if(0!=g){var h=this.gl;h.useProgram(this.program);
var k=0;R.set(T);for(var n in a){var l=a[n],m=l.attribute||n,p=this.attributes[m];null!=p&&l.buffer&&(R[p]=1,h.bindBuffer(h.ARRAY_BUFFER,l.buffer),h.enableVertexAttribArray(p),h.vertexAttribPointer(p,l.buffer.spacing,l.buffer.gl_type,!1,0,0),k=l.buffer.length/l.buffer.spacing)}a=0;0<d&&(a=d*(b&&b.data?b.data.constructor.BYTES_PER_ELEMENT:1));0<g?k=g:b&&(k=b.buffer.length-a);for(m in this.attributes)p=this.attributes[m],R[p]||h.disableVertexAttribArray(this.attributes[m]);!k||b&&!b.buffer||(b?(h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,
b.buffer),h.drawElements(c,k,b.buffer.gl_type,a),h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,null)):h.drawArrays(c,a,k));return this}};Shader.expandImports=function(a,b){b=b||Shader.files;var c={};if(!b)throw"Shader.files not initialized, assign files there";return a.replace(/#import\s+\"([a-zA-Z0-9_\.]+)\"\s*\n/g,function(a){a=a.split('"')[1];if(c[a])return"//already imported: "+a+"\n";var g=b[a];c[a]=!0;return g?g+"\n":"//import code not found: "+a+"\n"})};Shader.dumpErrorToConsole=function(a,b,c){console.error(a);
var d=null,d=-1!=a.indexOf("Fragment")?c:b;a=d.split("\n");for(var g in a)a[g]=g+"| "+a[g];console.groupCollapsed("Shader code");console.log(a.join("\n"));console.groupEnd()};Shader.SCREEN_VERTEX_SHADER="\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec2 a_coord;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() { \n\t\t\t\tv_coord = a_coord; \n\t\t\t\tgl_Position = vec4(a_coord * 2.0 - 1.0, 0.0, 1.0); \n\t\t\t}\n\t\t\t";Shader.SCREEN_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = texture2D(u_texture, v_coord);\n\t\t\t}\n\t\t\t";
Shader.SCREEN_FRAGMENT_FX="\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tvarying vec2 v_coord;\n\t\t\t#ifdef FX_UNIFORMS\n\t\t\t\tFX_UNIFORMS\n\t\t\t#endif\n\t\t\tvoid main() {\n\t\t\t\tvec2 uv = v_coord;\n\t\t\t\tvec4 color = texture2D(u_texture, uv);\n\t\t\t\t#ifdef FX_CODE\n\t\t\t\t\tFX_CODE ;\n\t\t\t\t#endif\n\t\t\t\tgl_FragColor = color;\n\t\t\t}\n\t\t\t";Shader.SCREEN_COLORED_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec4 u_color;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = u_color * texture2D(u_texture, v_coord);\n\t\t\t}\n\t\t\t";
Shader.SCREEN_FLAT_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform vec4 u_color;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = u_color;\n\t\t\t}\n\t\t\t";Shader.QUAD_VERTEX_SHADER="\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec2 a_coord;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform vec2 u_position;\n\t\t\tuniform vec2 u_size;\n\t\t\tuniform vec2 u_viewport;\n\t\t\tuniform mat3 u_transform;\n\t\t\tvoid main() { \n\t\t\t\tvec3 pos = vec3(u_position + vec2(a_coord.x,1.0 - a_coord.y)  * u_size, 1.0);\n\t\t\t\tv_coord = a_coord; \n\t\t\t\tpos = u_transform * pos;\n\t\t\t\tpos.z = 0.0;\n\t\t\t\t//normalize\n\t\t\t\tpos.x = (2.0 * pos.x / u_viewport.x) - 1.0;\n\t\t\t\tpos.y = -((2.0 * pos.y / u_viewport.y) - 1.0);\n\t\t\t\tgl_Position = vec4(pos, 1.0); \n\t\t\t}\n\t\t\t";
Shader.QUAD_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec4 u_color;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = u_color * texture2D(u_texture, v_coord);\n\t\t\t}\n\t\t\t";Shader.QUAD2_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec4 u_color;\n\t\t\tuniform vec4 u_texture_area;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t    vec2 uv = vec2( mix(u_texture_area.x, u_texture_area.z, v_coord.x), 1.0 - mix(u_texture_area.w, u_texture_area.y, v_coord.y) );\n\t\t\t\tgl_FragColor = u_color * texture2D(u_texture, uv);\n\t\t\t}\n\t\t\t";
Shader.PRIMITIVE2D_VERTEX_SHADER="\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tuniform vec2 u_viewport;\n\t\t\tuniform mat3 u_transform;\n\t\t\tvoid main() { \n\t\t\t\tvec3 pos = a_vertex;\n\t\t\t\tpos = u_transform * pos;\n\t\t\t\tpos.z = 0.0;\n\t\t\t\t//normalize\n\t\t\t\tpos.x = (2.0 * pos.x / u_viewport.x) - 1.0;\n\t\t\t\tpos.y = -((2.0 * pos.y / u_viewport.y) - 1.0);\n\t\t\t\tgl_Position = vec4(pos, 1.0); \n\t\t\t}\n\t\t\t";Shader.FLAT_VERTEX_SHADER="\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tuniform mat4 u_mvp;\n\t\t\tvoid main() { \n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0); \n\t\t\t}\n\t\t\t";
Shader.FLAT_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform vec4 u_color;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = u_color;\n\t\t\t}\n\t\t\t";Shader.createFX=function(a,b){return new p.Shader(p.Shader.SCREEN_VERTEX_SHADER,p.Shader.SCREEN_FRAGMENT_FX,{FX_CODE:a,FX_UNIFORMS:b||""})};Shader.prototype.toViewport=function(a){var b=p.Mesh.getScreenQuad();a&&this.uniforms(a);this.draw(b)};Shader.getScreenShader=function(a){a=a||r.gl;var b=a.shaders[":screen"];if(b)return b;b=a.shaders[":screen"]=
new p.Shader(Shader.SCREEN_VERTEX_SHADER,Shader.SCREEN_FRAGMENT_SHADER);return b.uniforms({u_texture:0})};Shader.getColoredScreenShader=function(a){a=a||r.gl;var b=a.shaders[":colored_screen"];if(b)return b;b=a.shaders[":colored_screen"]=new p.Shader(Shader.SCREEN_VERTEX_SHADER,Shader.SCREEN_COLORED_FRAGMENT_SHADER);return b.uniforms({u_texture:0,u_color:vec4.fromValues(1,1,1,1)})};Shader.getQuadShader=function(a){a=a||r.gl;var b=a.shaders[":quad"];return b?b:a.shaders[":quad"]=new p.Shader(Shader.QUAD_VERTEX_SHADER,
Shader.QUAD_FRAGMENT_SHADER)};Shader.getPartialQuadShader=function(a){a=a||r.gl;var b=a.shaders[":quad2"];return b?b:a.shaders[":quad2"]=new p.Shader(Shader.QUAD_VERTEX_SHADER,Shader.QUAD2_FRAGMENT_SHADER)};Shader.getBlurShader=function(a){a=a||r.gl;var b=a.shaders[":blur"];if(b)return b;b=new p.Shader(Shader.SCREEN_VERTEX_SHADER,"\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec2 u_offset;\n\t\t\tuniform float u_intensity;\n\t\t\tvoid main() {\n\t\t\t   vec4 sum = vec4(0.0);\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * -4.0) * 0.05/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * -3.0) * 0.09/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * -2.0) * 0.12/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * -1.0) * 0.15/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord) * 0.16/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * 4.0) * 0.05/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * 3.0) * 0.09/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * 2.0) * 0.12/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * 1.0) * 0.15/0.98;\n\t\t\t   gl_FragColor = u_intensity * sum;\n\t\t\t}\n\t\t\t");
return a.shaders[":blur"]=b};Shader.FXAA_FUNC="\n\tuniform vec2 u_viewportSize;\n\tuniform vec2 u_iViewportSize;\n\t#define FXAA_REDUCE_MIN   (1.0/ 128.0)\n\t#define FXAA_REDUCE_MUL   (1.0 / 8.0)\n\t#define FXAA_SPAN_MAX     8.0\n\t\n\t/* from mitsuhiko/webgl-meincraft based on the code on geeks3d.com */\n\tvec4 applyFXAA(sampler2D tex, vec2 fragCoord)\n\t{\n\t\tvec4 color = vec4(0.0);\n\t\t/*vec2 u_iViewportSize = vec2(1.0 / u_viewportSize.x, 1.0 / u_viewportSize.y);*/\n\t\tvec3 rgbNW = texture2D(tex, (fragCoord + vec2(-1.0, -1.0)) * u_iViewportSize).xyz;\n\t\tvec3 rgbNE = texture2D(tex, (fragCoord + vec2(1.0, -1.0)) * u_iViewportSize).xyz;\n\t\tvec3 rgbSW = texture2D(tex, (fragCoord + vec2(-1.0, 1.0)) * u_iViewportSize).xyz;\n\t\tvec3 rgbSE = texture2D(tex, (fragCoord + vec2(1.0, 1.0)) * u_iViewportSize).xyz;\n\t\tvec3 rgbM  = texture2D(tex, fragCoord  * u_iViewportSize).xyz;\n\t\tvec3 luma = vec3(0.299, 0.587, 0.114);\n\t\tfloat lumaNW = dot(rgbNW, luma);\n\t\tfloat lumaNE = dot(rgbNE, luma);\n\t\tfloat lumaSW = dot(rgbSW, luma);\n\t\tfloat lumaSE = dot(rgbSE, luma);\n\t\tfloat lumaM  = dot(rgbM,  luma);\n\t\tfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\n\t\tfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\n\t\t\n\t\tvec2 dir;\n\t\tdir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\n\t\tdir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\n\t\t\n\t\tfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) * (0.25 * FXAA_REDUCE_MUL), FXAA_REDUCE_MIN);\n\t\t\n\t\tfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\n\t\tdir = min(vec2(FXAA_SPAN_MAX, FXAA_SPAN_MAX), max(vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX), dir * rcpDirMin)) * u_iViewportSize;\n\t\t\n\t\tvec3 rgbA = 0.5 * (texture2D(tex, fragCoord * u_iViewportSize + dir * (1.0 / 3.0 - 0.5)).xyz + \n\t\t\ttexture2D(tex, fragCoord * u_iViewportSize + dir * (2.0 / 3.0 - 0.5)).xyz);\n\t\tvec3 rgbB = rgbA * 0.5 + 0.25 * (texture2D(tex, fragCoord * u_iViewportSize + dir * -0.5).xyz + \n\t\t\ttexture2D(tex, fragCoord * u_iViewportSize + dir * 0.5).xyz);\n\t\t\n\t\treturn vec4(rgbA,1.0);\n\t\tfloat lumaB = dot(rgbB, luma);\n\t\tif ((lumaB < lumaMin) || (lumaB > lumaMax))\n\t\t\tcolor = vec4(rgbA, 1.0);\n\t\telse\n\t\t\tcolor = vec4(rgbB, 1.0);\n\t\treturn color;\n\t}\n";
Shader.getFXAAShader=function(a){a=a||r.gl;var b=a.shaders[":fxaa"];if(b)return b;var b=new p.Shader(Shader.SCREEN_VERTEX_SHADER,"\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\t"+Shader.FXAA_FUNC+"\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t   gl_FragColor = applyFXAA( u_texture, v_coord * u_viewportSize) ;\n\t\t\t}\n\t\t\t"),c=vec2.fromValues(a.viewport_data[2],a.viewport_data[3]),d=vec2.fromValues(1/a.viewport_data[2],1/a.viewport_data[3]);b.setup=
function(){c[0]=a.viewport_data[2];c[1]=a.viewport_data[3];d[0]=1/a.viewport_data[2];d[1]=1/a.viewport_data[3];this.uniforms({u_viewportSize:c,u_iViewportSize:d})};return a.shaders[":fxaa"]=b};Shader.getFlatShader=function(a){a=a||r.gl;var b=a.shaders[":flat"];if(b)return b;b=new p.Shader(Shader.FLAT_VERTEX_SHADER,Shader.FLAT_FRAGMENT_SHADER);b.uniforms({u_color:[1,1,1,1]});return a.shaders[":flat"]=b};p.create=function(a){function b(a){var c=m.mouse_buttons;p.augmentEvent(a,k);a.eventType=a.eventType||
a.type;var d=getTime();q.dragging=a.dragging;q.x=a.canvasx;q.y=a.canvasy;q.left_button=m.mouse_buttons&1<<p.LEFT_MOUSE_BUTTON;q.right_button=m.mouse_buttons&1<<p.RIGHT_MOUSE_BUTTON;if("mousedown"==a.eventType){a.leftButton&&(q.left_button=!0);a.rightButton&&(q.right_button=!0);0==c&&(k.removeEventListener("mousemove",b),c=k.ownerDocument,c.addEventListener("mousemove",b),c.addEventListener("mouseup",b));w=d;if(m.onmousedown)m.onmousedown(a);x.trigger(m,"mousedown")}else if("mousemove"==a.eventType){if(m.onmousemove)m.onmousemove(a);
x.trigger(m,"mousemove",a)}else if("mouseup"==a.eventType){0==m.mouse_buttons&&(k.addEventListener("mousemove",b),c=k.ownerDocument,c.removeEventListener("mousemove",b),c.removeEventListener("mouseup",b));a.click_time=d-w;w=d;if(m.onmouseup)m.onmouseup(a);x.trigger(m,"mouseup",a)}else if("mousewheel"==a.eventType||"wheel"==a.eventType||"DOMMouseScroll"==a.eventType){a.eventType="mousewheel";a.wheel="wheel"==a.type?-a.deltaY:null!=a.wheelDeltaY?a.wheelDeltaY:-60*a.detail;a.delta=a.wheelDelta?a.wheelDelta/
40:a.deltaY?-a.deltaY/3:0;if(m.onmousewheel)m.onmousewheel(a);x.trigger(m,"mousewheel",a)}if(m.onmouse)m.onmouse(a);"mousemove"!=a.eventType&&a.stopPropagation();a.preventDefault();return!1}function c(a){var b=event.changedTouches,c=b[0],d="";if(!(a.touches.length&&a.changedTouches[0].identifier!==a.touches[0].identifier||1<b)){switch(event.type){case "touchstart":d="mousedown";break;case "touchmove":d="mousemove";break;case "touchend":d="mouseup";break;default:return}a=document.createEvent("MouseEvent");
a.initMouseEvent(d,!0,!0,window,1,c.screenX,c.screenY,c.clientX,c.clientY,!1,!1,!1,!1,0,null);c.target.dispatchEvent(a);event.preventDefault()}}function d(a){m.ongesture&&(a.eventType=a.type,m.ongesture(a));event.preventDefault()}function g(a,b){console.log(a);if(b&&m.onbuttondown)m.onbuttondown(a);else if(!b&&m.onbuttonup)m.onbuttonup(a);if(m.onbutton)m.onbutton(a);x.trigger(m,b?"buttondown":"buttonup",a)}function h(a){console.log(a);if(m.ongamepad)m.ongamepad(a)}a=a||{};var k=null;if(a.canvas)if("string"==
typeof a.canvas){if(k=document.getElementById(a.canvas),!k)throw"Canvas element not found: "+a.canvas;}else k=a.canvas;else k=createCanvas(a.width||800,a.height||600);"alpha"in a||(a.alpha=!1);try{r.gl=k.getContext("webgl",a)}catch(n){}try{r.gl=r.gl||k.getContext("experimental-webgl",a)}catch(l){}if(!r.gl)throw"WebGL not supported";var m=r.gl;k.is_webgl=!0;m.context_id=this.last_context_id++;m.extensions={};m.extensions.OES_standard_derivatives=m.derivatives_supported=m.getExtension("OES_standard_derivatives")||
!1;m.extensions.WEBGL_depth_texture=m.getExtension("WEBGL_depth_texture")||m.getExtension("WEBKIT_WEBGL_depth_texture")||m.getExtension("MOZ_WEBGL_depth_texture");m.extensions.OES_element_index_uint=m.getExtension("OES_element_index_uint");m.extensions.WEBGL_draw_buffers=m.getExtension("WEBGL_draw_buffers");m.extensions.EXT_shader_texture_lod=m.getExtension("EXT_shader_texture_lod");m.extensions.EXT_sRGB=m.getExtension("EXT_sRGB");m.extensions.EXT_texture_filter_anisotropic=m.getExtension("EXT_texture_filter_anisotropic")||
m.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||m.getExtension("MOZ_EXT_texture_filter_anisotropic");m.extensions.EXT_frag_depth=m.getExtension("EXT_frag_depth")||m.getExtension("WEBKIT_EXT_frag_depth")||m.getExtension("MOZ_EXT_frag_depth");m.extensions.WEBGL_lose_context=m.getExtension("WEBGL_lose_context")||m.getExtension("WEBKIT_WEBGL_lose_context")||m.getExtension("MOZ_WEBGL_lose_context");m.extensions.OES_texture_float_linear=m.getExtension("OES_texture_float_linear");m.extensions.OES_texture_float_linear&&
(m.extensions.OES_texture_float=m.getExtension("OES_texture_float"));m.extensions.OES_texture_half_float_linear=m.getExtension("OES_texture_half_float_linear");m.extensions.OES_texture_half_float_linear&&(m.extensions.OES_texture_half_float=m.getExtension("OES_texture_half_float"));m.HALF_FLOAT_OES=36193;m.extensions.OES_texture_half_float&&(m.HALF_FLOAT_OES=m.extensions.OES_texture_half_float.HALF_FLOAT_OES);m.HIGH_PRECISION_FORMAT=m.extensions.OES_texture_half_float?m.HALF_FLOAT_OES:m.extensions.OES_texture_float?
m.FLOAT:m.UNSIGNED_BYTE;m.max_texture_units=m.getParameter(m.MAX_TEXTURE_IMAGE_UNITS);m._viewport_func=m.viewport;m.viewport_data=new Float32Array([0,0,m.canvas.width,m.canvas.height]);m.viewport=function(a,b,c,d){var g=this.viewport_data;g[0]=a|0;g[1]=b|0;g[2]=c|0;g[3]=d|0;this._viewport_func(a,b,c,d)};m.getViewport=function(a){return a?(a[0]=m.viewport_data[0],a[1]=m.viewport_data[1],a[2]=m.viewport_data[2],a[3]=m.viewport_data[3],a):new Float32Array(m.viewport_data)};m.setViewport=function(a){m.viewport_data.set(a);
this._viewport_func(a[0],a[1],a[2],a[3])};if("undefined"==typeof glMatrix)throw"glMatrix not found, LiteGL requires glMatrix to be included";var w=0;m.mouse_buttons=0;m.shaders={};m.textures={};m.meshes={};m.makeCurrent=function(){r.gl=this};m.execute=function(a){var b=r.gl;r.gl=this;a();r.gl=b};m.animate=function(a){function b(){if(!m.destroyed){g._requestFrame_id=c(b);var a=getTime(),h=0.001*(a-d);if(g.onupdate)g.onupdate(h);x.trigger(m,"update",h);g.ondraw&&(h=r.gl,r.gl=g,g.ondraw(),x.trigger(m,
"draw"),r.gl=h);d=a}}if(!1===a)r.cancelAnimationFrame(this._requestFrame_id),this._requestFrame_id=null;else{var c=r.requestAnimationFrame,d=getTime(),g=this;this._requestFrame_id=c(b)}};m.destroy=function(){A&&(document.removeEventListener("keydown",A),document.removeEventListener("keyup",A));this.canvas.parentNode&&this.canvas.parentNode.removeChild(this.canvas);this.destroyed=!0;r.gl==this&&(r.gl=null)};var q=m.mouse={left_button:!1,middle_button:!1,right_button:!1,x:0,y:0,deltax:0,deltay:0,isInsideRect:function(a,
b,c,d,g){var h=this.y;g&&(h=m.canvas.height-h);return this.x>a&&this.x<a+c&&h>b&&h<b+d?!0:!1}};m.captureMouse=function(a){k.addEventListener("mousedown",b);k.addEventListener("mousemove",b);a&&(k.addEventListener("mousewheel",b,!1),k.addEventListener("wheel",b,!1));k.addEventListener("contextmenu",function(a){a.preventDefault();return!1});k.addEventListener("touchstart",c,!0);k.addEventListener("touchmove",c,!0);k.addEventListener("touchend",c,!0);k.addEventListener("touchcancel",c,!0);k.addEventListener("gesturestart",
d);k.addEventListener("gesturechange",d);k.addEventListener("gestureend",d)};m.keys={};var A=null;m.captureKeys=function(a,b){function c(b){var d=a;b.eventType=b.type;var g=b.target.nodeName.toLowerCase();if("input"!==g&&"textarea"!==g&&"select"!==g){b.character=String.fromCharCode(b.keyCode).toLowerCase();var g=!1,h=p.mapKeyCode(b.keyCode);h||(h=b.character);b.altKey||b.ctrlKey||b.metaKey||(h&&(m.keys[h]="keydown"==b.type),g=m.keys[b.keyCode],m.keys[b.keyCode]="keydown"==b.type);if(g!=m.keys[b.keyCode]){if("keydown"==
b.type&&m.onkeydown)m.onkeydown(b);else if("keyup"==b.type&&m.onkeyup)m.onkeyup(b);x.trigger(m,b.type,b)}if(m.onkey)m.onkey(b);d&&(b.isChar||p.blockable_keys[b.keyIdentifier||b.key])&&b.preventDefault()}}A||(m.keys={},document.addEventListener("keydown",c),document.addEventListener("keyup",c),A=c)};m.gamepads=null;m.captureGamepads=function(){var a=navigator.getGamepads||navigator.webkitGetGamepads||navigator.mozGetGamepads;a&&(this.gamepads=a.call(navigator),window.addEventListener("gamepadButtonDown",
function(a){g(a,!0)},!1),window.addEventListener("MozGamepadButtonDown",function(a){g(a,!0)},!1),window.addEventListener("WebkitGamepadButtonDown",function(a){g(a,!0)},!1),window.addEventListener("gamepadButtonUp",function(a){g(a,!1)},!1),window.addEventListener("MozGamepadButtonUp",function(a){g(a,!1)},!1),window.addEventListener("WebkitGamepadButtonUp",function(a){g(a,!1)},!1),window.addEventListener("gamepadconnected",h,!1),window.addEventListener("gamepaddisconnected",h,!1))};m.getGamepads=function(){var a=
navigator.getGamepads||navigator.webkitGetGamepads||navigator.mozGetGamepads;if(a){for(var a=a.call(navigator),b=null,c=0;4>c;c++)if(a[c]){b=a[c];if(this.gamepads)if(!this.gamepads[c]&&a[c]&&this.ongamepadconnected)this.ongamepadconnected(b);else if(this.gamepads[c]&&!a[c]&&this.ongamepaddisconnected)this.ongamepaddisconnected(this.gamepads[c]);var d={axes:[],buttons:{},hat:""};d.axes.lx=b.axes[0];d.axes.ly=b.axes[1];d.axes.rx=b.axes[2];d.axes.ry=b.axes[3];d.axes.triggers=b.axes[4];for(c=0;c<b.buttons.length;c++)switch(c){case 0:d.buttons.a=
b.buttons[c].pressed;break;case 1:d.buttons.b=b.buttons[c].pressed;break;case 2:d.buttons.x=b.buttons[c].pressed;break;case 3:d.buttons.y=b.buttons[c].pressed;break;case 4:d.buttons.lb=b.buttons[c].pressed;break;case 5:d.buttons.rb=b.buttons[c].pressed;break;case 6:d.buttons.lt=b.buttons[c].pressed;break;case 7:d.buttons.rt=b.buttons[c].pressed;break;case 8:d.buttons.back=b.buttons[c].pressed;break;case 9:d.buttons.start=b.buttons[c].pressed;break;case 10:d.buttons.ls=b.buttons[c].pressed;break;case 11:d.buttons.rs=
b.buttons[c].pressed;break;case 12:b.buttons[c].pressed&&(d.hat+="up");break;case 13:b.buttons[c].pressed&&(d.hat+="down");break;case 14:b.buttons[c].pressed&&(d.hat+="left");break;case 15:b.buttons[c].pressed&&(d.hat+="right");break;case 16:d.buttons.home=b.buttons[c].pressed}b.xbox=d}return this.gamepads=a}};m.fullscreen=function(){var a=this.canvas;a.requestFullScreen?a.requestFullScreen():a.webkitRequestFullScreen?a.webkitRequestFullScreen():a.mozRequestFullScreen?a.mozRequestFullScreen():console.error("Fullscreen not supported")};
m.snapshot=function(a,b,c,d,g){var h=createCanvas(c,d),k=h.getContext("2d"),l=k.getImageData(0,0,h.width,h.height),n=new Uint8Array(c*d*4);m.readPixels(a,b,h.width,h.height,m.RGBA,m.UNSIGNED_BYTE,n);l.data.set(n);k.putImageData(l,0,0);if(g)return h;a=createCanvas(c,d);k=a.getContext("2d");k.translate(0,d);k.scale(1,-1);k.drawImage(h,0,0);return a};var s={};m.loadTexture=function(a,b,c){if(this.textures[a])return this.textures[a];if(s[a])return null;var d=new Image;d.url=a;d.onload=function(){var a=
p.Texture.fromImage(this,b);a.img=this;m.textures[this.url]=a;delete s[this.url];c&&c(a)};d.src=a;s[a]=!0;return null};m.drawTexture=function(){var a=mat3.create(),b=vec2.create(),c=vec2.create(),d=vec4.create(),g=vec4.fromValues(1,1,1,1),h=vec2.create(),k={u_texture:0,u_position:b,u_color:g,u_size:c,u_texture_area:d,u_viewport:h,u_transform:a};return function(a,g,l,n,q,p,r,s,w,t,A){b[0]=g;b[1]=l;void 0===n&&(n=a.width);void 0===q&&(q=a.height);c[0]=n;c[1]=q;void 0===p&&(p=0);void 0===r&&(r=0);void 0===
s&&(s=a.width);void 0===w&&(w=a.height);d[0]=p/a.width;d[1]=r/a.height;d[2]=(p+s)/a.width;d[3]=(r+w)/a.height;h[0]=this.viewport_data[2];h[1]=this.viewport_data[3];t=t||Shader.getPartialQuadShader(this);g=Mesh.getScreenQuad(this);a.bind(0);t.uniforms(k);A&&t.uniforms(A);t.draw(g,m.TRIANGLES)}}();m.canvas.addEventListener("webglcontextlost",function(a){a.preventDefault();if(m.onlosecontext)m.onlosecontext(a)},!1);m.reset=function(){m.viewport(0,0,this.canvas.width,this.canvas.height);m.disable(m.BLEND);
m.disable(m.CULL_FACE);m.disable(m.DEPTH_TEST);m.frontFace(m.CCW);m._current_texture_drawto=null;m._current_fbo_color=null;m._current_fbo_depth=null};m.reset();return m};p.mapKeyCode=function(a){return{8:"BACKSPACE",9:"TAB",13:"ENTER",16:"SHIFT",17:"CTRL",27:"ESCAPE",32:"SPACE",37:"LEFT",38:"UP",39:"RIGHT",40:"DOWN"}[a]||(65<=a&&90>=a?String.fromCharCode(a):null)};p.dragging=!1;p.last_pos=[0,0];p.augmentEvent=function(a,b){var c=null;b=b||a.target||gl.canvas;c=b.getBoundingClientRect();a.mousex=a.pageX-
c.left;a.mousey=a.pageY-c.top;a.canvasx=a.mousex;a.canvasy=c.height-a.mousey;a.deltax=0;a.deltay=0;"mousedown"==a.type?(this.dragging=!0,gl.mouse_buttons|=1<<a.which):"mousemove"!=a.type&&"mouseup"==a.type&&(gl.mouse_buttons&=~(1<<a.which),0==gl.mouse_buttons&&(this.dragging=!1));a.deltax=a.mousex-this.last_pos[0];a.deltay=a.mousey-this.last_pos[1];this.last_pos[0]=a.mousex;this.last_pos[1]=a.mousey;a.dragging=this.dragging;a.buttons_mask=gl.mouse_buttons;a.leftButton=gl.mouse_buttons&1<<p.LEFT_MOUSE_BUTTON;
a.rightButton=gl.mouse_buttons&1<<p.RIGHT_MOUSE_BUTTON;a.isButtonPressed=function(a){return this.buttons_mask&1<<a}};var x=r.LEvent=p.LEvent={bind:function(a,b,c,d){if(!a)throw"cannot bind event to null";if(!c)throw"cannot bind to null callback";if(a.constructor===String)throw"cannot bind event to a string";var g=a.__levents;g||(Object.defineProperty(a,"__levents",{value:{},enumerable:!1}),g=a.__levents);g.hasOwnProperty(b)?g[b].push([c,d]):g[b]=[[c,d]]},unbind:function(a,b,c,d){if(!a)throw"cannot unbind event to null";
if(!c)throw"cannot unbind from null callback";if(a.constructor===String)throw"cannot bind event to a string";if((a=a.__levents)&&a.hasOwnProperty(b)){for(var g=0,h=a[b].length;g<h;++g){var k=a[b][g];if(k[0]===c&&k[1]===d){a[b].splice(g,1);break}}0==a[b].length&&delete a[b]}},unbindAll:function(a,b){if(!a)throw"cannot unbind events in null";var c=a.__levents;if(c)if(b)for(var d in c)for(var g=c[d],h=g.length-1;0<=h;--h)g[h][1]==b&&g.splice(h,1);else delete a.__levents},unbindAllEvent:function(a,b){if(!a)throw"cannot unbind events in null";
var c=a.__levents;c&&delete c[b]},isBind:function(a,b,c,d){if(!a)throw"LEvent cannot have null as instance";if(a=a.__levents){if(!a.hasOwnProperty(b))return!1;for(var g=0,h=a[b].length;g<h;++g){var k=a[b][g];if(k[0]===c&&k[1]===d)return!0}return!1}},hasBind:function(a,b){if(!a)throw"LEvent cannot have null as instance";var c=a.__levents;return c&&c.hasOwnProperty(b)&&c[b].length?!0:!1},hasBindTo:function(a,b){if(!a)throw"LEvent cannot have null as instance";var c=a.__levents;if(!c||!c.hasOwnProperty(event_type)||
!c[event_type].length)return!1;for(var c=c[event_type],d=0;d<c.length;++d)if(c[d][1]==b)return!0;return!1},trigger:function(a,b,c){if(!a)throw"cannot trigger event from null";if(a.constructor===String)throw"cannot bind event to a string";a=a.__levents;if(!a||!a.hasOwnProperty(b))return!0;a=a[b];for(var d=0,g=a.length;d<g;++d){var h=a[d];if(h&&!1==h[0].call(h[1],b,c))return!1}return!0},triggerArray:function(a,b,c){for(var d=0,g=a.length;d<g;++d){var h=a[d];if(!h)throw"cannot trigger event from null";
if(h.constructor===String)throw"cannot bind event to a string";if((h=h.__levents)&&h.hasOwnProperty(b))for(var k=0,n=h[b].length;k<n;++k){var l=h[b][k];if(!1==l[0].call(l[1],b,c))break}}return!0}};r.CLIP_INSIDE=p.CLIP_INSIDE=0;r.CLIP_OUTSIDE=p.CLIP_OUTSIDE=1;r.CLIP_OVERLAP=p.CLIP_OVERLAP=2;r.geo={createPlane:function(a,b){return new Float32Array([b[0],b[1],b[2],-vec3.dot(a,b)])},distancePointToPlane:function(a,b){return(vec3.dot(a,b)+b[3])/Math.sqrt(b[0]*b[0]+b[1]*b[1]+b[2]*b[2])},distance2PointToPlane:function(a,
b){return(vec3.dot(a,b)+b[3])/(b[0]*b[0]+b[1]*b[1]+b[2]*b[2])},projectPointOnPlane:function(a,b,c,d){d=d||vec3.create();b=vec3.subtract(vec3.create(),a,b);b=vec3.dot(b,c);return vec3.subtract(d,a,vec3.scale(vec3.create(),c,b))},reflectPointInPlane:function(a,b,c){b=-(-1*(b[0]*c[0]+b[1]*c[1]+b[2]*c[2])+c[0]*a[0]+c[1]*a[1]+c[2]*a[2])/(c[0]*c[0]+c[1]*c[1]+c[2]*c[2]);return vec3.fromValues(a[0]+b*c[0]*2,a[1]+b*c[1]*2,a[2]+b*c[2]*2)},testRayPlane:function(a,b,c,d,g){c=vec3.dot(c,d)-vec3.dot(d,a);d=vec3.dot(d,
b);if(Math.abs(d)<EPSILON)return!1;d=c/d;if(0>d)return!1;g&&vec3.add(g,a,vec3.scale(g,b,d));return!0},testSegmentPlane:function(){var a=vec3.create();return function(b,c,d,g,h){d=vec3.dot(d,g)-vec3.dot(g,b);c=vec3.sub(a,c,b);g=vec3.dot(g,c);if(Math.abs(g)<EPSILON)return!1;g=d/g;if(0>g||1<g)return!1;h&&vec3.add(h,b,vec3.scale(h,c,g));return!0}}(),testRaySphere:function(){var a=vec3.create();return function(b,c,d,g,h,k){var n=vec3.subtract(a,b,d),l=c[0]*c[0]+c[1]*c[1]+c[2]*c[2];d=2*n[0]*c[0]+2*n[1]*
c[1]+2*n[2]*c[2];g=d*d-4*l*(n[0]*n[0]+n[1]*n[1]+n[2]*n[2]-g*g);if(0>g)return!1;if(h){g=Math.sqrt(g);n=1/(2*l);l=(-d+g)*n;d=(-d-g)*n;d=l<d?l:d;if(d>k)return!1;vec3.add(h,b,vec3.scale(h,c,d))}return!0}}(),testRayCylinder:function(a,b,c,d,g,h){var k=vec3.clone(a);a=vec3.add(vec3.create(),a,vec3.scale(vec3.create(),b,1E5));var n=0;b=vec3.subtract(vec3.create(),d,c);var l=vec3.subtract(vec3.create(),k,c);c=vec3.subtract(vec3.create(),a,k);d=vec3.dot(l,b);a=vec3.dot(c,b);b=vec3.dot(b,b);if(0>d&&0>d+a||
d>b&&d+a>b)return!1;var m=vec3.dot(c,c),p=vec3.dot(l,c),n=b*m-a*a;g=vec3.dot(l,l)-g*g;var q=b*g-d*d;if(Math.abs(n)<EPSILON){if(0<q)return!1;n=0>d?-p/m:d>b?(a-p)/m:0;h&&vec3.add(h,k,vec3.scale(vec3.create(),c,n));return!0}l=b*p-a*d;q=l*l-n*q;if(0>q)return!1;n=(-l-Math.sqrt(q))/n;if(0>n||1<n)return!1;if(0>d+n*a){if(0>=a)return!1;n=-d/a;h&&vec3.add(h,k,vec3.scale(vec3.create(),c,n));return 0>=g+2*n*(p+n*m)}if(d+n*a>b){if(0<=a)return!1;n=(b-d)/a;h&&vec3.add(h,k,vec3.scale(vec3.create(),c,n));return 0>=
g+b-2*d+n*(2*(p-a)+n*m)}h&&vec3.add(h,k,vec3.scale(vec3.create(),c,n));return!0},testRayBox:function(a,b,c,d,g,h){g=g||vec3.create();h=h||Number.MAX_VALUE;for(var k=!0,n=new Float32Array(3),l=0,m=new Float32Array(3),p=new Float32Array(3),l=0;3>l;++l)a[l]<c[l]?(n[l]=1,p[l]=c[l],k=!1):a[l]>d[l]?(n[l]=0,p[l]=d[l],k=!1):n[l]=2;if(k)return vec3.copy(g,a),!0;for(l=0;3>l;++l)m[l]=2!=n[l]&&0!=b[l]?(p[l]-a[l])/b[l]:-1;k=0;for(l=1;3>l;l++)m[k]<m[l]&&(k=l);if(0>m[k]||m[k]>h)return!1;for(l=0;3>l;++l)if(k!=l){if(g[l]=
a[l]+m[k]*b[l],g[l]<c[l]||g[l]>d[l])return!1}else g[l]=p[l];return!0},testRayBBox:function(a,b,c,d,g,h){if(d){var k=mat4.invert(mat4.create(),d);b=vec3.add(vec3.create(),a,b);a=vec3.transformMat4(vec3.create(),a,k);vec3.transformMat4(b,b,k);vec3.sub(b,b,a);b=vec3.normalize(b,b)}a=this.testRayBox(a,b,c.subarray(6,9),c.subarray(9,12),g,h);d&&vec3.transformMat4(g,g,d);return a},testPointBBox:function(a,b){return a[0]<b[6]||a[0]>b[9]||a[1]<b[7]||a[0]>b[10]||a[2]<b[8]||a[0]>b[11]?!1:!0},testBBoxBBox:function(a,
b){if(Math.abs(b[0]-a[0])>a[3]+b[3]||Math.abs(b[1]-a[1])>a[4]+b[4]||Math.abs(b[2]-a[2])>a[5]+b[5])return!1;var c=BBox.getMin(b);geo.testPointBBox(c,a)&&(c=BBox.getMax(b),geo.testPointBBox(c,a));return!0},testSphereBBox:function(a,b,c){for(var d=0,g=BBox.getMin(c),h=BBox.getMax(c),k=0;3>k;++k)a[k]<g[k]?(c=a[k]-g[k],d+=c*c):a[k]>h[k]&&(c=a[k]-h[k],d+=c*c);return d<=b*b?!0:!1},closestPointBetweenLines:function(a,b,c,d,g,h){b=vec3.subtract(vec3.create(),b,a);d=vec3.subtract(vec3.create(),d,c);var k=vec3.subtract(vec3.create(),
a,c),n=vec3.dot(b,b),l=vec3.dot(b,d),m=vec3.dot(d,d),p=vec3.dot(b,k),q=vec3.dot(d,k),r=n*m-l*l,s;r<EPSILON?(s=0,n=l>m?p/l:q/m):(s=(l*q-m*p)/r,n=(n*q-l*p)/r);g&&vec3.add(g,a,vec3.scale(vec3.create(),b,s));h&&vec3.add(h,c,vec3.scale(vec3.create(),d,n));a=vec3.add(vec3.create(),k,vec3.subtract(vec3.create(),vec3.scale(vec3.create(),b,s),vec3.scale(vec3.create(),d,n)));return vec3.length(a)},extractPlanes:function(a,b){function c(a){var c=b.subarray(a,a+3),c=vec3.length(c);0!==c&&(c=1/c,b[a]*=c,b[a+1]*=
c,b[a+2]*=c,b[a+3]*=c)}b=b||new Float32Array(24);b.set([a[3]-a[0],a[7]-a[4],a[11]-a[8],a[15]-a[12]],0);c(0);b.set([a[3]+a[0],a[7]+a[4],a[11]+a[8],a[15]+a[12]],4);c(4);b.set([a[3]+a[1],a[7]+a[5],a[11]+a[9],a[15]+a[13]],8);c(8);b.set([a[3]-a[1],a[7]-a[5],a[11]-a[9],a[15]-a[13]],12);c(12);b.set([a[3]-a[2],a[7]-a[6],a[11]-a[10],a[15]-a[14]],16);c(16);b.set([a[3]+a[2],a[7]+a[6],a[11]+a[10],a[15]+a[14]],20);c(20);return b},frustumTestBox:function(a,b){var c=0,d=0,c=planeBoxOverlap(a.subarray(0,4),b);if(c==
CLIP_OUTSIDE)return CLIP_OUTSIDE;d+=c;c=planeBoxOverlap(a.subarray(4,8),b);if(c==CLIP_OUTSIDE)return CLIP_OUTSIDE;d+=c;c=planeBoxOverlap(a.subarray(8,12),b);if(c==CLIP_OUTSIDE)return CLIP_OUTSIDE;d+=c;c=planeBoxOverlap(a.subarray(12,16),b);if(c==CLIP_OUTSIDE)return CLIP_OUTSIDE;d+=c;c=planeBoxOverlap(a.subarray(16,20),b);if(c==CLIP_OUTSIDE)return CLIP_OUTSIDE;d+=c;c=planeBoxOverlap(a.subarray(20,24),b);return c==CLIP_OUTSIDE?CLIP_OUTSIDE:0==d+c?CLIP_INSIDE:CLIP_OVERLAP},frustumTestSphere:function(a,
b,c){var d,g=!1;d=distanceToPlane(a.subarray(0,4),b);if(d<-c)return CLIP_OUTSIDE;d>=-c&&d<=c&&(g=!0);d=distanceToPlane(a.subarray(4,8),b);if(d<-c)return CLIP_OUTSIDE;d>=-c&&d<=c&&(g=!0);d=distanceToPlane(a.subarray(8,12),b);if(d<-c)return CLIP_OUTSIDE;d>=-c&&d<=c&&(g=!0);d=distanceToPlane(a.subarray(12,16),b);if(d<-c)return CLIP_OUTSIDE;d>=-c&&d<=c&&(g=!0);d=distanceToPlane(a.subarray(16,20),b);if(d<-c)return CLIP_OUTSIDE;d>=-c&&d<=c&&(g=!0);d=distanceToPlane(a.subarray(20,24),b);if(d<-c)return CLIP_OUTSIDE;
d>=-c&&d<=c&&(g=!0);return g?CLIP_OVERLAP:CLIP_INSIDE},testPoint2DInPolygon:function(a,b){for(var c=!1,d=-1,g=a.length,h=g-1;++d<g;h=d)(a[d][1]<=b[1]&&b[1]<a[h][1]||a[h][1]<=b[1]&&b[1]<a[d][1])&&b[0]<(a[h][0]-a[d][0])*(b[1]-a[d][1])/(a[h][1]-a[d][1])+a[d][0]&&(c=!c);return c}};r.BBox=p.BBox={center:0,halfsize:3,min:6,max:9,radius:12,data_length:13,corners:new Float32Array([1,1,1,1,1,-1,1,-1,1,1,-1,-1,-1,1,1,-1,1,-1,-1,-1,1,-1,-1,-1]),tmp_corners:new Float32Array(24),create:function(){return new Float32Array(13)},
clone:function(a){return new Float32Array(a)},copy:function(a,b){a.set(b);return a},fromPoint:function(a){var b=this.create();b.set(a,0);b.set(a,6);b.set(a,9);return b},fromMinMax:function(a,b){var c=this.create();this.setMinMax(c,a,b);return c},fromCenterHalfsize:function(a,b){var c=this.create();this.setCenterHalfsize(c,a,b);return c},fromPoints:function(a){var b=this.create();this.setFromPoints(b,a);return b},setFromPoints:function(a,b){var c=a.subarray(6,9),d=a.subarray(9,12);c.set(b.subarray(0,
3));d.set(c);for(var g=0,h=3,k=b.length;h<k;h+=3)g=b.subarray(h,h+3),vec3.min(c,g,c),vec3.max(d,g,d);c=vec3.add(a.subarray(0,3),c,d);vec3.scale(c,c,0.5);vec3.subtract(a.subarray(3,6),d,c);a[12]=vec3.length(a.subarray(3,6));return a},setMinMax:function(a,b,c){a[6]=b[0];a[7]=b[1];a[8]=b[2];a[9]=c[0];a[10]=c[1];a[11]=c[2];var d=a.subarray(3,6);vec3.sub(d,c,b);vec3.scale(d,d,0.5);a[0]=c[0]-d[0];a[1]=c[1]-d[1];a[2]=c[2]-d[2];a[12]=vec3.length(a.subarray(3,6));return a},setCenterHalfsize:function(a,b,c,
d){a[0]=b[0];a[1]=b[1];a[2]=b[2];a[3]=c[0];a[4]=c[1];a[5]=c[2];vec3.sub(a.subarray(6,9),a.subarray(0,3),a.subarray(3,6));vec3.add(a.subarray(9,12),a.subarray(0,3),a.subarray(3,6));a[12]=d?d:vec3.length(c);return a},transformMat4:function(a,b,c){var d=b.subarray(3,6),g=this.tmp_corners;g.set(this.corners);for(var h=0;8>h;++h){var k=g.subarray(3*h,3*h+3);vec3.multiply(k,d,k);vec3.add(k,k,b);mat4.multiplyVec3(k,c,k)}return this.setFromPoints(a,g)},getCorners:function(a,b){var c=a.subarray(3,6),d=null;
b?(b.set(this.corners),d=b):d=new Float32Array(this.corners);for(var g=0;8>g;++g){var h=d.subarray(3*g,3*g+3);vec3.multiply(h,c,h);vec3.add(h,h,a)}return d},merge:function(a,b,c){a=a||BBox.create();var d=a.subarray(6,9),g=a.subarray(9,12);vec3.min(d,b.subarray(6,9),c.subarray(6,9));vec3.max(g,b.subarray(9,12),c.subarray(9,12));return BBox.setMinMax(a,d,g)},getCenter:function(a){return a.subarray(0,3)},getHalfsize:function(a){return a.subarray(3,6)},getMin:function(a){return a.subarray(6,9)},getMax:function(a){return a.subarray(9,
12)},getRadius:function(a){return a[12]}};r.distanceToPlane=p.distanceToPlane=function(a,b){return vec3.dot(a,b)+a[3]};r.planeBoxOverlap=p.planeBoxOverlap=function(a,b){var c=a[3],d=vec3.fromValues(Math.abs(b[3]*a[0]),Math.abs(b[4]*a[1]),Math.abs(b[5]*a[2])),d=d[0]+d[1]+d[2],c=vec3.dot(a,b)+c;return c<=-d?CLIP_OUTSIDE:c<=d?CLIP_OVERLAP:CLIP_INSIDE};r.Octree=p.Octree=function(a){this.root=null;this.total_nodes=this.total_depth=0;a&&(this.buildFromMesh(a),this.total_nodes=this.trim())};Octree.MAX_NODE_TRIANGLES_RATIO=
0.1;Octree.MAX_OCTREE_DEPTH=8;Octree.OCTREE_MARGIN_RATIO=0.01;Octree.OCTREE_MIN_MARGIN=0.1;Octree.prototype.buildFromMesh=function(a){this.total_nodes=this.total_depth=0;var b=a.getBuffer("vertices").data;if(a=a.getIndexBuffer("triangles"))a=a.data;var c=this.computeAABB(b);this.root=c;this.total_nodes=1;this.total_triangles=a?a.length/3:b.length/9;this.max_node_triangles=this.total_triangles*Octree.MAX_NODE_TRIANGLES_RATIO;var d=vec3.create();vec3.scale(d,c.size,Octree.OCTREE_MARGIN_RATIO);d[0]<
Octree.OCTREE_MIN_MARGIN&&(d[0]=Octree.OCTREE_MIN_MARGIN);d[1]<Octree.OCTREE_MIN_MARGIN&&(d[1]=Octree.OCTREE_MIN_MARGIN);d[2]<Octree.OCTREE_MIN_MARGIN&&(d[2]=Octree.OCTREE_MIN_MARGIN);vec3.sub(c.min,c.min,d);vec3.add(c.max,c.max,d);c.faces=[];c.inside=0;if(a)for(d=0;d<a.length;d+=3){var g=new Float32Array([b[3*a[d]],b[3*a[d]+1],b[3*a[d]+2],b[3*a[d+1]],b[3*a[d+1]+1],b[3*a[d+1]+2],b[3*a[d+2]],b[3*a[d+2]+1],b[3*a[d+2]+2]]);this.addToNode(g,c,0)}else for(d=0;d<b.length;d+=9)g=new Float32Array(b.subarray(d,
d+9)),this.addToNode(g,c,0);return c};Octree.prototype.addToNode=function(a,b,c){b.inside+=1;if(b.c){var d=this.computeAABB(a),g=!1,h;for(h in b.c){var k=b.c[h];if(Octree.isInsideAABB(d,k)){this.addToNode(a,k,c+1);g=!0;break}}g||(null==b.faces&&(b.faces=[]),b.faces.push(a))}else if(null==b.faces&&(b.faces=[]),b.faces.push(a),b.faces.length>this.max_node_triangles&&c<Octree.MAX_OCTREE_DEPTH){this.splitNode(b);this.total_depth<c+1&&(this.total_depth=c+1);var n=b.faces.concat();b.faces=null;for(h in n){a=
n[h];var d=this.computeAABB(a),g=!1,l;for(l in b.c)if(k=b.c[l],Octree.isInsideAABB(d,k)){this.addToNode(a,k,c+1);g=!0;break}g||(null==b.faces&&(b.faces=[]),b.faces.push(a))}}};Octree.prototype.octree_pos_ref=[[0,0,0],[0,0,1],[0,1,0],[0,1,1],[1,0,0],[1,0,1],[1,1,0],[1,1,1]];Octree.prototype.splitNode=function(a){a.c=[];var b=[0.5*(a.max[0]-a.min[0]),0.5*(a.max[1]-a.min[1]),0.5*(a.max[2]-a.min[2])],c;for(c in this.octree_pos_ref){var d=this.octree_pos_ref[c],g={};this.total_nodes+=1;g.min=[a.min[0]+
b[0]*d[0],a.min[1]+b[1]*d[1],a.min[2]+b[2]*d[2]];g.max=[g.min[0]+b[0],g.min[1]+b[1],g.min[2]+b[2]];g.faces=null;g.inside=0;a.c.push(g)}};Octree.prototype.computeAABB=function(a){for(var b=new Float32Array([a[0],a[1],a[2]]),c=new Float32Array([a[0],a[1],a[2]]),d=0;d<a.length;d+=3)for(var g=0;3>g;g++)b[g]>a[d+g]&&(b[g]=a[d+g]),c[g]<a[d+g]&&(c[g]=a[d+g]);return{min:b,max:c,size:vec3.sub(vec3.create(),c,b)}};Octree.prototype.trim=function(a){a=a||this.root;if(!a.c)return 1;for(var b=1,c=[],d=a.c,g=0;g<
d.length;++g)d[g].inside&&(c.push(d[g]),b+=this.trim(d[g]));a.c=c;return b};Octree.prototype.testRay=function(){var a=vec3.create(),b=vec3.create(),c=vec3.create(),d=vec3.create();return function(g,h,k,n){if(!this.root)throw"Error: octree not build";a.set(g);b.set(h);c.set(this.root.min);d.set(this.root.max);k=Octree.hitTestBox(a,b,c,d);if(!k)return null;k=Octree.testRayInNode(this.root,a,b);return null!=k?(h=vec3.scale(vec3.create(),h,k.t),vec3.add(h,h,g),k.pos=h,k):null}}();Octree.prototype.testSphere=
function(a,b){a=vec3.clone(a);if(!this.root)throw"Error: octree not build";var c=b*b;return Octree.testSphereBox(a,c,vec3.clone(this.root.min),vec3.clone(this.root.max))?Octree.testSphereInNode(this.root,a,c):!1};Octree.testRayInNode=function(a,b,c){var d=null,g=null;if(a.faces)for(var h=0,k=a.faces.length;h<k;++h)d=a.faces[h],d=Octree.hitTestTriangle(b,c,d.subarray(0,3),d.subarray(3,6),d.subarray(6,9)),null!=d&&(g?g.mergeWith(d):g=d);var k=vec3.create(),n=vec3.create(),l;if(a.c)for(h=0;h<a.c.length;++h)l=
a.c[h],k.set(l.min),n.set(l.max),d=Octree.hitTestBox(b,c,k,n),null==d||g&&d.t>g.t||(d=Octree.testRayInNode(l,b,c),null!=d&&(g?g.mergeWith(d):g=d));return g};Octree.testSphereInNode=function(a,b,c){if(a.faces)for(var d=0,g=a.faces.length;d<g;++d){var h=a.faces[d];if(Octree.testSphereTriangle(b,c,h.subarray(0,3),h.subarray(3,6),h.subarray(6,9)))return!0}var g=vec3.create(),h=vec3.create(),k;if(a.c)for(d=0;d<a.c.length;++d)if(k=a.c[d],g.set(k.min),h.set(k.max),Octree.testSphereBox(b,c,g,h)&&Octree.testSphereInNode(k,
b,c))return!0;return!1};Octree.isInsideAABB=function(a,b){return a.min[0]<b.min[0]||a.min[1]<b.min[1]||a.min[2]<b.min[2]||a.max[0]>b.max[0]||a.max[1]>b.max[1]||a.max[2]>b.max[2]?!1:!0};Octree.hitTestBox=function(){var a=vec3.create(),b=vec3.create(),c=vec3.create(),d=vec3.create(),g=vec3.create(),h=vec3.create(),k=vec3.fromValues(1E-6,1E-6,1E-6);return function(n,l,m,p){vec3.subtract(a,m,n);vec3.subtract(b,p,n);if(0>vec3.maxValue(a)&&0<vec3.minValue(b))return new HitTest(0,n,l);c[0]=1/l[0];c[1]=1/
l[1];c[2]=1/l[2];vec3.multiply(a,a,c);vec3.multiply(b,b,c);vec3.min(d,a,b);vec3.max(g,a,b);var q=vec3.maxValue(d),r=vec3.minValue(g);return 0<q&&q<r?(n=vec3.add(vec3.create(),vec3.scale(h,l,q),n),vec3.add(m,m,k),vec3.subtract(m,m,k),new HitTest(q,n,vec3.fromValues((n[0]>p[0])-(n[0]<m[0]),(n[1]>p[1])-(n[1]<m[1]),(n[2]>p[2])-(n[2]<m[2])))):null}}();Octree.hitTestTriangle=function(){var a=vec3.create(),b=vec3.create(),c=vec3.create(),d=vec3.create();return function(g,h,k,n,l){vec3.subtract(a,n,k);vec3.subtract(b,
l,k);n=vec3.cross(vec3.create(),a,b);vec3.normalize(n,n);if(0<vec3.dot(n,h))return null;l=vec3.dot(n,vec3.subtract(d,k,g))/vec3.dot(n,h);if(0<l){h=vec3.scale(vec3.create(),h,l);vec3.add(h,h,g);vec3.subtract(c,h,k);g=vec3.dot(b,b);k=vec3.dot(b,a);var m=vec3.dot(b,c),p=vec3.dot(a,a),q=vec3.dot(a,c),r=g*p-k*k,p=(p*m-k*q)/r;g=(g*q-k*m)/r;if(0<=p&&0<=g&&1>=p+g)return new HitTest(l,h,n)}return null}}();Octree.testSphereTriangle=function(){var a=vec3.create(),b=vec3.create(),c=vec3.create(),d=vec3.create(),
g=vec3.create(),h=vec3.create(),k=vec3.create(),n=vec3.create();return function(l,m,p,q,r){vec3.sub(a,p,l);vec3.sub(b,q,l);vec3.sub(c,r,l);vec3.sub(d,b,a);vec3.sub(g,c,a);vec3.cross(n,d,g);l=vec3.dot(a,n);p=vec3.dot(n,n);l=l*l>m*p;var s=vec3.dot(a,a),t=vec3.dot(a,b),u=vec3.dot(a,c),y=vec3.dot(b,b),F=vec3.dot(b,c),v=vec3.dot(c,c);p=s>m&t>s&u>s;q=y>m&t>y&F>y;r=v>m&u>v&F>v;var s=t-s,t=F-y,x=u-v;vec3.sub(h,c,b);vec3.sub(k,a,c);y=vec3.dot(d,d);v=vec3.dot(h,h);u=vec3.dot(k,k);F=vec3.scale(vec3.create(),
a,y);vec3.sub(F,F,vec3.scale(vec3.create(),d,s));s=vec3.scale(vec3.create(),b,v);vec3.sub(s,s,vec3.scale(vec3.create(),h,t));t=vec3.scale(vec3.create(),c,u);vec3.sub(t,t,vec3.scale(vec3.create(),k,x));var E=vec3.scale(vec3.create(),c,y),E=vec3.sub(E,E,F),N=vec3.scale(vec3.create(),a,v),N=vec3.sub(N,N,s),x=vec3.scale(vec3.create(),b,u),x=vec3.sub(x,x,t),y=vec3.dot(F,F)>m*y*y&0<vec3.dot(F,E),v=vec3.dot(s,s)>m*v*v&0<vec3.dot(s,N);m=vec3.dot(t,t)>m*u*u&0<vec3.dot(t,x);return!(l|p|q|r|y|v|m)}}();Octree.testSphereBox=
function(a,b,c,d){for(var g,h=0,k=0;3>k;++k)a[k]<c[k]?(g=a[k]-c[k],h+=g*g):a[k]>d[k]&&(g=a[k]-d[k],h+=g*g);return h<=b?!0:!1};r.HitTest=p.HitTest=function(a,b,c){this.t=arguments.length?a:Number.MAX_VALUE;this.hit=b;this.normal=c};HitTest.prototype={mergeWith:function(a){0<a.t&&a.t<this.t&&(this.t=a.t,this.hit=a.hit,this.normal=a.normal)}};r.Raytracer=p.Raytracer=function(a,b){this.viewport=b=b||gl.getViewport();var c=b[0],d=c+b[2],g=b[1],h=g+b[3];this.ray00=vec3.unproject(vec3.create(),vec3.fromValues(c,
g,1),a,b);this.ray10=vec3.unproject(vec3.create(),vec3.fromValues(d,g,1),a,b);this.ray01=vec3.unproject(vec3.create(),vec3.fromValues(c,h,1),a,b);this.ray11=vec3.unproject(vec3.create(),vec3.fromValues(d,h,1),a,b);c=this.eye=vec3.create();vec3.unproject(c,c,a,b);vec3.subtract(this.ray00,this.ray00,c);vec3.subtract(this.ray10,this.ray10,c);vec3.subtract(this.ray01,this.ray01,c);vec3.subtract(this.ray11,this.ray11,c)};Raytracer.prototype.getRayForPixel=function(a,b){a=(a-this.viewport[0])/this.viewport[2];
b=1-(b-this.viewport[1])/this.viewport[3];var c=vec3.lerp(vec3.create(),this.ray00,this.ray10,a),d=vec3.lerp(vec3.create(),this.ray01,this.ray11,a);return vec3.normalize(vec3.create(),vec3.lerp(vec3.create(),c,d,b))};var U=mat4.create();Raytracer.hitTestBox=function(a,b,c,d,g){var h=new Float32Array(30);g&&(g=mat4.invert(U,g),a=mat4.multiplyVec3(h.subarray(3,6),g,a),b=mat4.rotateVec3(h.subarray(6,9),g,b));var k=vec3.subtract(h.subarray(9,12),c,a);vec3.divide(k,k,b);var n=vec3.subtract(h.subarray(12,
15),d,a);vec3.divide(n,n,b);g=vec3.min(h.subarray(15,18),k,n);k=vec3.max(h.subarray(18,21),k,n);g=vec3.maxValue(g);k=vec3.minValue(k);return 0<g&&g<=k?(b=vec3.scale(h.subarray(21,24),b,g),vec3.add(b,a,b),vec3.addValue(h.subarray(24,27),c,1E-6),vec3.subValue(h.subarray(27,30),d,1E-6),new HitTest(g,b,vec3.fromValues((b[0]>d[0])-(b[0]<c[0]),(b[1]>d[1])-(b[1]<c[1]),(b[2]>d[2])-(b[2]<c[2])))):null};Raytracer.hitTestSphere=function(a,b,c,d){var g=vec3.subtract(vec3.create(),a,c),h=vec3.dot(b,b),k=2*vec3.dot(b,
g),g=vec3.dot(g,g)-d*d,g=k*k-4*h*g;return 0<g?(h=(-k-Math.sqrt(g))/(2*h),a=vec3.add(vec3.create(),a,vec3.scale(vec3.create(),b,h)),new HitTest(h,a,vec3.scale(vec3.create(),vec3.subtract(vec3.create(),a,c),1/d))):null};Raytracer.hitTestTriangle=function(a,b,c,d,g){var h=vec3.subtract(vec3.create(),d,c),k=vec3.subtract(vec3.create(),g,c);g=vec3.cross(vec3.create(),h,k);vec3.normalize(g,g);d=vec3.dot(g,vec3.subtract(vec3.create(),c,a))/vec3.dot(g,b);if(0<d){a=vec3.add(vec3.create(),a,vec3.scale(vec3.create(),
b,d));var n=vec3.subtract(vec3.create(),a,c);c=vec3.dot(k,k);b=vec3.dot(k,h);var k=vec3.dot(k,n),l=vec3.dot(h,h),h=vec3.dot(h,n),n=c*l-b*b,l=(l*k-b*h)/n,h=(c*h-b*k)/n;if(0<=l&&0<=h&&1>=l+h)return new HitTest(d,a,g)}return null};Mesh.parseOBJ=function(a,b){b=b||{};for(var c=[],d=[],g=[],h=[],k=[],n=[],l=[],m={},p=0,q=null,r=null,s=0,t=0,u=r=0,y=0,x=0,v=null,E=!1,M=!1,N=!1,O=!1,P=0,K=b.noindex?b.noindex:1E7<a.length?!0:!1,G=b.flipAxis,H=G||b.flipNormals,z=null,B=[],C=a.split("\n"),D=C.length,J=0;J<
D;++J)if(q=C[J].replace(/[ \t]+/g," ").replace(/\s\s*$/,""),"#"!=q[0]&&""!=q)if(v=q.split(" "),O&&"v"==v[0]&&(O=!1),"v"==v[0])G?k.push(-1*parseFloat(v[1]),parseFloat(v[3]),parseFloat(v[2])):k.push(parseFloat(v[1]),parseFloat(v[2]),parseFloat(v[3]));else if("vt"==v[0])n.push(parseFloat(v[1]),parseFloat(v[2]));else if("vn"==v[0])H?l.push(-parseFloat(v[2]),-parseFloat(v[3]),parseFloat(v[1])):l.push(parseFloat(v[1]),parseFloat(v[2]),parseFloat(v[3]));else if("f"==v[0]){if(O=!0,!(4>v.length)){for(var L=
[],q=1;q<v.length;++q){if(!(v[q]in m)||K){r=v[q].split("/");if(1==r.length)r=t=s=parseInt(r[0])-1;else if(2==r.length)s=parseInt(r[0])-1,t=parseInt(r[1])-1,r=-1;else if(3==r.length)s=parseInt(r[0])-1,t=parseInt(r[1])-1,r=parseInt(r[2])-1;else return console.err("Problem parsing: unknown number of values per face"),!1;3<q&&K&&(u=c.length,c.push(c[u-9*(q-3)],c[u-9*(q-3)+1],c[u-9*(q-3)+2]),c.push(c[u-3],c[u-2],c[u-1]),u=d.length,d.push(d[u-6*(q-3)],d[u-6*(q-3)+1]),d.push(d[u-2],d[u-1]),u=g.length,g.push(g[u-
9*(q-3)],g[u-9*(q-3)+1],g[u-9*(q-3)+2]),g.push(g[u-3],g[u-2],g[u-1]));x=y=u=0;3*s+2<k.length&&(E=!0,u=k[3*s+0],y=k[3*s+1],x=k[3*s+2]);c.push(u,y,x);y=u=0;2*t+1<n.length&&(M=!0,u=n[2*t+0],y=n[2*t+1]);d.push(u,y);y=u=0;x=1;-1!=r&&(3*r+2<l.length&&(N=!0,u=l[3*r+0],y=l[3*r+1],x=l[3*r+2]),g.push(u,y,x));K||(m[v[q]]=p++)}K||(s=m[v[q]],L.push(s),P<s&&(P=s))}if(!K)for(q=2;q<L.length;q++)h.push(L[0],L[q-1],L[q])}}else"g"==v[0]||"usemtl"==v[0]?1<v.length&&(null!=z&&(z.length=h.length-z.start,0<z.length&&B.push(z)),
z={name:v[1],start:h.length,length:-1,material:""}):"usemtl"==v[0]&&z&&(z.material=v[1]);if(!k.length)return console.error("OBJ doesnt have vertices, maybe the file is not a OBJ"),null;z&&1<h.length-z.start&&(z.length=h.length-z.start,B.push(z));if((65536<P||K)&&0<h.length){console.log("Deindexing mesh...");k=new Float32Array(3*h.length);n=g&&g.length?new Float32Array(3*h.length):null;l=d&&d.length?new Float32Array(2*h.length):null;for(q=0;q<h.length;q+=1)k.set(c.slice(3*h[q],3*h[q]+3),3*q),n&&n.set(g.slice(3*
h[q],3*h[q]+3),3*q),l&&l.set(d.slice(2*h[q],2*h[q]+2),2*q);c=k;n&&(g=n);l&&(d=l);h=null}q={};E&&(q.vertices=new Float32Array(c));N&&0<g.length&&(q.normals=new Float32Array(g));M&&0<d.length&&(q.coords=new Float32Array(d));h&&0<h.length&&(q.triangles=new Uint16Array(h));c={};1<B.length&&(c.groups=B);q.info=c;B=null;B=Mesh.load(q,null,b.mesh);B.updateBounding();return B};Mesh.parsers.obj=Mesh.parseOBJ.bind(Mesh);Mesh.encoders.obj=function(a,b){var c=a.getBuffer("vertices");if(!c)return null;for(var d=
"# Generated with liteGL.js by Javi Agenjo\n\n",c=c.data,g=0;g<c.length;g+=3)d+="v "+c[g].toFixed(4)+" "+c[g+1].toFixed(4)+" "+c[g+2].toFixed(4)+"\n";if(g=a.getBuffer("normals"))for(var d=d+"\n",h=g.data,g=0;g<h.length;g+=3)d+="vn "+h[g].toFixed(4)+" "+h[g+1].toFixed(4)+" "+h[g+2].toFixed(4)+"\n";if(g=a.getBuffer("coords"))for(d+="\n",h=g.data,g=0;g<h.length;g+=2)d+="vt "+h[g].toFixed(4)+" "+h[g+1].toFixed(4)+"  0.0000\n";d+="\ng mesh\n";if(g=a.getIndexBuffer("triangles"))for(c=g.data,g=0;g<c.length;g+=
3)d+="f "+(c[g]+1)+"/"+(c[g]+1)+"/"+(c[g]+1)+" "+(c[g+1]+1)+"/"+(c[g+1]+1)+"/"+(c[g+1]+1)+" "+(c[g+2]+1)+"/"+(c[g+2]+1)+"/"+(c[g+2]+1)+"\n";else for(g=0;g<c.length/3;g+=3)d+="f "+(g+1)+"/"+(g+1)+"/"+(g+1)+" "+(g+2)+"/"+(g+2)+"/"+(g+2)+" "+(g+3)+"/"+(g+3)+"/"+(g+3)+"\n";return d}})("undefined"!=typeof window?window:"undefined"!=typeof self?self:global);
'use strict';(function(x){function f(){this._ctor()}function r(){this._ctor()}function p(){this._ctor()}function t(){this._ctor();this.points=[];this.max_points=1E3;this.draw_range=[0,3*this.max_points];this.shader="pointcloud";this.textures={color:"white"};this.blend_mode=e.BLEND_ALPHA;this.flags.depth_write=!1;this.render_priority=e.PRIORITY_ALPHA;this.num_textures=1;this.points_size=100;this._uniforms={u_pointSize:this.points_size,u_texture_info:vec2.fromValues(1,1)};this.primitive=gl.POINTS;this._vertices=
new Float32Array(3*this.max_points);this._extra=new Float32Array(3*this.max_points);this._meshes={};this._last_point_id=this._accumulated_time=0}function s(){this._ctor();this.particles=[];this.max_particles=1E3;this.draw_range=[0,3*this.max_particles];this.shader="particles";this.textures={color:"white"};this.blend_mode=e.BLEND_ALPHA;this.flags.depth_write=!1;this.render_priority=e.PRIORITY_ALPHA;this.num_textures=1;this.particles_size=100;this.particles_life=this.particles_per_second=5;this.particles_damping=
0.5;this.particles_acceleration=vec3.create();this.velocity_variation=this.particles_end_scale=this.particles_start_scale=1;this.emissor_direction=vec3.fromValues(0,1,0);this._uniforms={u_pointSize:this.particle_size,u_scaleStartEnd:vec2.fromValues(1,1),u_texture_info:vec2.fromValues(1,1)};this.primitive=gl.POINTS;this._vertices=new Float32Array(3*this.max_particles);this._extra=new Float32Array(3*this.max_particles);this._meshes={};this._last_particle_id=this._accumulated_time=0}function y(){this._root=
new e.SceneNode;this._root.flags.no_transform=!0;this._root._scene=this;this._nodes_by_id={};this._to_destroy=[];this.frame=this.time=0}function k(a,b){b=b||{};var c=this.gl=this.context=a;if(!c||!c.enable)throw"litegl GL context not found.";a!=x.gl&&c.makeCurrent();this.point_size=5;this.sort_by_priority=!0;this.sort_by_distance=!1;this.assets_folder="";this._view_matrix=mat4.create();this._projection_matrix=mat4.create();this._viewprojection_matrix=mat4.create();this._mvp_matrix=mat4.create();this._model_matrix=
mat4.create();this._nodes=[];this._uniforms={u_view:this._view_matrix,u_viewprojection:this._viewprojection_matrix,u_model:this._model_matrix,u_mvp:this._mvp_matrix};x.gl=this.gl;this.canvas=c.canvas;this.assets_folder=b.assets_folder||"";this.autoload_assets=void 0!==b.autoload_assets?b.autoload_assets:!0;this.default_texture_settings={wrap:c.REPEAT,minFilter:c.LINEAR_MIPMAP_LINEAR,magFilter:c.LINEAR};this.meshes.plane=GL.Mesh.plane({size:1});this.meshes.planeXZ=GL.Mesh.plane({size:1,xz:!0});this.meshes.cube=
GL.Mesh.cube({size:1,wireframe:!0});this.meshes.sphere=GL.Mesh.sphere({size:1,subdivisions:32,wireframe:!0});this.meshes.grid=GL.Mesh.grid({size:10});this.textures.notfound=this.default_texture=new GL.Texture(1,1,{filter:c.NEAREST,pixel_data:new Uint8Array([0,0,0,255])});this.textures.white=this.default_texture=new GL.Texture(1,1,{filter:c.NEAREST,pixel_data:new Uint8Array([255,255,255,255])});this.num_assets_loading=0;this.assets_loading={};this.assets_not_found={};this.draw_calls=this.frame=0;this.createShaders();
b.shaders_file&&this.loadShaders(b.shaders_file)}function g(a){this.type=e.Camera.PERSPECTIVE;this._position=vec3.fromValues(0,100,100);this._target=vec3.fromValues(0,0,0);this._up=vec3.fromValues(0,1,0);this.near=0.1;this.far=1E4;this.aspect=1;this.fov=45;this.frustum_size=50;this.flip_y=!1;this._view_matrix=mat4.create();this._projection_matrix=mat4.create();this._viewprojection_matrix=mat4.create();this._model_matrix=mat4.create();this._autoupdate_matrices=!0;this._must_update_matrix=!1;this._top=
vec3.create();this._right=vec3.create();this._front=vec3.create();a&&(a.position&&this._position.set(a.position),a.target&&this._target.set(a.target),a.up&&this._up.set(a.up),a.near&&(this.near=a.near),a.far&&(this.far=a.far),a.fov&&(this.fov=a.fov),a.aspect&&(this.aspect=a.aspect));this.updateMatrices()}function v(a,b){return vec3.dot(a,b)+a[3]}function w(a,b,c){var d=a[3],h=Math.abs(c[0]*a[0]),e=Math.abs(c[1]*a[1]);c=Math.abs(c[2]*a[2]);h=h+e+c;a=vec3.dot(a,b)+d;return a<=-h?m:a<=h?A:B}var e=x.RD=
{version:0.5};e.ZERO=vec3.fromValues(0,0,0);e.ONE=vec3.fromValues(1,1,1);e.RIGHT=vec3.fromValues(1,0,0);e.LEFT=vec3.fromValues(-1,0,0);e.UP=vec3.fromValues(0,1,0);e.DOWN=vec3.fromValues(0,-1,0);e.FRONT=vec3.fromValues(0,0,-1);e.BACK=vec3.fromValues(0,0,1);e.FRONT2D=vec2.fromValues(0,1);e.WHITE=vec3.fromValues(1,1,1);e.BLACK=vec3.fromValues(0,0,0);e.IDENTITY=mat4.create();e.PRIORITY_BACKGROUND=30;e.PRIORITY_OPAQUE=20;e.PRIORITY_ALPHA=10;e.PRIORITY_HUD=0;e.BLEND_NONE=0;e.BLEND_ALPHA=1;e.BLEND_ADD=2;
e.setup=function(a){a=a||{};if(e.configuration)throw"already called setup";e.configuration=a};var D=0,E=mat4.create();mat3.create();var z=mat4.create(),l=vec2.create(),n=vec3.create(),C=vec3.create();vec4.create();var u=quat.create();e.SceneNode=f;f.prototype._ctor=function(){this._uid=D++;this._id=null;this._position=vec3.create();this._rotation=quat.create();this._scale=vec3.fromValues(1,1,1);this._local_matrix=mat4.create();this._global_matrix=mat4.create();this._must_update_matrix=!1;if(Object.observe){var a=
function(a){this._must_update_matrix=!0}.bind(this);Object.observe(this._position,a);Object.observe(this._rotation,a);Object.observe(this._scale,a)}this.render_priority=e.PRIORITY_OPAQUE;this.blend_mode=e.BLEND_NONE;this.layers=255;this._color=vec4.fromValues(1,1,1,1);this._uniforms={u_color:this._color,u_color_texture:0};this.mesh=this.shader=null;this.textures={};this.flags={};this.children=[]};f.prototype.clone=function(){var a=new this.constructor,b;for(b in this)if("_"!=b[0]&&!this.__lookupGetter__(b)&&
"children"!=b){var c=this[b];void 0!==c&&(null===c?a[b]=null:c.constructor===Object?a[b]=GL.cloneObject(c):c.constructor===Array?a[b]=c.concat():a[b]!==c&&(a[b]=c))}return a};Object.defineProperty(f.prototype,"id",{get:function(){return this._id},set:function(a){this._scene?console.error("Cannot change id of a node already in a scene."):this._id=a},enumerable:!0});Object.defineProperty(f.prototype,"uniforms",{get:function(){return this._uniforms},set:function(a){GL.cloneObject(a,this._uniforms);this._uniforms.u_color=
this._color},enumerable:!0});Object.defineProperty(f.prototype,"position",{get:function(){return this._position},set:function(a){this._position.set(a);this._must_update_matrix=!0},enumerable:!0});Object.defineProperty(f.prototype,"rotation",{get:function(){return this._rotation},set:function(a){this._rotation.set(a);this._must_update_matrix=!0},enumerable:!0});Object.defineProperty(f.prototype,"scaling",{get:function(){return this._scale},set:function(a){a.constructor===Number?this._scale[0]=this._scale[1]=
this._scale[2]=a:this._scale.set(a);this._must_update_matrix=!0},enumerable:!0});Object.defineProperty(f.prototype,"pivot",{get:function(){return this._pivot},set:function(a){this._must_update_matrix=!0;a?(this._pivot||(this._pivot=vec3.create()),this._pivot.set(a),this.flags.pivot=!0):(this._pivot=null,this.flags.pivot=!1)},enumerable:!0});Object.defineProperty(f.prototype,"color",{get:function(){return this._color},set:function(a){this._color.set(a)},enumerable:!0});Object.defineProperty(f.prototype,
"opacity",{get:function(){return this._color[3]},set:function(a){this._color[3]=a},enumerable:!0});Object.defineProperty(f.prototype,"scene",{get:function(){return this._scene},set:function(a){throw"cannot set scene, you must use addChild in its parent node";},enumerable:!0});Object.defineProperty(f.prototype,"parentNode",{get:function(){return this._parent},set:function(a){throw"Cannot set parentNode of SceneNode";},enumerable:!1});f.prototype.addChild=function(a){function b(a,d){a._scene=d;a.id&&
d&&(d._nodes_by_id[a.id]=a);for(var h=0,e=a.children.length;h<e;h++)b(a.children[h],d)}if(a._parent)throw"addChild: Cannot add a child with a parent, remove from parent first";a._parent=this;this.children.push(a);b(a,this._scene)};f.prototype.removeChild=function(a){function b(a){a.id&&a._scene&&a._scene._nodes_by_id[a.id]&&delete a._scene._nodes_by_id[a.id];a._scene=null;for(var c=0,e=a.children.length;c<e;c++)b(a.children[c])}if(a._parent!=this)throw"removeChild: Not its children";var c=this.children.indexOf(a);
if(-1==c)throw"removeChild: impossible, should be children";this.children.splice(c,1);a._parent=null;b(a)};f.prototype.clear=function(){for(;this.children.length;)this.removeChild(this.children[this.children.length-1])};f.prototype.setChildIndex=function(a,b){var c=this.children.indexOf(a);-1!=c&&(this.children.splice(c,1),this.children.splice(b,0,a))};f.prototype.getAllChildren=function(a){a=a||[];for(var b=0,c=this.children.length;b<c;b++){var d=this.children[b];a.push(d);d.getAllChildren(a)}return a};
f.prototype.getVisibleChildren=function(a,b){a=a||[];void 0===b&&(b=255);if(!1===this.flags.visible)return a;for(var c=0,d=this.children.length;c<d;c++){var h=this.children[c];h.layers&b&&a.push(h);h.getVisibleChildren(a,b)}return a};f.prototype.serialize=function(){for(var a={position:[this._position[0],this._position[1],this._position[2]],rotation:[this._rotation[0],this._rotation[1],this._rotation[2],this._rotation[3]],scale:[this._scale[0],this._scale[1],this._scale[2]],children:[]},b=0,c=this.children.length;b<
c;b++)a.children.push(this.children[b].serialize());return a};f.prototype.configure=function(a){a.position&&vec3.copy(this._position,a.position);a.rotation&&4==a.rotation.length&&quat.copy(this._rotation,a.rotation);a.scaling&&vec3.copy(this._scale,a.scaling);this.updateGlobalMatrix()};f.prototype.setMesh=function(a){a?"string"==typeof a?this.mesh=a:this._mesh=a:this.mesh=null};f.prototype.setTexture=function(a,b){b?"string"==typeof b&&(this.textures[a]=b):this.textures[a]=null};Object.defineProperty(f.prototype,
"texture",{get:function(){return this.textures.color},set:function(a){this.textures.color=a},enumerable:!0});f.prototype.resetTransform=function(){this._position.set(e.ZERO);quat.identity(this._rotation);this._scale.set(e.ONE);this._must_update_matrix=!0};f.prototype.translate=function(a){vec3.add(this._position,this._position,a);this._must_update_matrix=!0};f.prototype.rotate=function(a,b,c){quat.setAxisAngle(u,b,a);c?quat.multiply(this._rotation,u,this._rotation):quat.multiply(this._rotation,this._rotation,
u);this._must_update_matrix=!0};f.prototype.scale=function(a){a.constructor===Number?(n[0]=n[1]=n[2]=a,vec3.mul(this._scale,this._scale,n)):vec3.mul(this._scale,this._scale,a);this._must_update_matrix=!0};f.prototype.setPivot=function(a){this.pivot=a};f.prototype.orbit=function(a,b,c){quat.setAxisAngle(u,b,a);this._must_update_matrix=!0};f.prototype.getLocalMatrix=function(){this._must_update_matrix&&this.updateLocalMatrix();return this._local_matrix};f.prototype.getGlobalMatrix=function(){this.updateGlobalMatrix();
return this._global_matrix};f.prototype.getGlobalRotation=function(a){a=a||vec3.create();quat.identity(a);for(var b=this,c=this._scene?this._scene._root:null;b!=c;)quat.multiply(a,b._rotation,a),b=b._parent;return a};f.prototype.updateLocalMatrix=function(){var a=this._local_matrix;this._must_update_matrix=!1;mat4.identity(a);this.flags.no_transform||(this.flags.pivot&&this._pivot&&(a[12]=this._pivot[0],a[13]=this._pivot[1],a[14]=this._pivot[2]),mat4.translate(a,a,this._position),mat4.fromQuat(z,
this._rotation),mat4.multiply(a,a,z),mat4.scale(a,a,this._scale),this.flags.pivot&&this._pivot&&mat4.translate(a,a,[-this._pivot[0],-this._pivot[1],-this._pivot[2]]))};f.prototype.updateGlobalMatrix=function(a,b){var c=null;this._must_update_matrix&&!this.flags.no_transform&&this.updateLocalMatrix();this._parent&&this._scene&&this._parent!=this._scene._root?(c=a?this._parent._global_matrix:this._parent.getGlobalMatrix(),this.flags.no_transform?this._global_matrix.set(c):mat4.multiply(this._global_matrix,
c,this._local_matrix)):this._global_matrix.set(this._local_matrix);if(b)for(c=0;c<this.children.length;c++)this.children[c].updateGlobalMatrix(!0,b)};f.prototype.updateMatrices=function(a){this.updateLocalMatrix();this.updateGlobalMatrix(a)};f.prototype.fromMatrix=function(a,b){if(b&&this._parent){mat4.copy(this._global_matrix,a);var c=this._parent.getGlobalMatrix();mat4.invert(c,c);a=mat4.multiply(this._local_matrix,c,a)}c=mat4.clone(a);mat4.multiplyVec3(this._position,c,[0,0,0]);var d=vec3.create();
this._scale[0]=vec3.length(mat4.rotateVec3(d,c,e.RIGHT));this._scale[1]=vec3.length(mat4.rotateVec3(d,c,e.UP));this._scale[2]=vec3.length(mat4.rotateVec3(d,c,e.BACK));mat4.scale(mat4.create(),c,[1/this._scale[0],1/this._scale[1],1/this._scale[2]]);vec3.normalize(c.subarray(0,3),c.subarray(0,3));vec3.normalize(c.subarray(4,7),c.subarray(4,7));vec3.normalize(c.subarray(8,11),c.subarray(8,11));c=mat3.fromMat4(mat3.create(),c);mat3.transpose(c,c);quat.fromMat3(this._rotation,c);quat.normalize(this._rotation,
this._rotation);a!=this._local_matrix&&mat4.copy(this._local_matrix,a);this._must_update_matrix=!1};f.prototype.getLocalPoint=function(a,b){b=b||vec3.create();this._must_update_matrix&&this.updateLocalMatrix();return vec3.transformMat4(b,a,this._local_matrix)};f.prototype.getLocalVector=function(a,b){b=b||vec3.create();return vec3.transformQuat(b,a,this._rotation)};f.prototype.getGlobalPosition=function(a,b){a=a||vec3.create();if(b)return vec3.transformMat4(a,e.ZERO,this._global_matrix);if(this._parent==
this._scene._root)return a.set(this._position),a;var c=this.getGlobalMatrix();return vec3.transformMat4(a,e.ZERO,c)};f.prototype.getGlobalPoint=function(a,b){b=b||vec3.create();var c=this.getGlobalMatrix();return vec3.transformMat4(b,a,c)};f.prototype.localToGlobal=f.prototype.getGlobalPoint;f.prototype.getGlobalVector=function(a,b){b=b||vec3.create();var c=this.getGlobalRotation(u);return vec3.transformQuat(b,a,c)};f.prototype.getDistanceTo=function(a){var b=this.getGlobalMatrix();return vec3.distance(a,
b.subarray(12,15))};f.prototype.findNode=function(a){for(var b=0,c=this.children.length;b<c;b++){var d=this.children[b];if(d.id==a||(d=d.findNode(a)))return d}return null};f.prototype.propagate=function(a,b){for(var c=0,d=this.children.length;c<d;c++){var h=this.children[c];h&&(h[a]&&h[a].apply(h,b),h.children&&h.children.length&&h.propagate(a,b))}};f.prototype.loadTextConfig=function(a,b){GL.request(a,null,function(a){a=e.parseTextConfig(a);b&&b(a)},alert)};f.prototype.destroy=function(){this.scene?
this.scene._to_destroy.push(this):this._parent&&this._parent.removeChild(this)};r.prototype._ctor=function(){f.prototype._ctor.call(this);this.mesh="plane";this.size=vec2.fromValues(10,10);this.blend_mode=e.BLEND_ALPHA;this.flags.two_sided=!0;this.flags.depth_test=!1;this.flags.flipX=!1;this.flags.flipY=!1;this.shader="texture_transform";this._angle=0;this.frame=null;this.frames={};this.texture_matrix=mat3.create();this._uniforms.u_texture_matrix=this.texture_matrix};Object.defineProperty(r.prototype,
"angle",{get:function(){return this._angle},set:function(a){this._angle=a;quat.setAxisAngle(this._rotation,e.FRONT,this._angle*DEG2RAD);this._must_update_matrix=!0},enumerable:!0});r.prototype.setSize=function(a,b){this.size[0]=a;this.size[1]=b};r.createFrames=function(a,b,c){c=c||{};var d=0,h=0;a=1/a;for(var e in b)if(c[b[e]]={pos:[d,h],size:[a,a],normalized:!0},d+=a,1<=d&&(d=0,h+=a),1<=h)break;return c};r.prototype.createFrames=function(a,b){r.createFrames(a,b,this.frames)};r.prototype.addFrame=
function(a,b,c,d,h,e){this.frames[a]={pos:vec2.fromValues(b,c),size:vec2.fromValues(d,h),normalized:!!e}};r.prototype.updateTextureMatrix=function(a){mat3.identity(this.texture_matrix);if(!this.texture)return!1;a=a.textures[this.texture];if(!a)return!1;var b=this.texture_matrix,c=this.frames[this.frame];if(null!==this.frame&&!c)return!1;if(!c)return this.flags.flipX&&(l[0]=this.flags.flipX?1:0,l[1]=0,mat3.translate(b,b,l),l[0]=this.flags.flipX?-1:1,l[1]=1,mat3.scale(b,b,l)),!0;if(c.normalized)l[0]=
this.flags.flipX?c.pos[0]+c.size[0]:c.pos[0],l[1]=1-c.pos[1]-c.size[1],mat3.translate(b,b,l),l[0]=c.size[0]*(this.flags.flipX?-1:1),l[1]=c.size[1];else{var d=a.height;l[0]=(this.flags.flipX?c.pos[0]+c.size[0]:c.pos[0])/a.width;l[1]=(d-c.pos[1]-c.size[1])/d;mat3.translate(b,b,l);l[0]=c.size[0]*(this.flags.flipX?-1:1)/a.width;l[1]=c.size[1]/a.height}mat3.scale(b,b,l);return!0};r.prototype.render=function(a,b){this.texture&&this.updateTextureMatrix(a)&&(this.billboard_mode?e.Billboard.orientNode(this,
b,a):a.setModelMatrix(this._global_matrix),a.renderNode(this,a,b))};extendClass(r,f);x.Sprite=e.Sprite=r;extendClass(p,f);e.Billboard=p;p.SPHERIC=1;p.PARALLEL_SPHERIC=2;p.CYLINDRIC=3;p.PARALLEL_CYLINDRIC=4;p.prototype._ctor=function(){this.billboard_mode=p.SPHERIC;this.auto_orient=!0;f.prototype._ctor.call(this)};p.orientNode=function(a,b,c){if(a.billboard_mode==p.CYLINDRIC||a.billboard_mode==p.PARALLEL_CYLINDRIC){var d=null;a.billboard_mode==p.CYLINDRIC?(d=a.getGlobalPosition(C),vec3.sub(n,b._position,
d),l[0]=n[0],l[1]=n[2]):(l[0]=b._front[0],l[1]=b._front[2]);b=vec2.computeSignedAngle(l,e.FRONT2D);isNaN(b)||(mat4.rotateY(z,E,-b),a._global_matrix.set(z),mat4.setTranslation(a._global_matrix,a._position),mat4.scale(a._global_matrix,a._global_matrix,a._scale))}else a.billboard_mode==p.PARALLEL_SPHERIC?(a._global_matrix.set(b._model_matrix),mat4.setTranslation(a._global_matrix,a._position)):(mat4.lookAt(a._global_matrix,a._position,b.position,e.UP),mat4.invert(a._global_matrix,a._global_matrix)),mat4.scale(a._global_matrix,
a._global_matrix,a._scale);c.setModelMatrix(a._global_matrix)};p.prototype.render=function(a,b){!1!==this.flags.visible&&(this.auto_orient&&p.orientNode(this,b,a),a.renderNode(this,a,b))};extendClass(t,f);e.PointCloud=t;t.prototype.render=function(a,b){if(0!=this.points.length){this.updateVertices();var c=this._meshes[a.gl.context_id];c||(c=new GL.Mesh(void 0,void 0,a.gl),this._vertices_buffer=c.createVertexBuffer("vertices",null,3,this._vertices,gl.DYNAMIC_DRAW),this._extra_buffer=c.createVertexBuffer("extra3",
null,3,this._extra,gl.DYNAMIC_DRAW));this._mesh=c;this._vertices_buffer.uploadRange(0,12*this.points.length);this._extra_buffer.uploadRange(0,12*this.points.length);c=gl.shaders[this.shader];c||(c=gl.shaders.pointcloud)||(gl.shaders.pointcloud=new GL.Shader(t._vertex_shader,t._pixel_shader));this.draw_range[1]=this.points.length;c=gl.getViewport();this._uniforms.u_pointSize=this.points_size/(gl.canvas.width/c[2]);this._uniforms.u_color=this.color;this._uniforms.u_texture_info[0]=1/this.num_textures;
this._uniforms.u_texture_info[1]=this.num_textures*this.num_textures;this.ignore_transform&&(mat4.identity(a._model_matrix),a._mvp_matrix.set(a._viewprojection_matrix));a.renderNode(this,a,b)}};t.prototype.updateVertices=function(a){if(a=this.points.length)for(var b=this._vertices,c=this._extra,d=0,h=this.num_textures*this.num_textures,e=0;e<a;e++){var q=this.points[e];b.set(q.pos,d);c[d]=1;c[d+1]=1;1<h&&(c[d+2]=q.tex);d+=3}};t._vertex_shader="\t\t\tprecision highp float;\t\t\tattribute vec3 a_vertex;\t\t\tattribute vec3 a_extra3;\t\t\tvarying vec2 v_coord;\t\t\tvarying vec4 v_color;\t\t\tvarying vec3 v_position;\t\t\tuniform vec3 u_camera_position;\t\t\tuniform mat4 u_mvp;\t\t\tuniform mat4 u_model;\t\t\tuniform vec4 u_color;\t\t\tuniform float u_pointSize;\t\t\tuniform vec2 u_texture_info;\t\t\tvoid main() {\n\t\t\t\tv_color = u_color;\n\t\t\t\tv_color.a *= a_extra3.y;\n\t\t\t\tv_coord.x = (a_extra3.z * u_texture_info.y) * u_texture_info.x;\n\t\t\t\tv_coord.y = abs(floor(v_coord.x) * u_texture_info.x);\n\t\t\t\tv_coord.x = fract(v_coord.x);\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\t\tv_position = (u_model * vec4(a_vertex,1.0)).xyz;\n\t\t\t\tfloat dist = distance( u_camera_position, v_position );\n\t\t\t\tgl_PointSize = 10.0 * u_pointSize / dist;\n\t\t\t}\t\t\t";
t._pixel_shader="\t\t\tprecision highp float;\t\t\tvarying vec4 v_color;\t\t\tvarying vec2 v_coord;\t\t\tvarying vec3 v_position;\t\t\tuniform sampler2D u_color_texture;\t\t\tuniform vec2 u_texture_info;\t\t\tvoid main() {\t\t\t  vec2 uv = vec2(v_coord.x + gl_PointCoord.x * u_texture_info.x, v_coord.y + (1.0 - gl_PointCoord.y) * u_texture_info.x );\n\t\t\t  vec4 color = texture2D( u_color_texture, uv );\n\t\t\t  color.xyz *= v_color.xyz;\n\t\t\t  #ifdef USE_PROCESS_COLOR\n\t\t\t\tUSE_PROCESS_COLOR\n\t\t\t  #endif\n\t\t\t  gl_FragColor = vec4( color.xyz, color.a * v_color.a );\n\t\t\t}\t\t";
extendClass(s,f);e.ParticlesEmissor=s;s.prototype.update=function(a){var b=this.particles.length,c=this.particles_damping,d=this.particles_acceleration,h=vec3.length(d);if(b){for(var e=[],q=0;q<b;q++){var f=this.particles[q];vec3.scaleAndAdd(f.pos,f.pos,f.vel,a);h&&vec3.scaleAndAdd(f.vel,f.vel,d,a);c&&vec3.scaleAndAdd(f.vel,f.vel,f.vel,-a*c);f.ttl-=a;0<f.ttl&&e.push(f)}this.particles=e}b=this.getGlobalPosition();c=this.emissor_direction;d=this.particles_life;h=this.num_textures*this.num_textures;
e=this.velocity_variation;if(0<this.particles_per_second)for(a=this.particles_per_second*(a+this._accumulated_time),this._accumulated_time=(a-Math.floor(a))/this.particles_per_second,a=Math.floor(a),q=0;q<a&&!(this.particles.length>=this.max_particles);q++)c=vec3.clone(c),c[0]+=0.5*Math.random()*e,c[2]+=0.5*Math.random()*e,this.particles.push({id:this._last_particle_id++,tex:Math.floor(Math.random()*h)/h,pos:vec3.clone(b),vel:c,ttl:d})};s.prototype.render=function(a,b){if(0!=this.particles.length){this.updateVertices();
var c=this._meshes[a.gl.context_id];c||(c=new GL.Mesh(void 0,void 0,a.gl),this._vertices_buffer=c.createVertexBuffer("vertices",null,3,this._vertices,gl.DYNAMIC_DRAW),this._extra_buffer=c.createVertexBuffer("extra3",null,3,this._extra,gl.DYNAMIC_DRAW));this._mesh=c;this._vertices_buffer.uploadRange(0,12*this.particles.length);this._extra_buffer.uploadRange(0,12*this.particles.length);c=gl.shaders[this.shader];c||(c=gl.shaders.particles)||(gl.shaders.particles=new GL.Shader(s._vertex_shader,s._pixel_shader));
this.draw_range[1]=this.particles.length;c=gl.getViewport();this._uniforms.u_pointSize=this.particles_size/(gl.canvas.width/c[2]);this._uniforms.u_color=this.color;this._uniforms.u_texture_info[0]=1/this.num_textures;this._uniforms.u_texture_info[1]=this.num_textures*this.num_textures;this._uniforms.u_scaleStartEnd[0]=this.particles_start_scale;this._uniforms.u_scaleStartEnd[1]=this.particles_end_scale;mat4.identity(a._model_matrix);a._mvp_matrix.set(a._viewprojection_matrix);a.renderNode(this,a,
b)}};s.prototype.updateVertices=function(a){if(a=this.particles.length)for(var b=this._vertices,c=this._extra,d=0,h=this.particles_life,e=this.num_textures*this.num_textures,f=0;f<a;f++){var g=this.particles[f];b.set(g.pos,d);c[d]=1;c[d+1]=g.ttl/h;1<e&&(c[d+2]=g.tex);d+=3}};s._vertex_shader="\t\t\tprecision highp float;\t\t\tattribute vec3 a_vertex;\t\t\tattribute vec3 a_extra3;\t\t\tvarying vec2 v_coord;\t\t\tvarying vec4 v_color;\t\t\tvarying vec3 v_position;\t\t\tuniform vec3 u_camera_position;\t\t\tuniform mat4 u_mvp;\t\t\tuniform mat4 u_model;\t\t\tuniform vec4 u_color;\t\t\tuniform float u_pointSize;\t\t\tuniform vec2 u_texture_info;\t\t\tuniform vec2 u_scaleStartEnd;\t\t\tvoid main() {\n\t\t\t\tv_color = u_color;\n\t\t\t\tv_color.a *= a_extra3.y;\n\t\t\t\tv_coord.x = (a_extra3.z * u_texture_info.y) * u_texture_info.x;\n\t\t\t\tv_coord.y = floor(v_coord.x) * u_texture_info.x;\n\t\t\t\tv_coord.x = fract(v_coord.x);\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\t\tv_position = (u_model * vec4(a_vertex,1.0)).xyz;\n\t\t\t\tfloat dist = distance( u_camera_position, v_position );\n\t\t\t\tgl_PointSize = mix(u_scaleStartEnd.y, u_scaleStartEnd.x, a_extra3.y) * 10.0 * u_pointSize / dist;\n\t\t\t}\t\t\t";
s._pixel_shader="\t\t\tprecision highp float;\t\t\tvarying vec4 v_color;\t\t\tvarying vec2 v_coord;\t\t\tvarying vec3 v_position;\t\t\tuniform sampler2D u_color_texture;\t\t\tuniform vec2 u_texture_info;\t\t\tvoid main() {\t\t\t  vec4 color = texture2D( u_color_texture, v_coord + vec2(gl_PointCoord.x,1.0 - gl_PointCoord.y) * u_texture_info.x );\n\t\t\t  color.xyz *= v_color.xyz;\n\t\t\t  #ifdef USE_PROCESS_COLOR\n\t\t\t\tUSE_PROCESS_COLOR\n\t\t\t  #endif\n\t\t\t  gl_FragColor = vec4( color.xyz, color.a * v_color.a );\n\t\t\t}\t\t";
e.Scene=y;y.prototype.clear=function(){this._root=new e.SceneNode;this._root._scene=this;this.time=0};y.prototype.getNodeById=function(a){return this._nodes_by_id[a]};y.prototype.update=function(a){this.time+=a;this.root.propagate("update",[a]);if(this._to_destroy.length)for(a=null;a=this._to_destroy.pop();)a._parent&&a._parent.removeChild(a)};Object.defineProperty(y.prototype,"root",{get:function(){return this._root},set:function(a){throw"Cannot set root of scene";},enumerable:!1});e.Renderer=k;
k.prototype.setDataFolder=function(a){a?(this.assets_folder=a,"/"!=this.assets_folder.substr(-1)&&(this.assets_folder+="/")):this.assets_folder=""};k.prototype.clear=function(a){a?this.gl.clearColor(a[0],a[1],a[2],a[3]):this.gl.clearColor(0,0,0,0);this.gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT)};k.prototype.render=function(a,b,c,d){void 0===d&&(d=255);if(!a)throw"Renderer.render: scene not provided";if(this._current_scene)throw this._current_scene=null,"Cannot render an scene while rendering an scene";
this._current_scene=a;b=b||a.camera;if(!b)throw"Renderer.render: camera not provided";x.gl=this.gl;this._state=[];this.enableCamera(b);this._nodes.length=0;c||a.root.getVisibleChildren(this._nodes,d);c=c||this._nodes;if(c.length){this._uniforms.u_time=a.time;this.sort_by_distance&&c.forEach(function(a){a._distance=a.getDistanceTo(b._position)});var h=this;c=c.filter(function(a){return!a.mustRender||!1!=a.mustRender(h,b)});this.sort_by_distance&&c.sort(function(a,b){return b._distance-a._distance});
this.sort_by_priority&&c.sort(function(a,b){return b.render_priority-a.render_priority});a.root.preRender&&a.root.preRender(this,b);for(var e=0;e<c.length;++e){var f=c[e];f.updateGlobalMatrix(!0);f.preRender&&f.preRender(this,b)}for(e=0;e<c.length;++e)f=c[e],!1!==f.flags.visible&&f.layers&d&&(!this.mustRenderNode||!1!==this.mustRenderNode(f,b))&&(this.setModelMatrix(f._global_matrix),f.render?f.render(this,b):this.renderNode(f,b),this.draw_calls+=1);a.root.postRender&&a.root.postRender(this,b);for(e=
0;e<c.length;++e)f=c[e],f.postRender&&f.postRender(this,b)}a.frame++;this.frame++;this._current_scene=null};k.prototype.enableCamera=function(a){this._camera=a;a.updateMatrices();a.extractPlanes();this._view_matrix.set(a._view_matrix);this._projection_matrix.set(a._projection_matrix);this._viewprojection_matrix.set(a._viewprojection_matrix);this._uniforms.u_camera_position=a.position};k.prototype.saveState=function(){this.state.push({camera:this._camera,nodes:this._nodes})};k.prototype.restoreState=
function(){var a=this.state.pop(),b=this.camera=a.camera;this._view_matrix.set(b._view_matrix);this._projection_matrix.set(b._projection_matrix);this._viewprojection_matrix.set(b._viewprojection_matrix);this._uniforms.u_camera_position=b.position;this._nodes=a.nodes};k.prototype.setModelMatrix=function(a){this._model_matrix.set(a);mat4.multiply(this._mvp_matrix,this._viewprojection_matrix,a)};k.prototype.setGlobalUniforms=function(a){for(var b in a)this._uniforms[b]&&this._uniforms[b].set?this._uniforms[b].set(a[b]):
this._uniforms[b]=a[b]};k.prototype.renderNode=function(a,b){var c=null;a._mesh?c=a._mesh:a.mesh&&(c=gl.meshes[a.mesh],!c&&this.autoload_assets&&-1!=a.mesh.indexOf(".")&&this.loadMesh(a.mesh));if(c){var d=0,h=null,f;for(f in a.textures){var g=a.textures[f];g&&(h=gl.textures[g],h||(this.autoload_assets&&-1!=g.indexOf(".")&&this.loadTexture(g,this.default_texture_settings),h=gl.textures.white),a._uniforms["u_"+f+"_texture"]=h.bind(d++))}h=null;f=a.shader;this.on_getShader&&(h=this.on_getShader(a,b));
!h&&a.shader&&(h=gl.shaders[f]);this.shader_overwrite&&(h=gl.shaders[this.shader_overwrite]);h||(h=0<d?this._texture_shader:this._flat_shader);this.ignore_flags?gl.blendFunc(gl.SRC_ALPHA,a.blend_mode===e.BLEND_ADD?gl.ONE:gl.ONE_MINUS_SRC_ALPHA):(gl.frontFace(a.flags.flip_normals?gl.CW:gl.CCW),gl[!1===a.flags.depth_test?"disable":"enable"](gl.DEPTH_TEST),!1===a.flags.depth_write&&gl.depthMask(!1),gl[!0===a.flags.two_sided?"disable":"enable"](gl.CULL_FACE),a.blend_mode!==e.BLEND_NONE&&(gl.enable(gl.BLEND),
gl.blendFunc(gl.SRC_ALPHA,a.blend_mode===e.BLEND_ADD?gl.ONE:gl.ONE_MINUS_SRC_ALPHA)));if(a.onRender)a.onRender(this,b,h);h.uniforms(this._uniforms);h.uniforms(a._uniforms);if(a.onShaderUniforms)a.onShaderUniforms(this,h);a.draw_range?h.drawRange(c,void 0===a.primitive?gl.TRIANGLES:a.primitive,a.draw_range[0],a.draw_range[1],a.indices):h.draw(c,void 0===a.primitive?gl.TRIANGLES:a.primitive,a.indices);this.ignore_flags||(a.flags.flip_normals&&gl.frontFace(gl.CCW),!1===a.flags.depth_test&&gl.enable(gl.DEPTH_TEST),
a.blend_mode!==e.BLEND_NONE&&gl.disable(gl.BLEND),a.flags.two_sided&&gl.disable(gl.CULL_FACE),!1===a.flags.depth_write&&gl.depthMask(!0))}else if(a.onRender)a.onRender(this,b,h)};k.prototype.setPointSize=function(a){this.point_size=a;gl.shaders.point.uniforms({u_pointSize:this.point_size})};k.prototype.loadMesh=function(a,b){if(!a)return console.error("loadMesh: Cannot load null name");if(!this.assets_loading[a]&&!this.assets_not_found[a]){var c=this.meshes[a];if(c)return b&&b(c),c;var d=this,c=a;
-1==c.indexOf("://")&&(c=this.assets_folder+a);c=GL.Mesh.fromURL(c,function(c){c?d.meshes[a]=c:(d.assets_not_found[a]=!0,delete d.meshes[a]);d.num_assets_loading--;delete d.assets_loading[a];b&&b(c,a)});this.assets_loading[a]=c;this.num_assets_loading++;return this.meshes[a]=c}};k.prototype.loadTexture=function(a,b,c){if(!a)return console.error("loadTexture: Cannot load null name");if(!this.assets_loading[a]&&!this.assets_not_found[a]){var d=a;b&&(b.name&&(d=b.name),b.preview&&(d=b.preview));var h=
this.textures[d];if(h&&!h.is_preview)return c&&c(h),h;var e=this,h=a;-1==h.indexOf("://")&&(h=this.assets_folder+a);h=GL.Texture.fromURL(h,b,function(b){b?e.textures[d]=b:e.assets_not_found[a]=!0;c&&c(b,d);e.num_assets_loading--;delete e.assets_loading[a];if(e.on_texture_load)e.on_texture_load(b,d)});b&&b.preview&&(h.is_preview=!0);this.assets_loading[a]=h;this.num_assets_loading++;return this.textures[d]=h}};k.prototype.loadTextureAtlas=function(a,b,c){"string"==typeof a&&(a=JSON.parse(a));var d=
this;-1==b.indexOf("://")&&(b=this.assets_folder+b);GL.Texture.fromURL(b,null,function(b){var e=a.files;d.textures[":atlas"]=b;for(var f in e)if(!d.textures[f]||d.textures[f].is_preview){var g=e[f],k=new GL.Texture(a.size,a.size,{wrap:gl.REPEAT,filter:gl.LINEAR});k.drawTo(function(){b.gl.drawTexture(b,0,0,a.size,a.size,g.x,g.y,g.width||a.size,g.height||a.size)});k.is_preview=!0;d.textures[f]=k}c&&c(e)})};k.prototype.loadShaders=function(a,b){var c=this;-1==a.indexOf("://")&&(a=this.assets_folder+
a);GL.loadFileAtlas(a,function(a){c.compileShadersFromAtlas(a);b&&b(a)})};k.prototype.compileShadersFromAtlas=function(a){var b=a.shaders;if(b){for(var c in a)a[c]=GL.Shader.expandImports(a[c],a);b=b.split("\n");for(c in b){var d=b[c].trim().split(" "),e=d[0].trim();if("//"!=e.substr(0,2)){var f=a[d[1]],g=a[d[2]],k=null;2<d.length&&(k=d.slice(3).join(" "));if(d[1]&&"@"==d[1][0]){var l=d[1].substr(1)+"_VERTEX_SHADER";GL.Shader[l]&&(f=GL.Shader[l])}d[2]&&"@"==d[2][0]&&(l=d[2].substr(1)+"_FRAGMENT_SHADER",
GL.Shader[l]&&(g=GL.Shader[l]));if(k)try{k=JSON.parse(k)}catch(m){console.error("Error in shader macros: ",e,k,m)}try{f&&g?this.shaders[e]=new GL.Shader(f,g,k):console.warn("Shader file not found: ",d[1],d[2])}catch(n){GL.Shader.dumpErrorToConsole(n,f,g)}}}}else console.warn("No 'shaders' found in shaders file atlas, check documentation")};k.prototype.setShadersFromFile=function(a){a=GL.processFileAtlas(a);this.compileShadersFromAtlas(a)};e.sortByDistance=function(a,b){a.forEach(function(a){a._distance=
a.getDistanceTo(b)});a.sort(function(a,b){return b._distance-a._distance})};e.noBlending=function(a){return a.blend_mode===e.BLEND_NONE};e.generateTextureAtlas=function(a,b,c,d,e){b=b||1024;c=c||1024;d=d||64;var f=0,g;for(g in a)f++;gl.disable(gl.DEPTH_TEST);gl.disable(gl.CULL_FACE);gl.disable(gl.BLEND);var f=new GL.Texture(b,c),k={width:b,height:c,size:d,files:{}},l=0,m=0,n={};f.drawTo(function(){for(var f in a)if(":"!=f[0]&&"white"!=f&&"black"!=f&&"notfound"!=f){var g=a[f];if(!g.is_preview&&g.texture_type==
gl.TEXTURE_2D){if(e){var q=g.toBase64().hashCode();if(n[q]){k.files[f]=k.files[n[q]];continue}n[q]=f}k.files[f]={x:l,y:m};g.renderQuad(l,m,d,d);l+=d;if(l==b&&(l=0,m+=d,m==c)){console.warn("Atlas too small, some textures wont be stored.");break}}}});f.info=k;console.log(k);return f};k.prototype.computeResourcesLoaded=function(a){var b=0,c;for(c in a){var d=a[c],e=this.textures[d];e&&!1===e.ready||(d=this.meshes[d])&&!1===d.ready||(e||d)&&b++}return b};Object.defineProperty(k.prototype,"meshes",{get:function(){return this.gl.meshes},
set:function(a){},enumerable:!0});Object.defineProperty(k.prototype,"textures",{get:function(){return this.gl.textures},set:function(a){},enumerable:!0});Object.defineProperty(k.prototype,"shaders",{get:function(){return this.gl.shaders},set:function(a){},enumerable:!0});k.prototype.addMesh=function(a,b){b.gl!=this.gl&&(b=b.cloneShared(this.gl));this.gl.meshes[a]=b};e.Renderer=k;e.Camera=g;g.PERSPECTIVE=1;g.ORTHOGRAPHIC=2;Object.defineProperty(g.prototype,"position",{get:function(){return this._position},
set:function(a){this._position.set(a);this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(g.prototype,"target",{get:function(){return this._target},set:function(a){this._target.set(a);this._must_update_matrix=!0},enumerable:!1});Object.defineProperty(g.prototype,"up",{get:function(){return this._up},set:function(a){this._up.set(a);this._must_update_matrix=!0},enumerable:!1});g.prototype.perspective=function(a,b,c,d){this.type=g.PERSPECTIVE;this.fov=a;this.aspect=b;this.near=c;this.far=
d;this._must_update_matrix=!0};g.prototype.orthographic=function(a,b,c,d){this.aspect=d||1;this.type=g.ORTHOGRAPHIC;this.frustum_size=a;this.near=b;this.far=c};g.prototype.lookAt=function(a,b,c){vec3.copy(this._position,a);vec3.copy(this._target,b);vec3.copy(this._up,c);this._must_update_matrix=!0};g.prototype.updateMatrices=function(a){if(this._autoupdate_matrices||a)this.type==g.ORTHOGRAPHIC?mat4.ortho(this._projection_matrix,-this.frustum_size*this.aspect,this.frustum_size*this.aspect,-this.frustum_size,
this.frustum_size,this.near,this.far):mat4.perspective(this._projection_matrix,this.fov*DEG2RAD,this.aspect,this.near,this.far),this.flip_y&&mat4.scale(this._projection_matrix,this._projection_matrix,[1,-1,1]),mat4.lookAt(this._view_matrix,this._position,this._target,this._up);mat4.multiply(this._viewprojection_matrix,this._projection_matrix,this._view_matrix);mat4.invert(this._model_matrix,this._view_matrix);this._must_update_matrix=!1;mat4.rotateVec3(this._right,this._model_matrix,e.RIGHT);mat4.rotateVec3(this._top,
this._model_matrix,e.UP);mat4.rotateVec3(this._front,this._model_matrix,e.FRONT);this.distance=vec3.distance(this._position,this._target)};g.prototype.getModel=function(a){a=a||mat4.create();mat4.invert(this._model_matrix,this._view_matrix);mat4.copy(a,this._model_matrix);return a};g.prototype.updateVectors=function(a){var b=vec3.subtract(n,this._target,this._position),b=vec3.length(b);mat4.multiplyVec3(this._position,a,e.ZERO);mat4.multiplyVec3(this._target,a,[0,0,-b]);mat4.rotateVec3(this._up,a,
e.UP)};g.prototype.getLocalVector=function(a,b){this._must_update_matrix&&this.updateMatrices();return mat4.rotateVec3(b||vec3.create(),this._model_matrix,a)};g.prototype.getLocalPoint=function(a,b){this._must_update_matrix&&this.updateMatrices();return vec3.transformMat4(b||vec3.create(),a,this._model_matrix)};g.prototype.getFront=function(a){a=a||vec3.create();vec3.subtract(a,this._target,this._position);vec3.normalize(a,a);return a};g.prototype.move=function(a){vec3.add(this._target,this._target,
a);vec3.add(this._position,this._position,a);this._must_update_matrix=!0};g.prototype.moveLocal=function(a){a=mat4.rotateVec3(n,this._model_matrix,a);vec3.add(this._target,this._target,a);vec3.add(this._position,this._position,a);this._must_update_matrix=!0};g.prototype.rotate=function(a,b){var c=quat.setAxisAngle(u,b,a),d=vec3.subtract(n,this._target,this._position);vec3.transformQuat(d,d,c);vec3.add(this._target,this._position,d);this._must_update_matrix=!0};g.prototype.rotateLocal=function(a,b){var c=
mat4.rotateVec3(C,this._model_matrix,b),c=quat.setAxisAngle(u,c,a),d=vec3.subtract(n,this._target,this._position);vec3.transformQuat(d,d,c);vec3.add(this._target,this._position,d);this._must_update_matrix=!0};g.prototype.orbit=function(a,b,c,d){c=c||this._target;d&&(b=mat4.rotateVec3(C,this._model_matrix,b));a=quat.setAxisAngle(u,b,a);b=vec3.subtract(n,this._position,this._target);vec3.transformQuat(b,b,a);vec3.add(this._position,c,b);this._must_update_matrix=!0};g.prototype.orbitDistanceFactor=function(a,
b){b=b||this._target;var c=vec3.subtract(n,this._position,b);vec3.scale(c,c,a);vec3.add(this._position,b,c);this._must_update_matrix=!0};g.prototype.project=function(a,b,c){c=c||vec3.create();b=b||gl.viewport_data;mat4.projectVec3(c,this._viewprojection_matrix,a);c[0]=c[0]*b[2]+b[0];c[1]=c[1]*b[3]+b[1];return c};g.prototype.unproject=function(a,b,c){b=b||gl.viewport_data;return vec3.unproject(c||vec3.create(),a,this._viewprojection_matrix,b)};g.prototype.getRay=function(a,b,c){c=c||gl.viewport_data;
var d=null,d=this.type==e.Camera.ORTHOGRAPHIC?vec3.unproject(vec3.fromValues(),vec3.fromValues(a,b,0),this._viewprojection_matrix,c):vec3.clone(this.position);a=vec3.unproject(vec3.fromValues(),vec3.fromValues(a,b,1),this._viewprojection_matrix,c);vec3.sub(a,a,d);vec3.normalize(a,a);return{origin:d,direction:a}};g.prototype.getRayPlaneCollision=function(a,b,c,d,e){var f=new GL.Raytracer(this._view_matrix,this._projection_matrix),g=this._position;a=f.getRayForPixel(a,b);e=e||vec3.create();return geo.testRayPlane(g,
a,c,d,e)?e:null};g.controller_keys={forward:"UP",back:"DOWN",left:"LEFT",right:"RIGHT"};g.prototype.applyController=function(a,b,c){c=c||10;a&&(gl.keys[g.controller_keys.forward]?this.moveLocal(vec3.scale(n,e.FRONT,a*c)):gl.keys[g.controller_keys.back]&&this.moveLocal(vec3.scale(n,e.BACK,a*c)),gl.keys[g.controller_keys.left]?this.moveLocal(vec3.scale(n,e.LEFT,a*c)):gl.keys[g.controller_keys.right]&&this.moveLocal(vec3.scale(n,e.RIGHT,a*c)));b&&(b.deltax&&this.rotate(-0.005*b.deltax,e.UP),b.deltay&&
this.rotateLocal(-0.005*b.deltay,e.RIGHT))};g.prototype.lerp=function(a,b){vec3.lerp(this._position,a._position,b);vec3.lerp(this._target,a._target,b);vec3.lerp(this._up,a._up,b);this._fov=this._fov*(1-b)+a._fov*b;this._must_update_matrix=!0};g.prototype.extractPlanes=function(){function a(a){var b=c.subarray(a,a+3),b=vec3.length(b);0!==!b&&(b=1/b,c[a]*=b,c[a+1]*=b,c[a+2]*=b,c[a+3]*=b)}var b=this._viewprojection_matrix,c=this._planes_data||new Float32Array(24);c.set([b[3]-b[0],b[7]-b[4],b[11]-b[8],
b[15]-b[12]],0);a(0);c.set([b[3]+b[0],b[7]+b[4],b[11]+b[8],b[15]+b[12]],4);a(4);c.set([b[3]+b[1],b[7]+b[5],b[11]+b[9],b[15]+b[13]],8);a(8);c.set([b[3]-b[1],b[7]-b[5],b[11]-b[9],b[15]-b[13]],12);a(12);c.set([b[3]-b[2],b[7]-b[6],b[11]-b[10],b[15]-b[14]],16);a(16);c.set([b[3]+b[2],b[7]+b[6],b[11]+b[10],b[15]+b[14]],20);a(20);this._planes_data=c;this._frustrum_planes||(this._frustrum_planes=[c.subarray(0,4),c.subarray(4,8),c.subarray(8,12),c.subarray(12,16),c.subarray(16,20),c.subarray(20,24)])};var B=
e.CLIP_INSIDE=0,m=e.CLIP_OUTSIDE=1,A=e.CLIP_OVERLAP=2;g.prototype.testBox=function(a,b){this._frustrum_planes||this.extractPlanes();var c=this._frustrum_planes,d=0,e=0,d=w(c[0],a,b);if(d==m)return m;e+=d;d=w(c[1],a,b);if(d==m)return m;e+=d;d=w(c[2],a,b);if(d==m)return m;e+=d;d=w(c[3],a,b);if(d==m)return m;e+=d;d=w(c[4],a,b);if(d==m)return m;e+=d;d=w(c[5],a,b);return d==m?m:0==e+d?B:A};g.prototype.testSphere=function(a,b){this._frustrum_planes||this.extractPlanes();var c=this._frustrum_planes,d,e=
!1;d=v(c[0],a);if(d<-b)return m;d>=-b&&d<=b&&(e=!0);d=v(c[1],a);if(d<-b)return m;d>=-b&&d<=b&&(e=!0);d=v(c[2],a);if(d<-b)return m;d>=-b&&d<=b&&(e=!0);d=v(c[3],a);if(d<-b)return m;d>=-b&&d<=b&&(e=!0);d=v(c[4],a);if(d<-b)return m;d>=-b&&d<=b&&(e=!0);d=v(c[5],a);if(d<-b)return m;d>=-b&&d<=b&&(e=!0);return e?A:B};e.parseTextConfig=function(a){function b(a,e){for(var f=c.shift();f;)if(0==f.trim().length)f=c.shift();else{for(var g=0;"\t"==f[g]&&g<f.length;)g++;if(g<e)break;var k={children:[]};try{var l=
f.trim();-1!=l.indexOf(":")&&(l="{"+l+"}");var m=new Function("return "+l);k.data=m()}catch(n){console.error(n)}g>=e&&(a&&a.children.push(k),f=b(k,g+1))}return f}var c=a.split("\n");a={data:"",children:[]};b(a,0);return a};k.prototype.createShaders=function(){this._flat_shader=new GL.Shader("\t\t\t\tprecision highp float;\t\t\t\tattribute vec3 a_vertex;\t\t\t\tuniform mat4 u_mvp;\t\t\t\tvoid main() {\t\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\t\t\t\t\tgl_PointSize = 2.0;\t\t\t\t}\t\t\t\t",
"\t\t\t\tprecision highp float;\t\t\t\tuniform vec4 u_color;\t\t\t\tvoid main() {\t\t\t\t  gl_FragColor = u_color;\t\t\t\t}\t\t\t");gl.shaders.flat=this._flat_shader;this._point_shader=new GL.Shader("\t\t\t\tprecision highp float;\t\t\t\tattribute vec3 a_vertex;\t\t\t\tuniform mat4 u_mvp;\t\t\t\tuniform float u_pointSize;\t\t\t\tvoid main() {\t\t\t\t\tgl_PointSize = u_pointSize;\t\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\t\t\t\t}\t\t\t\t","\t\t\t\tprecision highp float;\t\t\t\tuniform vec4 u_color;\t\t\t\tvoid main() {\t\t\t\t  if( distance( gl_PointCoord, vec2(0.5)) > 0.5)\t\t\t\t     discard;\t\t\t\t  gl_FragColor = u_color;\t\t\t\t}\t\t\t");
gl.shaders.point=this._point_shader;this._color_shader=new GL.Shader("\t\tprecision highp float;\t\tattribute vec3 a_vertex;\t\tattribute vec4 a_color;\t\tvarying vec4 v_color;\t\tuniform vec4 u_color;\t\tuniform mat4 u_mvp;\t\tuniform mat4 u_modelt;\t\tvoid main() {\t\t\tv_color = a_color * u_color;\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\t\t\tgl_PointSize = 5.0;\t\t}\t\t","\t\tprecision highp float;\t\tvarying vec4 v_color;\t\tvoid main() {\t\t  gl_FragColor = v_color;\t\t}\t");gl.shaders.color=
this._color_shader;this._texture_shader=new GL.Shader("\t\tprecision highp float;\t\tattribute vec3 a_vertex;\t\tattribute vec2 a_coord;\t\tvarying vec2 v_coord;\t\tuniform mat4 u_mvp;\t\tuniform mat4 u_modelt;\t\tvoid main() {\t\t\tv_coord = a_coord;\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\t\t\tgl_PointSize = 5.0;\t\t}\t\t","\t\tprecision highp float;\t\tvarying vec2 v_coord;\t\tuniform vec4 u_color;\t\tuniform sampler2D u_color_texture;\t\tvoid main() {\t\t\tgl_FragColor = u_color * texture2D(u_color_texture, v_coord);\t\t}\t");
gl.shaders.texture=this._texture_shader;this._texture_transform_shader=new GL.Shader("\t\tprecision highp float;\t\tattribute vec3 a_vertex;\t\tattribute vec2 a_coord;\t\tvarying vec2 v_coord;\t\tuniform mat4 u_mvp;\t\tuniform mat3 u_texture_matrix;\t\tvoid main() {\t\t\tv_coord = (u_texture_matrix * vec3(a_coord,1.0)).xy;\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\t\t\tgl_PointSize = 5.0;\t\t}\t\t","\t\tprecision highp float;\t\tvarying vec2 v_coord;\t\tuniform vec4 u_color;\t\tuniform sampler2D u_color_texture;\t\tvoid main() {\t\t\tgl_FragColor = u_color * texture2D(u_color_texture, v_coord);\t\t}\t");
gl.shaders.texture_transform=this._texture_transform_shader;var a={u_ambient:vec3.create(),u_lightvector:vec3.fromValues(0.577,0.577,0.577),u_lightcolor:e.WHITE};this._phong_shader=new GL.Shader("\t\t\tprecision highp float;\t\t\tattribute vec3 a_vertex;\t\t\tattribute vec3 a_normal;\t\t\tvarying vec3 v_normal;\t\t\tuniform mat4 u_mvp;\t\t\tuniform mat4 u_model;\t\t\tvoid main() {\t\t\t\tv_normal = (u_model * vec4(a_normal,0.0)).xyz;\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\t\t\t}\t\t\t",
"\t\t\tprecision highp float;\t\t\tvarying vec3 v_normal;\t\t\tuniform vec3 u_ambient;\t\t\tuniform vec3 u_lightcolor;\t\t\tuniform vec3 u_lightvector;\t\t\tuniform vec4 u_color;\t\t\tvoid main() {\t\t\t  vec3 N = normalize(v_normal);\t\t\t  gl_FragColor = u_color * (vec4(u_ambient,1.0) + max(0.0, dot(u_lightvector,N)) * vec4(u_lightcolor,1.0));\t\t\t}\t\t");gl.shaders.phong=this._phong_shader;gl.shaders.phong.uniforms(a);this._textured_phong_shader=new GL.Shader("\t\t\tprecision highp float;\t\t\tattribute vec3 a_vertex;\t\t\tattribute vec3 a_normal;\t\t\tattribute vec2 a_coord;\t\t\tvarying vec2 v_coord;\t\t\tvarying vec3 v_normal;\t\t\tuniform mat4 u_mvp;\t\t\tuniform mat4 u_model;\t\t\tvoid main() {\n\t\t\t\tv_coord = a_coord;\n\t\t\t\tv_normal = (u_model * vec4(a_normal,0.0)).xyz;\n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\n\t\t\t}\t\t\t",
"\t\t\tprecision highp float;\t\t\tvarying vec3 v_normal;\t\t\tvarying vec2 v_coord;\t\t\tuniform vec3 u_lightcolor;\t\t\tuniform vec3 u_lightvector;\t\t\tuniform vec4 u_color;\t\t\tuniform sampler2D u_color_texture;\t\t\tvoid main() {\t\t\t  vec3 N = normalize(v_normal);\t\t\t  gl_FragColor = u_color * texture2D(u_color_texture, v_coord) * max(0.0, dot(u_lightvector,N)) * vec4(u_lightcolor,1.0);\t\t\t}\t\t");gl.shaders.textured_phong=this._textured_phong_shader;gl.shaders.textured_phong.uniforms(a)}})("undefined"!=
typeof window?window:"undefined"!=typeof self?self:global);
